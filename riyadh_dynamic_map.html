<!DOCTYPE html>
<html>
<head>
    <title>Riyadh Map - Dynamic Counts</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
        
        .panel {
            position: absolute; top: 10px; left: 10px;
            background: white; padding: 12px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); z-index: 1000;
            max-width: 380px; max-height: 95vh; overflow-y: auto; font-size: 12px;
        }
        .panel h2 { color: #1a73e8; margin-bottom: 8px; font-size: 15px; }
        
        .section { margin: 8px 0; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .section-header {
            background: #f5f5f5; padding: 8px 10px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600; font-size: 12px;
        }
        .section-header:hover { background: #e8e8e8; }
        .section-content { padding: 8px; display: none; }
        .section-content.open { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin: 8px 0; }
        .stat-box { padding: 8px; border-radius: 6px; text-align: center; color: white; }
        .stat-box .num { font-size: 1.2em; font-weight: bold; }
        .stat-box .lbl { font-size: 9px; opacity: 0.9; }
        .stat-box.apt { background: #2196F3; }
        .stat-box.villa { background: #4CAF50; }
        .stat-box.other { background: #FF9800; }
        .stat-box.poi { background: #9C27B0; }
        
        .dynamic-stats { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 10px; margin: 8px 0; }
        .dynamic-stats h3 { color: #2e7d32; font-size: 13px; margin-bottom: 8px; }
        .dynamic-stats .row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .dynamic-stats .row.total { font-weight: bold; border-top: 1px solid #a5d6a7; padding-top: 5px; margin-top: 5px; }
        
        .district-stats { background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 10px; margin: 8px 0; display: none; }
        .district-stats.active { display: block; }
        .district-stats h3 { color: #e65100; font-size: 13px; margin-bottom: 8px; }
        .district-stats .row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .district-stats .row.total { font-weight: bold; border-top: 1px solid #ffcc80; padding-top: 5px; margin-top: 5px; }
        
        .layer-control { padding: 8px; margin: 5px 0; background: #f9f9f9; border-radius: 6px; }
        .layer-control .header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .layer-control .dot { width: 14px; height: 14px; border-radius: 50%; }
        .layer-control .name { font-weight: 600; flex: 1; }
        .layer-control .count { font-size: 10px; color: #666; }
        .layer-control input[type="range"] { width: 100%; margin: 2px 0; }
        
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 450; }
        
        .btn { padding: 8px 12px; margin: 3px 0; cursor: pointer; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; width: 100%; }
        .btn-primary { background: #1a73e8; color: white; border: none; }
        .btn-success { background: #28a745; color: white; border: none; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 18px; flex-direction: column; gap: 20px;
        }
        .loading-overlay.hidden { display: none; }
        .progress-bar { width: 300px; height: 20px; background: #333; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4CAF50; transition: width 0.3s; }
        
        .district-list { max-height: 120px; overflow-y: auto; }
        .district-item { padding: 4px 8px; margin: 2px 0; background: #f5f5f5; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .district-item:hover { background: #e3f2fd; }
        .district-item.selected { background: #1a73e8; color: white; }
        
        .search-box { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; margin-bottom: 5px; }
        
        .file-input { margin: 5px 0; }
        .file-input label { display: block; font-weight: 600; font-size: 10px; margin-bottom: 2px; }
        .file-input input[type="file"] { font-size: 9px; width: 100%; }
        .file-status { font-size: 9px; color: #666; }
        .file-status.loaded { color: #28a745; font-weight: bold; }
        
        .poi-cats { max-height: 120px; overflow-y: auto; margin-top: 5px; }
        .poi-cat { display: flex; align-items: center; gap: 5px; padding: 3px 5px; font-size: 10px; cursor: pointer; }
        .poi-cat:hover { background: #f0f0f0; }
        .poi-cat .cnt { margin-left: auto; color: #999; }
        
        .info-popup {
            position: absolute; background: white; padding: 12px 15px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 2000; min-width: 280px; max-width: 350px;
            font-size: 12px; display: none; border-left: 4px solid #1a73e8;
        }
        .info-popup.show { display: block; }
        .info-popup h3 { margin: 0 0 8px 0; color: #1a73e8; font-size: 14px; }
        .info-popup .close { position: absolute; top: 5px; right: 8px; cursor: pointer; color: #999; font-size: 18px; }
        .info-popup .close:hover { color: #333; }
        .info-popup table { width: 100%; border-collapse: collapse; }
        .info-popup td { padding: 4px 5px; border-bottom: 1px solid #eee; font-size: 11px; }
        .info-popup td:first-child { font-weight: 600; color: #555; width: 35%; }
        .info-popup .type-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; color: white; font-size: 10px; }
        .info-popup .type-apt { background: #2196F3; }
        .info-popup .type-villa { background: #4CAF50; }
        .info-popup .type-other { background: #FF9800; }
        .info-popup .type-poi { background: #9C27B0; }
        
        .click-toggle { background: #fff3e0; padding: 8px; border-radius: 6px; margin: 8px 0; }
        .click-toggle label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div id="loadingTitle">Processing...</div>
        <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
        <div id="loadingStatus">Please wait...</div>
    </div>
    
    <div id="map"></div>
    <canvas id="canvas"></canvas>
    
    <!-- Info Popup for clicked items -->
    <div id="infoPopup" class="info-popup">
        <span class="close" onclick="closeInfoPopup()">&times;</span>
        <h3 id="popupTitle">üìç Details</h3>
        <div id="popupContent"></div>
    </div>
    
    <div class="panel">
        <h2>Riyadh Map - Dynamic Counts</h2>
        
        <!-- Total Stats -->
        <div class="stats-grid">
            <div class="stat-box" style="background:#9c27b0;"><div class="num" id="totalBldg">0</div><div class="lbl">üèóÔ∏è Buildings</div></div>
            <div class="stat-box apt"><div class="num" id="totalApt">0</div><div class="lbl">üè¢ Apartments</div></div>
            <div class="stat-box villa"><div class="num" id="totalVilla">0</div><div class="lbl">üè† Villas</div></div>
            <div class="stat-box other"><div class="num" id="totalOther">0</div><div class="lbl">üì¶ Other</div></div>
        </div>
        <div style="text-align:center; font-size:11px; color:#666; margin-bottom:8px;">
            Total Parcels: <b id="totalParcels">0</b> | POIs: <b id="totalPoi">0</b>
        </div>
        
        <!-- Selected District Stats -->
        <div class="district-stats" id="districtStats">
            <h3 id="districtStatsTitle">üìç DISTRICT: None</h3>
            <div class="row" style="color:#9c27b0;"><span>üèóÔ∏è Buildings:</span><span id="distBldg">0</span></div>
            <div class="row" style="color:#2196F3;"><span>üè¢ Apartments:</span><span id="distApt">0</span></div>
            <div class="row" style="color:#4CAF50;"><span>üè† Villas:</span><span id="distVilla">0</span></div>
            <div class="row" style="color:#FF9800;"><span>üì¶ Other:</span><span id="distOther">0</span></div>
            <div class="row total"><span>Total Parcels:</span><span id="distTotal">0</span></div>
            <div class="row"><span>üìç POIs:</span><span id="distPoi">0</span></div>
            <div class="row total" style="color:#4CAF50;"><span>Villa %:</span><span id="distVillaPct">0%</span></div>
            <div class="row total" style="color:#2196F3;"><span>Apt %:</span><span id="distAptPct">0%</span></div>
        </div>
        
        <!-- Dynamic Counts (In View) -->
        <div class="dynamic-stats">
            <h3>üìç IN CURRENT VIEW</h3>
            <div class="row" style="color:#9c27b0;"><span>üèóÔ∏è Buildings:</span><span id="viewBldg">0</span></div>
            <div class="row" style="color:#2196F3;"><span>üè¢ Apartments:</span><span id="viewApt">0</span></div>
            <div class="row" style="color:#4CAF50;"><span>üè† Villas:</span><span id="viewVilla">0</span></div>
            <div class="row" style="color:#FF9800;"><span>üì¶ Other:</span><span id="viewOther">0</span></div>
            <div class="row total"><span>Total Parcels:</span><span id="viewTotal">0</span></div>
            <div class="row"><span>üìç POIs:</span><span id="viewPoi">0</span></div>
            <div class="row total" style="color:#4CAF50;"><span>Villa %:</span><span id="viewVillaPct">0%</span></div>
        </div>
        
        <!-- Layer Controls -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                üé® LAYERS <span>‚ñº</span>
            </div>
            <div class="section-content open">
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showBldg" checked onchange="render()">
                        <div class="dot" style="background:#9c27b0;"></div>
                        <span class="name">MS Buildings</span>
                    </div>
                    <div style="font-size:10px;">
                        Size: <span id="bldgSizeVal">2</span> <input type="range" id="bldgSize" min="0.5" max="8" value="2" step="0.5" oninput="updateSlider('bldg')">
                        Opacity: <span id="bldgOpacityVal">40</span>% <input type="range" id="bldgOpacity" min="10" max="100" value="40" step="5" oninput="updateSlider('bldg')">
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showApt" checked onchange="render()">
                        <div class="dot" style="background:#2196F3;"></div>
                        <span class="name">Apartments</span>
                    </div>
                    <div style="font-size:10px;">
                        Size: <span id="aptSizeVal">3</span> <input type="range" id="aptSize" min="1" max="8" value="3" step="0.5" oninput="updateSlider('apt')">
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showVilla" checked onchange="render()">
                        <div class="dot" style="background:#4CAF50;"></div>
                        <span class="name">Villas</span>
                    </div>
                    <div style="font-size:10px;">
                        Size: <span id="villaSizeVal">3</span> <input type="range" id="villaSize" min="1" max="8" value="3" step="0.5" oninput="updateSlider('villa')">
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showOther" checked onchange="render()">
                        <div class="dot" style="background:#FF9800;"></div>
                        <span class="name">Other Parcels</span>
                    </div>
                    <div style="font-size:10px;">
                        Size: <span id="otherSizeVal">2</span> <input type="range" id="otherSize" min="1" max="8" value="2" step="0.5" oninput="updateSlider('other')">
                    </div>
                </div>
                <div class="layer-control" style="background:#f3e5f5;">
                    <div class="header">
                        <input type="checkbox" id="showPoi" checked onchange="render()">
                        <div class="dot" style="background:#9C27B0;"></div>
                        <span class="name">POIs</span>
                        <span class="count" id="poiCount">0</span>
                    </div>
                    <div style="font-size:10px;">
                        Size: <span id="poiSizeVal">4</span> <input type="range" id="poiSize" min="2" max="10" value="4" step="0.5" oninput="updateSlider('poi')">
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showDistricts" checked onchange="render()">
                        <div class="dot" style="background:#607D8B;"></div>
                        <span class="name">Districts</span>
                    </div>
                </div>
                <div class="click-toggle">
                    <label><input type="checkbox" id="enableClick" checked> üñ±Ô∏è Enable click to view details</label>
                    <div style="font-size:9px;color:#666;margin-top:3px;margin-left:20px;">
                        Click on POI/Parcel/District to see info. Disable to freely pan/zoom.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Files -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                üìÇ DATA FILES <span>‚ñº</span>
            </div>
            <div class="section-content open">
                <div class="file-input">
                    <label>üèóÔ∏è MS Buildings JSON:</label>
                    <input type="file" id="buildingsFile" accept=".json">
                    <div id="buildingsStatus" class="file-status">Upload buildings JSON</div>
                </div>
                <div class="file-input">
                    <label>üìä Parcels CSV (riyadh_all_parcels_final.csv):</label>
                    <input type="file" id="parcelsFile" accept=".csv">
                    <div id="parcelsStatus" class="file-status">Upload parcels CSV</div>
                </div>
                <div class="file-input">
                    <label>üìç POI CSV (riyadh_pois.csv):</label>
                    <input type="file" id="poiFile" accept=".csv">
                    <div id="poiStatus" class="file-status">Upload POI CSV</div>
                </div>
                <div class="file-input">
                    <label>üó∫Ô∏è Districts GeoJSON:</label>
                    <input type="file" id="distFile" accept=".json,.geojson">
                    <div id="distStatus" class="file-status">Upload districts JSON</div>
                </div>
            </div>
        </div>
        
        <!-- POI Categories -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                üìç POI CATEGORIES (<span id="poiCatCount">0</span>) <span>‚ñº</span>
            </div>
            <div class="section-content">
                <div style="margin-bottom:5px;">
                    <button onclick="selectAllPoi()" style="font-size:9px;padding:2px 5px;">All</button>
                    <button onclick="clearAllPoi()" style="font-size:9px;padding:2px 5px;">None</button>
                </div>
                <div id="poiCategories" class="poi-cats"></div>
            </div>
        </div>
        
        <!-- Districts -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                üèòÔ∏è DISTRICTS (<span id="districtCount">0</span>) <span>‚ñº</span>
            </div>
            <div class="section-content">
                <input type="text" class="search-box" id="districtSearch" placeholder="Search districts..." oninput="filterDistricts()">
                <button onclick="clearDistrictSelection()" style="font-size:9px;padding:2px 5px;margin-bottom:5px;">Clear Selection</button>
                <div id="districtList" class="district-list"></div>
            </div>
        </div>
        
        <!-- Export -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                üì§ EXPORT <span>‚ñº</span>
            </div>
            <div class="section-content">
                <button class="btn btn-success" onclick="exportVisibleParcels()">Export Visible Parcels</button>
                <button class="btn btn-primary" onclick="exportDistrictParcels()">Export District Parcels</button>
            </div>
        </div>
        
        <div style="margin-top:8px;font-size:9px;color:#888;text-align:center;">
            Zoom: <span id="zoomLevel">11</span> | <a href="#" onclick="resetView();return false;">Reset View</a>
        </div>
    </div>

    <script>
        let map;
        let buildings = [];    // GeoJSON features with polygon coordinates
        let parcels = [];      // {lat, lng, type: 'apt'|'villa'|'other', ...}
        let poiData = [];      // {lat, lng, layer, name_ar, name_en}
        let districts = [];    // GeoJSON features
        let selectedDistrict = null;
        let activePoiCategories = new Set();
        let infoPopup = null;
        let buildingsFileName = '';
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // POI Colors by layer
        const poiColors = {
            'Religious': '#8B4513',
            'EatAndDrink': '#E91E63',
            'Educational': '#3F51B5',
            'HealthCare': '#F44336',
            'Commercial': '#9C27B0',
            'Financial': '#00BCD4',
            'Industry': '#795548',
            'Sports': '#4CAF50',
            'Government': '#607D8B',
            'ParksAndSquares': '#8BC34A',
            'GasStationsAndAutoServices': '#FF5722',
            'HotelsAndHospitalityServices': '#FFC107',
            'Transportation': '#2196F3',
            'Entertainment': '#E040FB',
            'Cultural': '#FF9800',
            'BusinessFirms': '#00ACC1',
            'TravelAndTourism': '#AB47BC',
            'default': '#9C27B0'
        };
        
        function toggleSection(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            header.querySelector('span:last-child').textContent = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
        }
        
        function showLoading(title) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function setLoadingStatus(msg, pct) {
            document.getElementById('loadingStatus').textContent = msg;
            document.getElementById('progressFill').style.width = pct + '%';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function updateSlider(layer) {
            document.getElementById(layer + 'SizeVal').textContent = document.getElementById(layer + 'Size').value;
            const opacityEl = document.getElementById(layer + 'Opacity');
            const opacityVal = document.getElementById(layer + 'OpacityVal');
            if (opacityEl && opacityVal) opacityVal.textContent = opacityEl.value;
            render();
        }
        
        function resetView() {
            map.setCenter({lat: 24.7136, lng: 46.6753});
            map.setZoom(11);
        }
        
        // CSV Parser
        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        }
        
        // Point in polygon
        function pointInPolygon(lat, lon, polygon) {
            if (!polygon || polygon.length < 3) return false;
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const [xi, yi] = polygon[i];
                const [xj, yj] = polygon[j];
                if (((yi > lat) !== (yj > lat)) && (lon < (xj - xi) * (lat - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }
        
        function render() {
            if (!map) return;
            const bounds = map.getBounds();
            if (!bounds) return;
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const proj = map.getProjection();
            if (!proj) return;
            
            const zoom = map.getZoom();
            document.getElementById('zoomLevel').textContent = zoom.toFixed(1);
            
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const tr = proj.fromLatLngToPoint(ne);
            const bl = proj.fromLatLngToPoint(sw);
            const scale = Math.pow(2, zoom);
            const baseSize = Math.max(1, zoom - 10);
            
            const showBldg = document.getElementById('showBldg').checked;
            const showApt = document.getElementById('showApt').checked;
            const showVilla = document.getElementById('showVilla').checked;
            const showOther = document.getElementById('showOther').checked;
            const showPoi = document.getElementById('showPoi').checked;
            const showDist = document.getElementById('showDistricts').checked;
            
            const bldgSize = parseFloat(document.getElementById('bldgSize').value) * baseSize / 2;
            const bldgOpacity = parseInt(document.getElementById('bldgOpacity').value) / 100;
            const aptSize = parseFloat(document.getElementById('aptSize').value) * baseSize / 2;
            const villaSize = parseFloat(document.getElementById('villaSize').value) * baseSize / 2;
            const otherSize = parseFloat(document.getElementById('otherSize').value) * baseSize / 2;
            const poiSize = parseFloat(document.getElementById('poiSize').value) * baseSize / 2;
            
            let viewBldg = 0, viewApt = 0, viewVilla = 0, viewOther = 0, viewPoi = 0;
            
            // Draw districts
            if (showDist && districts.length) {
                districts.forEach(d => {
                    if (selectedDistrict && d.properties.name !== selectedDistrict) return;
                    
                    const coords = d.geometry.type === 'Polygon' ? d.geometry.coordinates[0] : 
                                   d.geometry.type === 'MultiPolygon' ? d.geometry.coordinates[0][0] : null;
                    if (!coords || coords.length < 3) return;
                    
                    // Fill for selected
                    if (selectedDistrict) {
                        ctx.fillStyle = 'rgba(255, 152, 0, 0.15)';
                        ctx.beginPath();
                        coords.forEach(([lon, lat], i) => {
                            const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lon));
                            const x = (w.x - bl.x) * scale, y = (w.y - tr.y) * scale;
                            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                        });
                        ctx.closePath();
                        ctx.fill();
                    }
                    
                    // Stroke
                    ctx.strokeStyle = selectedDistrict ? '#ff5722' : '#607D8B';
                    ctx.lineWidth = selectedDistrict ? 3 : 1;
                    ctx.globalAlpha = selectedDistrict ? 1 : 0.5;
                    ctx.beginPath();
                    coords.forEach(([lon, lat], i) => {
                        const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lon));
                        const x = (w.x - bl.x) * scale, y = (w.y - tr.y) * scale;
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    });
                    ctx.closePath();
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                });
            }
            
            // Draw buildings as polygons
            if (showBldg && buildings.length) {
                ctx.strokeStyle = '#9c27b0';
                ctx.lineWidth = bldgSize;
                ctx.globalAlpha = bldgOpacity;
                
                buildings.forEach(b => {
                    const coords = b.geometry?.coordinates?.[0];
                    if (!coords || coords.length < 3) return;
                    
                    // Quick bounds check using first coordinate
                    const [firstLon, firstLat] = coords[0];
                    if (firstLat < sw.lat() - 0.01 || firstLat > ne.lat() + 0.01 ||
                        firstLon < sw.lng() - 0.01 || firstLon > ne.lng() + 0.01) return;
                    
                    viewBldg++;
                    
                    ctx.fillStyle = 'rgba(156, 39, 176, 0.3)';
                    ctx.beginPath();
                    
                    coords.forEach(([lon, lat], i) => {
                        const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lon));
                        const x = (w.x - bl.x) * scale, y = (w.y - tr.y) * scale;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                });
                ctx.globalAlpha = 1;
            }
            
            // Draw parcels
            parcels.forEach(p => {
                if (p.lat < sw.lat() || p.lat > ne.lat() || p.lng < sw.lng() || p.lng > ne.lng()) return;
                
                const w = proj.fromLatLngToPoint(new google.maps.LatLng(p.lat, p.lng));
                const x = (w.x - bl.x) * scale, y = (w.y - tr.y) * scale;
                
                if (p.type === 'apt' && showApt) {
                    ctx.fillStyle = 'rgba(33, 150, 243, 0.6)';
                    ctx.beginPath(); ctx.arc(x, y, aptSize, 0, Math.PI * 2); ctx.fill();
                    viewApt++;
                } else if (p.type === 'villa' && showVilla) {
                    ctx.fillStyle = 'rgba(76, 175, 80, 0.6)';
                    ctx.beginPath(); ctx.arc(x, y, villaSize, 0, Math.PI * 2); ctx.fill();
                    viewVilla++;
                } else if (p.type === 'other' && showOther) {
                    ctx.fillStyle = 'rgba(255, 152, 0, 0.4)';
                    ctx.beginPath(); ctx.arc(x, y, otherSize, 0, Math.PI * 2); ctx.fill();
                    viewOther++;
                }
            });
            
            // Draw POIs
            if (showPoi) {
                poiData.forEach(p => {
                    if (p.lat < sw.lat() || p.lat > ne.lat() || p.lng < sw.lng() || p.lng > ne.lng()) return;
                    if (activePoiCategories.size > 0 && !activePoiCategories.has(p.layer)) return;
                    
                    const w = proj.fromLatLngToPoint(new google.maps.LatLng(p.lat, p.lng));
                    const x = (w.x - bl.x) * scale, y = (w.y - tr.y) * scale;
                    
                    ctx.fillStyle = poiColors[p.layer] || poiColors['default'];
                    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
                    ctx.lineWidth = 1;
                    ctx.beginPath(); ctx.arc(x, y, poiSize, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    viewPoi++;
                });
            }
            
            // Update view counts
            const viewTotal = viewApt + viewVilla + viewOther;
            const villaPct = viewTotal > 0 ? (viewVilla / viewTotal * 100).toFixed(1) : 0;
            
            document.getElementById('viewBldg').textContent = viewBldg.toLocaleString();
            document.getElementById('viewApt').textContent = viewApt.toLocaleString();
            document.getElementById('viewVilla').textContent = viewVilla.toLocaleString();
            document.getElementById('viewOther').textContent = viewOther.toLocaleString();
            document.getElementById('viewTotal').textContent = viewTotal.toLocaleString();
            document.getElementById('viewPoi').textContent = viewPoi.toLocaleString();
            document.getElementById('viewVillaPct').textContent = villaPct + '%';
        }
        
        // Calculate district stats
        function calculateDistrictStats() {
            if (!selectedDistrict) {
                document.getElementById('districtStats').classList.remove('active');
                return;
            }
            
            const d = districts.find(x => x.properties.name === selectedDistrict);
            if (!d) return;
            
            const coords = d.geometry.type === 'Polygon' ? d.geometry.coordinates[0] : 
                           d.geometry.type === 'MultiPolygon' ? d.geometry.coordinates[0][0] : null;
            if (!coords) return;
            
            // Convert to [lat, lon] for pointInPolygon
            const poly = coords.map(([lon, lat]) => [lon, lat]);
            
            let bldg = 0, apt = 0, villa = 0, other = 0, poi = 0;
            
            buildings.forEach(b => {
                const coords = b.geometry?.coordinates?.[0];
                if (!coords || coords.length === 0) return;
                // Use first coordinate of building polygon for point-in-polygon check
                const [lon, lat] = coords[0];
                if (pointInPolygon(lat, lon, poly)) bldg++;
            });
            
            parcels.forEach(p => {
                if (pointInPolygon(p.lat, p.lng, poly)) {
                    if (p.type === 'apt') apt++;
                    else if (p.type === 'villa') villa++;
                    else other++;
                }
            });
            
            poiData.forEach(p => {
                if (pointInPolygon(p.lat, p.lng, poly)) poi++;
            });
            
            const total = apt + villa + other;
            const villaPct = total > 0 ? (villa / total * 100).toFixed(1) : 0;
            const aptPct = total > 0 ? (apt / total * 100).toFixed(1) : 0;
            
            document.getElementById('districtStatsTitle').textContent = 'üìç DISTRICT: ' + selectedDistrict;
            document.getElementById('distBldg').textContent = bldg.toLocaleString();
            document.getElementById('distApt').textContent = apt.toLocaleString();
            document.getElementById('distVilla').textContent = villa.toLocaleString();
            document.getElementById('distOther').textContent = other.toLocaleString();
            document.getElementById('distTotal').textContent = total.toLocaleString();
            document.getElementById('distPoi').textContent = poi.toLocaleString();
            document.getElementById('distVillaPct').textContent = villaPct + '%';
            document.getElementById('distAptPct').textContent = aptPct + '%';
            document.getElementById('districtStats').classList.add('active');
        }
        
        // File loaders
        document.getElementById('buildingsFile').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            showLoading('Loading Buildings...');
            buildingsFileName = file.name;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = JSON.parse(evt.target.result);
                
                // Handle different formats:
                // 1. GeoJSON FeatureCollection
                // 2. Array of features
                // 3. Array of [lat, lng] (convert to simple markers)
                if (data.type === 'FeatureCollection' && data.features) {
                    buildings = data.features.filter(f => 
                        f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')
                    );
                } else if (Array.isArray(data) && data[0]?.geometry) {
                    buildings = data.filter(f => 
                        f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')
                    );
                } else if (Array.isArray(data) && Array.isArray(data[0])) {
                    // Array of [lat, lng] - convert to fake polygon for backwards compatibility
                    buildings = data.map(([lat, lng]) => ({
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[[lng, lat], [lng+0.00005, lat], [lng+0.00005, lat+0.00005], [lng, lat+0.00005], [lng, lat]]]
                        }
                    }));
                } else {
                    buildings = [];
                }
                
                document.getElementById('totalBldg').textContent = buildings.length.toLocaleString();
                document.getElementById('buildingsStatus').innerHTML = `‚úì <b>${file.name}</b><br>${buildings.length.toLocaleString()} building polygons loaded`;
                document.getElementById('buildingsStatus').classList.add('loaded');
                hideLoading();
                showToast(`üèóÔ∏è Loaded ${buildings.length.toLocaleString()} buildings`, '#9c27b0');
                calculateDistrictStats();
                render();
            };
            reader.readAsText(file);
        });
        
        function showToast(msg, color) {
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${color};color:white;padding:15px 30px;border-radius:8px;font-weight:bold;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.3);`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        document.getElementById('parcelsFile').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            showLoading('Loading Parcels...');
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
                
                parcels = [];
                let aptCount = 0, villaCount = 0, otherCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    if (i % 100000 === 0) setLoadingStatus(`${i.toLocaleString()} rows`, i/lines.length*100);
                    if (!lines[i].trim()) continue;
                    
                    const values = parseCSVLine(lines[i]);
                    const row = {}; headers.forEach((h, idx) => row[h] = values[idx]);
                    
                    const lat = parseFloat(row.latitude || row.lat);
                    const lng = parseFloat(row.longitude || row.lng || row.lon);
                    if (isNaN(lat) || isNaN(lng)) continue;
                    
                    // Classify parcel
                    let type = 'other';
                    const isApt = row.is_apartment;
                    const landUse = (row.mainlanduse || row.land_use || '').toString();
                    const subtype = (row.subtype || '').toString().toLowerCase();
                    const floors = parseInt(row.nooffloors || row.floors || 0);
                    const units = parseInt(row.residentialunits || row.units || 0);
                    
                    if (isApt === 'True' || isApt === 'true' || isApt === '1' || 
                        subtype.includes('ÿ¥ŸÇŸÇ') || subtype.includes('apartment') ||
                        landUse === '7510' || (landUse === '1000' && floors >= 3) || units >= 4) {
                        type = 'apt'; aptCount++;
                    } else if (subtype.includes('ŸÅŸäŸÑÿß') || subtype.includes('villa') ||
                               landUse === '1000' || landUse === '1012' ||
                               (landUse === '1000' && floors <= 2 && units <= 2)) {
                        type = 'villa'; villaCount++;
                    } else {
                        otherCount++;
                    }
                    
                    parcels.push({ lat, lng, type, landuse: landUse, district_id: row.district_id || '' });
                }
                
                document.getElementById('parcelsStatus').innerHTML = `‚úì <b>${file.name}</b><br>${parcels.length.toLocaleString()} parcels loaded`;
                document.getElementById('parcelsStatus').classList.add('loaded');
                showToast(`üìä Loaded ${parcels.length.toLocaleString()} parcels`, '#4CAF50');
                document.getElementById('totalParcels').textContent = parcels.length.toLocaleString();
                document.getElementById('totalApt').textContent = aptCount.toLocaleString();
                document.getElementById('totalVilla').textContent = villaCount.toLocaleString();
                document.getElementById('totalOther').textContent = otherCount.toLocaleString();
                
                hideLoading();
                calculateDistrictStats();
                render();
            };
            reader.readAsText(file);
        });
        
        document.getElementById('poiFile').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            showLoading('Loading POIs...');
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
                
                poiData = [];
                const categories = {};
                
                for (let i = 1; i < lines.length; i++) {
                    if (i % 10000 === 0) setLoadingStatus(`${i.toLocaleString()} rows`, i/lines.length*100);
                    if (!lines[i].trim()) continue;
                    
                    const values = parseCSVLine(lines[i]);
                    const row = {}; headers.forEach((h, idx) => row[h] = values[idx]);
                    
                    const lat = parseFloat(row.latitude || row.lat);
                    const lng = parseFloat(row.longitude || row.lng || row.lon);
                    if (isNaN(lat) || isNaN(lng)) continue;
                    
                    const layer = row.layer || 'Unknown';
                    categories[layer] = (categories[layer] || 0) + 1;
                    
                    poiData.push({
                        lat, lng, layer,
                        name_ar: row.name_ar || '',
                        name_en: row.name_en || ''
                    });
                }
                
                document.getElementById('poiStatus').textContent = `‚úì ${poiData.length.toLocaleString()} loaded`;
                document.getElementById('poiStatus').classList.add('loaded');
                document.getElementById('totalPoi').textContent = poiData.length.toLocaleString();
                document.getElementById('poiCount').textContent = poiData.length.toLocaleString();
                document.getElementById('poiCatCount').textContent = Object.keys(categories).length;
                
                // Build category checkboxes
                activePoiCategories = new Set(Object.keys(categories));
                const catContainer = document.getElementById('poiCategories');
                catContainer.innerHTML = '';
                
                Object.entries(categories).sort((a,b) => b[1]-a[1]).forEach(([cat, count]) => {
                    const div = document.createElement('div');
                    div.className = 'poi-cat';
                    const color = poiColors[cat] || poiColors['default'];
                    div.innerHTML = `
                        <input type="checkbox" checked data-cat="${cat}">
                        <div class="dot" style="background:${color};width:10px;height:10px;border-radius:50%;"></div>
                        <span>${cat}</span>
                        <span class="cnt">${count.toLocaleString()}</span>
                    `;
                    div.querySelector('input').addEventListener('change', function() {
                        if (this.checked) activePoiCategories.add(cat);
                        else activePoiCategories.delete(cat);
                        render();
                    });
                    catContainer.appendChild(div);
                });
                
                hideLoading();
                render();
            };
            reader.readAsText(file);
        });
        
        document.getElementById('distFile').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    districts = data.features || [];
                    
                    document.getElementById('distStatus').textContent = `‚úì ${districts.length} loaded`;
                    document.getElementById('distStatus').classList.add('loaded');
                    document.getElementById('districtCount').textContent = districts.length;
                    
                    updateDistrictList();
                    render();
                } catch(err) {
                    document.getElementById('distStatus').textContent = 'Error: Invalid JSON';
                }
            };
            reader.readAsText(file);
        });
        
        function updateDistrictList() {
            const search = document.getElementById('districtSearch').value.toLowerCase();
            const container = document.getElementById('districtList');
            container.innerHTML = '';
            
            districts.forEach(d => {
                const name = d.properties.name || d.properties.NAME || 'Unknown';
                if (search && !name.toLowerCase().includes(search)) return;
                
                const div = document.createElement('div');
                div.className = 'district-item' + (selectedDistrict === name ? ' selected' : '');
                div.textContent = name;
                div.onclick = () => selectDistrict(name);
                container.appendChild(div);
            });
        }
        
        function filterDistricts() { updateDistrictList(); }
        
        function selectDistrict(name) {
            selectedDistrict = (selectedDistrict === name) ? null : name;
            updateDistrictList();
            calculateDistrictStats();
            render();
        }
        
        function clearDistrictSelection() {
            selectedDistrict = null;
            updateDistrictList();
            calculateDistrictStats();
            render();
        }
        
        function selectAllPoi() {
            document.querySelectorAll('#poiCategories input').forEach(cb => { cb.checked = true; activePoiCategories.add(cb.dataset.cat); });
            render();
        }
        
        function clearAllPoi() {
            document.querySelectorAll('#poiCategories input').forEach(cb => { cb.checked = false; });
            activePoiCategories.clear();
            render();
        }
        
        function exportVisibleParcels() {
            const bounds = map.getBounds();
            const ne = bounds.getNorthEast(), sw = bounds.getSouthWest();
            const visible = parcels.filter(p => p.lat >= sw.lat() && p.lat <= ne.lat() && p.lng >= sw.lng() && p.lng <= ne.lng());
            downloadCSV(visible, 'visible_parcels.csv');
        }
        
        function exportDistrictParcels() {
            if (!selectedDistrict) { alert('Select a district first'); return; }
            const d = districts.find(x => x.properties.name === selectedDistrict);
            if (!d) return;
            const coords = d.geometry.type === 'Polygon' ? d.geometry.coordinates[0] : d.geometry.coordinates[0][0];
            const poly = coords.map(([lon, lat]) => [lon, lat]);
            const inDist = parcels.filter(p => pointInPolygon(p.lat, p.lng, poly));
            downloadCSV(inDist, `${selectedDistrict}_parcels.csv`);
        }
        
        function downloadCSV(data, filename) {
            const csv = 'latitude,longitude,type\n' + data.map(p => `${p.lat},${p.lng},${p.type}`).join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }
        
        // Info popup functions
        function showInfoPopup(x, y, title, content) {
            const popup = document.getElementById('infoPopup');
            document.getElementById('popupTitle').innerHTML = title;
            document.getElementById('popupContent').innerHTML = content;
            
            // Position popup
            let left = x + 15;
            let top = y + 15;
            if (left + 300 > window.innerWidth) left = x - 315;
            if (top + 200 > window.innerHeight) top = y - 215;
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.classList.add('show');
        }
        
        function closeInfoPopup() {
            document.getElementById('infoPopup').classList.remove('show');
        }
        
        function findClickedItem(lat, lng, pixelTolerance) {
            if (!map) return null;
            
            const proj = map.getProjection();
            const zoom = map.getZoom();
            const scale = Math.pow(2, zoom);
            const clickPt = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lng));
            
            // Tolerance in world coordinates
            const tolerance = pixelTolerance / scale;
            
            // Check POIs first (on top)
            for (const p of poiData) {
                if (activePoiCategories.size > 0 && !activePoiCategories.has(p.layer)) continue;
                const pt = proj.fromLatLngToPoint(new google.maps.LatLng(p.lat, p.lng));
                if (Math.abs(pt.x - clickPt.x) < tolerance && Math.abs(pt.y - clickPt.y) < tolerance) {
                    return { type: 'poi', data: p };
                }
            }
            
            // Check parcels
            for (const p of parcels) {
                const pt = proj.fromLatLngToPoint(new google.maps.LatLng(p.lat, p.lng));
                if (Math.abs(pt.x - clickPt.x) < tolerance && Math.abs(pt.y - clickPt.y) < tolerance) {
                    return { type: 'parcel', data: p };
                }
            }
            
            // Check buildings (polygon click)
            for (const b of buildings) {
                const coords = b.geometry?.coordinates?.[0];
                if (!coords || coords.length < 3) continue;
                
                // Convert building polygon to screen coordinates
                const screenPoly = coords.map(([lon, lat]) => {
                    const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lon));
                    return { x: (w.x - bounds.getSouthWest().lng) * scale, y: (w.y - bounds.getNorthEast().lat) * scale };
                });
                
                // Simple bounds check first
                const [lon, lat] = coords[0];
                const pt = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lon));
                if (Math.abs(pt.x - clickPt.x) < tolerance * 3 && Math.abs(pt.y - clickPt.y) < tolerance * 3) {
                    return { type: 'building', data: { lat: lat, lng: lon } };
                }
            }
            
            // Check districts
            for (const d of districts) {
                const coords = d.geometry.type === 'Polygon' ? d.geometry.coordinates[0] : 
                               d.geometry.type === 'MultiPolygon' ? d.geometry.coordinates[0][0] : null;
                if (!coords) continue;
                const poly = coords.map(([lon, lat]) => [lon, lat]);
                if (pointInPolygon(lat, lng, poly)) {
                    return { type: 'district', data: d };
                }
            }
            
            return null;
        }
        
        function handleMapClick(e) {
            if (!document.getElementById('enableClick').checked) return;
            
            closeInfoPopup();
            
            const lat = e.latLng.lat();
            const lng = e.latLng.lng();
            const item = findClickedItem(lat, lng, 15);
            
            if (!item) return;
            
            const pixelX = e.pixel.x;
            const pixelY = e.pixel.y;
            
            if (item.type === 'poi') {
                const p = item.data;
                const color = poiColors[p.layer] || poiColors['default'];
                showInfoPopup(pixelX, pixelY, 
                    `<span class="type-badge type-poi">${p.layer}</span> POI`,
                    `<table>
                        <tr><td>Name (AR)</td><td>${p.name_ar || '-'}</td></tr>
                        <tr><td>Name (EN)</td><td>${p.name_en || '-'}</td></tr>
                        <tr><td>Category</td><td>${p.layer}</td></tr>
                        <tr><td>Location</td><td>${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}</td></tr>
                    </table>`
                );
            } else if (item.type === 'parcel') {
                const p = item.data;
                const typeClass = p.type === 'apt' ? 'type-apt' : p.type === 'villa' ? 'type-villa' : 'type-other';
                const typeName = p.type === 'apt' ? 'Apartment' : p.type === 'villa' ? 'Villa' : 'Other';
                showInfoPopup(pixelX, pixelY,
                    `<span class="type-badge ${typeClass}">${typeName}</span> Parcel`,
                    `<table>
                        <tr><td>Type</td><td>${typeName}</td></tr>
                        <tr><td>Location</td><td>${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}</td></tr>
                        ${p.landuse ? `<tr><td>Land Use</td><td>${p.landuse}</td></tr>` : ''}
                        ${p.district_id ? `<tr><td>District ID</td><td>${p.district_id}</td></tr>` : ''}
                    </table>`
                );
            } else if (item.type === 'building') {
                const b = item.data;
                showInfoPopup(pixelX, pixelY,
                    `<span class="type-badge" style="background:#9c27b0;">Building</span> MS Building`,
                    `<table>
                        <tr><td>Location</td><td>${b.lat.toFixed(6)}, ${b.lng.toFixed(6)}</td></tr>
                    </table>`
                );
            } else if (item.type === 'district') {
                const d = item.data;
                const name = d.properties.name || d.properties.NAME || 'Unknown';
                selectDistrict(name);
            }
        }
        
        window.initMap = function() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 24.7136, lng: 46.6753 },
                zoom: 11,
                mapTypeControl: true,
                gestureHandling: 'greedy'
            });
            
            map.addListener('idle', render);
            map.addListener('click', handleMapClick);
            
            window.addEventListener('resize', () => {
                render();
            });
            
            console.log('Map ready. Upload your data files.');
        }
    </script>
    <script src="https://somanchiu.github.io/Keyless-Google-Maps-API/mapsJavaScriptAPI.js?callback=initMap" async defer></script>
</body>
</html>
