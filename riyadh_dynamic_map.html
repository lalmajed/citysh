<!DOCTYPE html>
<html>
<head>
    <title>Riyadh Map - Dynamic Counts</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
        
        .panel {
            position: absolute; top: 10px; left: 10px;
            background: white; padding: 12px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); z-index: 1000;
            max-width: 400px; max-height: 95vh; overflow-y: auto; font-size: 12px;
        }
        .panel h2 { color: #1a73e8; margin-bottom: 8px; font-size: 15px; }
        
        .section { margin: 8px 0; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .section-header {
            background: #f5f5f5; padding: 8px 10px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600; font-size: 12px;
        }
        .section-header:hover { background: #e8e8e8; }
        .section-content { padding: 8px; display: none; }
        .section-content.open { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin: 8px 0; }
        .stat-box { padding: 8px; border-radius: 6px; text-align: center; color: white; }
        .stat-box .num { font-size: 1.2em; font-weight: bold; }
        .stat-box .lbl { font-size: 9px; opacity: 0.9; }
        
        .dynamic-stats { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 10px; margin: 8px 0; }
        .dynamic-stats h3 { color: #2e7d32; font-size: 13px; margin-bottom: 8px; }
        .dynamic-stats .row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .dynamic-stats .row.total { font-weight: bold; border-top: 1px solid #a5d6a7; padding-top: 5px; margin-top: 5px; }
        
        .district-stats { background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 10px; margin: 8px 0; display: none; }
        .district-stats.active { display: block; }
        .district-stats h3 { color: #e65100; font-size: 13px; margin-bottom: 8px; }
        .district-stats .row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .district-stats .row.total { font-weight: bold; border-top: 1px solid #ffcc80; padding-top: 5px; margin-top: 5px; }
        .district-stats .sub { padding-left: 10px; color: #666; }
        
        .entry-exit-section { background: #fce4ec; border: 2px solid #e91e63; border-radius: 6px; padding: 8px; margin-top: 8px; }
        .entry-exit-section h4 { color: #c2185b; font-size: 12px; margin-bottom: 6px; }
        
        .layer-control { padding: 8px; margin: 5px 0; background: #f9f9f9; border-radius: 6px; }
        .layer-control .header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .layer-control .dot { width: 14px; height: 14px; border-radius: 50%; }
        .layer-control .name { font-weight: 600; flex: 1; }
        .layer-control .count { font-size: 10px; color: #666; }
        .layer-control input[type="range"] { width: 100%; margin: 2px 0; }
        
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 450; }
        
        .btn { padding: 8px 12px; margin: 3px 0; cursor: pointer; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; width: 100%; }
        .btn-primary { background: #1a73e8; color: white; border: none; }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 18px; flex-direction: column; gap: 20px;
        }
        .loading-overlay.hidden { display: none; }
        .progress-bar { width: 300px; height: 20px; background: #333; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4CAF50; transition: width 0.3s; }
        
        .file-input { margin: 5px 0; }
        .file-input label { display: block; font-weight: 600; font-size: 10px; margin-bottom: 2px; }
        .file-input input[type="file"] { font-size: 9px; width: 100%; }
        .file-status { font-size: 9px; color: #666; }
        .file-status.loaded { color: #28a745; font-weight: bold; }
        
        .info-popup {
            position: absolute; background: white; padding: 12px 15px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 2000; min-width: 300px; max-width: 400px;
            font-size: 12px; display: none; border-left: 4px solid #1a73e8;
        }
        .info-popup.show { display: block; }
        .info-popup h3 { margin: 0 0 8px 0; color: #1a73e8; font-size: 14px; }
        .info-popup .close { position: absolute; top: 5px; right: 8px; cursor: pointer; color: #999; font-size: 18px; }
        .info-popup table { width: 100%; border-collapse: collapse; }
        .info-popup td { padding: 4px 5px; border-bottom: 1px solid #eee; font-size: 11px; }
        .info-popup td:first-child { font-weight: 600; color: #555; width: 40%; }
        .type-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; color: white; font-size: 10px; }
        
        .road-legend { margin-top:10px;padding:8px;background:#e3f2fd;border-radius:6px; display:none; }
        .road-legend.show { display: block; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div id="loadingTitle">Loading Google Maps...</div>
        <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
        <div id="loadingStatus">Please wait...</div>
    </div>
    
    <div id="map"></div>
    <canvas id="canvas"></canvas>
    
    <div id="infoPopup" class="info-popup">
        <span class="close" onclick="closeInfoPopup()">&times;</span>
        <h3 id="popupTitle">Details</h3>
        <div id="popupContent"></div>
    </div>
    
    <div class="panel">
        <h2>Riyadh Map - Dynamic Counts</h2>
        
        <div class="stats-grid">
            <div class="stat-box" style="background:#9c27b0;"><div class="num" id="totalBldg">0</div><div class="lbl">Buildings</div></div>
            <div class="stat-box" style="background:#2196F3;"><div class="num" id="totalApt">0</div><div class="lbl">Apartments</div></div>
            <div class="stat-box" style="background:#4CAF50;"><div class="num" id="totalVilla">0</div><div class="lbl">Villas</div></div>
            <div class="stat-box" style="background:#FF9800;"><div class="num" id="totalOther">0</div><div class="lbl">Other</div></div>
        </div>
        <div style="text-align:center; font-size:11px; color:#666; margin-bottom:8px;">
            Total Parcels: <b id="totalParcels">0</b> | Roads: <b id="totalRoads">0</b>
        </div>
        
        <!-- District Stats (shown when district clicked) -->
        <div class="district-stats" id="districtStats">
            <h3 id="districtStatsTitle">DISTRICT: None</h3>
            <div class="row" style="color:#2196F3;"><span>Apartments:</span><span id="distApt">0</span></div>
            <div class="row" style="color:#4CAF50;"><span>Villas:</span><span id="distVilla">0</span></div>
            <div class="row" style="color:#FF9800;"><span>Other:</span><span id="distOther">0</span></div>
            <div class="row total"><span>Total Parcels:</span><span id="distTotal">0</span></div>
            
            <!-- Roads Section -->
            <div style="border-top:2px solid #2196F3;margin-top:8px;padding-top:8px;">
                <div class="row" style="color:#2196F3;font-weight:bold;"><span>ROADS</span><span></span></div>
                <div class="row"><span>Total Roads:</span><span id="distRoads">0</span></div>
                <div class="row"><span>Total Length:</span><span id="distRoadLength">0 km</span></div>
                <div class="row"><span class="sub">Major (20m+):</span><span id="distMajorRoads">0</span></div>
            </div>
            
            <!-- Entry/Exit Section -->
            <div class="entry-exit-section">
                <h4>ENTRY/EXIT POINTS (Roads crossing boundary)</h4>
                <div class="row total" style="background:#f8bbd0;margin:-4px -8px;padding:6px 8px;border-radius:4px;">
                    <span>Total Crossings:</span><span id="distEntryExit">0</span>
                </div>
                <div class="row"><span class="sub">Major Roads (20m+):</span><span id="distMajorCrossings">0</span></div>
                <div class="row"><span class="sub">Secondary (15-20m):</span><span id="distSecCrossings">0</span></div>
                <div class="row"><span class="sub">Local (<15m):</span><span id="distLocalCrossings">0</span></div>
                <div class="row"><span>Unique Roads:</span><span id="distUniqueRoads">0</span></div>
            </div>
            
            <button class="btn btn-primary" onclick="zoomToDistrict()" style="margin-top:8px;">Zoom to District</button>
        </div>
        
        <!-- Current View Stats -->
        <div class="dynamic-stats">
            <h3>IN CURRENT VIEW</h3>
            <div class="row" style="color:#2196F3;"><span>Apartments:</span><span id="viewApt">0</span></div>
            <div class="row" style="color:#4CAF50;"><span>Villas:</span><span id="viewVilla">0</span></div>
            <div class="row" style="color:#FF9800;"><span>Other:</span><span id="viewOther">0</span></div>
            <div class="row total"><span>Total Parcels:</span><span id="viewTotal">0</span></div>
            <div class="row total" style="color:#4CAF50;"><span>Villa %:</span><span id="viewVillaPct">0%</span></div>
        </div>
        
        <!-- Layers -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                LAYERS <span>[-]</span>
            </div>
            <div class="section-content open">
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showApt" checked onchange="render()">
                        <div class="dot" style="background:#2196F3;"></div>
                        <span class="name">Apartments</span>
                    </div>
                    <div style="font-size:10px;">Size: <input type="range" id="aptSize" min="1" max="10" value="4" oninput="render()"></div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showVilla" checked onchange="render()">
                        <div class="dot" style="background:#4CAF50;"></div>
                        <span class="name">Villas</span>
                    </div>
                    <div style="font-size:10px;">Size: <input type="range" id="villaSize" min="1" max="10" value="4" oninput="render()"></div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showOther" checked onchange="render()">
                        <div class="dot" style="background:#FF9800;"></div>
                        <span class="name">Other Parcels</span>
                    </div>
                </div>
                <div class="layer-control" style="background:#e3f2fd;">
                    <div class="header">
                        <input type="checkbox" id="showRoads" checked onchange="render()">
                        <div class="dot" style="background:#d32f2f;"></div>
                        <span class="name">Roads</span>
                        <span class="count" id="roadCount">0</span>
                    </div>
                    <div style="font-size:10px;">Width: <input type="range" id="roadWidth" min="0.5" max="3" value="1" step="0.25" oninput="render()"></div>
                </div>
                <div class="layer-control" style="background:#fce4ec;">
                    <div class="header">
                        <input type="checkbox" id="showEntryExit" checked onchange="render()">
                        <div class="dot" style="background:#e91e63;"></div>
                        <span class="name">Entry/Exit Points</span>
                        <span class="count" id="entryExitCount">0</span>
                    </div>
                    <div style="font-size:10px;">Size: <input type="range" id="entryExitSize" min="4" max="20" value="10" oninput="render()"></div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showDistricts" checked onchange="render()">
                        <div class="dot" style="background:#9c27b0; opacity:0.5;"></div>
                        <span class="name">District Boundaries</span>
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showLabels" onchange="render()">
                        <div class="dot" style="background:#333;"></div>
                        <span class="name">Road Labels</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Files -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                DATA FILES <span>[-]</span>
            </div>
            <div class="section-content open">
                <div class="file-input">
                    <label>Parcels CSV:</label>
                    <input type="file" id="parcelsFile" accept=".csv">
                    <div id="parcelsStatus" class="file-status">Upload parcels CSV</div>
                </div>
                <div class="file-input" style="background:#e3f2fd;padding:8px;border-radius:6px;margin-top:8px;">
                    <label>Roads GeoJSON:</label>
                    <input type="file" id="roadsFile" accept=".json,.geojson">
                    <div id="roadsStatus" class="file-status">Upload roads GeoJSON</div>
                </div>
                <div class="file-input" style="background:#f3e5f5;padding:8px;border-radius:6px;margin-top:8px;">
                    <label>Districts GeoJSON:</label>
                    <input type="file" id="distFile" accept=".json,.geojson">
                    <div id="distStatus" class="file-status">Upload districts GeoJSON</div>
                </div>
            </div>
        </div>
        
        <!-- Road Legend -->
        <div class="road-legend" id="roadLegend">
            <div style="font-weight:600;font-size:11px;margin-bottom:5px;">Road Width Legend</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;font-size:9px;">
                <div><span style="display:inline-block;width:20px;height:4px;background:#d32f2f;border-radius:2px;"></span> 30m+</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#ff9800;border-radius:2px;"></span> 20-30m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#ffc107;border-radius:2px;"></span> 15-20m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#4caf50;border-radius:2px;"></span> 12-15m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#009688;border-radius:2px;"></span> 10-12m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#607d8b;border-radius:2px;"></span> <10m</div>
            </div>
            <div style="margin-top:8px;border-top:1px solid #90caf9;padding-top:8px;">
                <div style="font-size:9px;"><span style="display:inline-block;width:12px;height:12px;background:#e91e63;border-radius:50%;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></span> Entry/Exit Point</div>
            </div>
        </div>
        
        <div style="margin-top:8px;font-size:9px;color:#888;text-align:center;">
            Zoom: <span id="zoomLevel">11</span> | <a href="#" onclick="map.setCenter({lat:24.7136,lng:46.6753});map.setZoom(11);return false;">Reset</a>
        </div>
    </div>

    <script>
        let map;
        let parcels = [];
        let roads = [];
        let districts = [];
        let entryExitPoints = [];
        let selectedDistrict = null;
        let mapsLoadAttempts = 0;
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        function getRoadColor(width) {
            if (width >= 30) return '#d32f2f';
            if (width >= 20) return '#ff9800';
            if (width >= 15) return '#ffc107';
            if (width >= 12) return '#4caf50';
            if (width >= 10) return '#009688';
            return '#607d8b';
        }
        
        function waitForGoogleMaps() {
            mapsLoadAttempts++;
            const progress = Math.min(90, mapsLoadAttempts * 3);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('loadingStatus').textContent = 'Loading... attempt ' + mapsLoadAttempts;
            
            if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('loadingStatus').textContent = 'Map loaded!';
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    initMap();
                }, 200);
            } else if (mapsLoadAttempts < 150) {
                setTimeout(waitForGoogleMaps, 150);
            } else {
                document.getElementById('loadingTitle').textContent = 'Failed to load Google Maps';
                document.getElementById('loadingStatus').innerHTML = '<button onclick="location.reload()" style="padding:10px 20px;cursor:pointer;">Retry</button>';
            }
        }
        
        function toggleSection(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            header.querySelector('span').textContent = content.classList.contains('open') ? '[-]' : '[+]';
        }
        
        // Point in polygon check
        function pointInPolygon(lng, lat, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                if (((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }
        
        // Line intersection for entry/exit detection
        function lineIntersect(x1, y1, x2, y2, x3, y3, x4, y4) {
            const denom = (y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1);
            if (Math.abs(denom) < 1e-10) return null;
            const ua = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / denom;
            const ub = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / denom;
            if (ua >= 0 && ua <= 1 && ub >= 0 && ub <= 1) {
                return { x: x1 + ua * (x2 - x1), y: y1 + ua * (y2 - y1) };
            }
            return null;
        }
        
        // Calculate entry/exit points for a district
        function calculateEntryExitForDistrict(district) {
            if (!district || !roads.length) return { points: [], stats: {} };
            
            const boundary = district.geometry.type === 'Polygon' ? 
                district.geometry.coordinates[0] : 
                district.geometry.coordinates[0][0];
            
            const points = [];
            const uniqueRoads = new Set();
            let major = 0, secondary = 0, local = 0;
            
            roads.forEach(road => {
                const props = road.properties || {};
                const width = parseFloat(props.width_m || props.WIDTH || 10);
                const name = props.name_ar || props.name_en || props.ROADCENTERLINENAME_AR || 'Unknown';
                
                const geom = road.geometry;
                if (!geom) return;
                
                const lines = geom.type === 'LineString' ? [geom.coordinates] : 
                             (geom.type === 'MultiLineString' ? geom.coordinates : []);
                
                lines.forEach(coords => {
                    if (!coords || coords.length < 2) return;
                    
                    for (let i = 0; i < coords.length - 1; i++) {
                        const [x1, y1] = coords[i];
                        const [x2, y2] = coords[i + 1];
                        
                        for (let j = 0; j < boundary.length - 1; j++) {
                            const [x3, y3] = boundary[j];
                            const [x4, y4] = boundary[j + 1];
                            
                            const intersection = lineIntersect(x1, y1, x2, y2, x3, y3, x4, y4);
                            if (intersection) {
                                points.push({
                                    lat: intersection.y,
                                    lng: intersection.x,
                                    name: name,
                                    width: width,
                                    roadProps: props
                                });
                                uniqueRoads.add(name);
                                
                                if (width >= 20) major++;
                                else if (width >= 15) secondary++;
                                else local++;
                            }
                        }
                    }
                });
            });
            
            return {
                points: points,
                stats: {
                    total: points.length,
                    major: major,
                    secondary: secondary,
                    local: local,
                    uniqueRoads: uniqueRoads.size
                }
            };
        }
        
        function zoomToDistrict() {
            if (!selectedDistrict) return;
            const coords = selectedDistrict.geometry.type === 'Polygon' ? 
                selectedDistrict.geometry.coordinates[0] : 
                selectedDistrict.geometry.coordinates[0][0];
            
            const lngs = coords.map(c => c[0]);
            const lats = coords.map(c => c[1]);
            const bounds = new google.maps.LatLngBounds(
                { lat: Math.min(...lats), lng: Math.min(...lngs) },
                { lat: Math.max(...lats), lng: Math.max(...lngs) }
            );
            map.fitBounds(bounds);
        }
        
        let renderPending = false;
        function render() {
            if (renderPending || !map) return;
            renderPending = true;
            requestAnimationFrame(doRender);
        }
        
        function doRender() {
            renderPending = false;
            if (!map) return;
            
            const bounds = map.getBounds();
            if (!bounds) return;
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const proj = map.getProjection();
            if (!proj) return;
            
            const zoom = map.getZoom();
            document.getElementById('zoomLevel').textContent = zoom.toFixed(1);
            
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const tr = proj.fromLatLngToPoint(ne);
            const bl = proj.fromLatLngToPoint(sw);
            const scale = Math.pow(2, zoom);
            
            const swLat = sw.lat(), neLat = ne.lat(), swLng = sw.lng(), neLng = ne.lng();
            
            const showApt = document.getElementById('showApt').checked;
            const showVilla = document.getElementById('showVilla').checked;
            const showOther = document.getElementById('showOther').checked;
            const showRoads = document.getElementById('showRoads').checked;
            const showEntryExit = document.getElementById('showEntryExit').checked;
            const showDistricts = document.getElementById('showDistricts').checked;
            const showLabels = document.getElementById('showLabels').checked;
            
            const aptSize = parseFloat(document.getElementById('aptSize').value);
            const villaSize = parseFloat(document.getElementById('villaSize').value);
            const roadWidthScale = parseFloat(document.getElementById('roadWidth').value);
            const entryExitSize = parseFloat(document.getElementById('entryExitSize').value);
            
            let viewApt = 0, viewVilla = 0, viewOther = 0;
            
            // Draw district boundaries
            if (showDistricts && districts.length) {
                districts.forEach(dist => {
                    const coords = dist.geometry.type === 'Polygon' ? 
                        dist.geometry.coordinates[0] : 
                        dist.geometry.coordinates[0][0];
                    
                    let inView = false;
                    for (const [lon, lat] of coords) {
                        if (lat >= swLat && lat <= neLat && lon >= swLng && lon <= neLng) {
                            inView = true;
                            break;
                        }
                    }
                    if (!inView) return;
                    
                    ctx.beginPath();
                    coords.forEach(([lon, lat], i) => {
                        const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lon));
                        const x = (w.x - bl.x) * scale;
                        const y = (w.y - tr.y) * scale;
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    });
                    ctx.closePath();
                    
                    const isSelected = selectedDistrict && dist.properties?.name_en === selectedDistrict.properties?.name_en;
                    ctx.fillStyle = isSelected ? 'rgba(156, 39, 176, 0.2)' : 'rgba(156, 39, 176, 0.05)';
                    ctx.fill();
                    ctx.strokeStyle = isSelected ? '#9c27b0' : 'rgba(156, 39, 176, 0.3)';
                    ctx.lineWidth = isSelected ? 3 : 1;
                    ctx.stroke();
                });
            }
            
            // Draw roads
            if (showRoads && roads.length) {
                const drawnLabels = new Set();
                
                roads.forEach(road => {
                    const geom = road.geometry;
                    if (!geom) return;
                    
                    const props = road.properties || {};
                    const width = parseFloat(props.width_m || props.WIDTH || 10);
                    const color = getRoadColor(width);
                    const lineWidth = Math.max(2, (zoom - 10) * roadWidthScale * (width / 12));
                    
                    ctx.strokeStyle = color;
                    ctx.lineWidth = lineWidth;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    const lines = geom.type === 'LineString' ? [geom.coordinates] : geom.coordinates;
                    
                    lines.forEach(coords => {
                        if (!coords || coords.length < 2) return;
                        
                        let inView = false;
                        for (const [lon, lat] of coords) {
                            if (lat >= swLat - 0.01 && lat <= neLat + 0.01 && lon >= swLng - 0.01 && lon <= neLng + 0.01) {
                                inView = true;
                                break;
                            }
                        }
                        if (!inView) return;
                        
                        ctx.beginPath();
                        let midX, midY;
                        const midIdx = Math.floor(coords.length / 2);
                        
                        coords.forEach(([lon, lat], i) => {
                            const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lon));
                            const x = (w.x - bl.x) * scale;
                            const y = (w.y - tr.y) * scale;
                            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                            if (i === midIdx) { midX = x; midY = y; }
                        });
                        ctx.stroke();
                        
                        // Draw labels
                        if (showLabels && width >= 15 && zoom >= 14 && midX && midY) {
                            const name = props.name_ar || props.ROADCENTERLINENAME_AR || '';
                            if (name && !drawnLabels.has(name)) {
                                drawnLabels.add(name);
                                ctx.font = '10px Arial';
                                ctx.fillStyle = '#333';
                                ctx.strokeStyle = 'white';
                                ctx.lineWidth = 3;
                                ctx.textAlign = 'center';
                                ctx.strokeText(name, midX, midY - 5);
                                ctx.fillText(name, midX, midY - 5);
                            }
                        }
                    });
                });
            }
            
            // Draw entry/exit points
            if (showEntryExit && entryExitPoints.length) {
                entryExitPoints.forEach(point => {
                    if (point.lat < swLat || point.lat > neLat || point.lng < swLng || point.lng > neLng) return;
                    
                    const w = proj.fromLatLngToPoint(new google.maps.LatLng(point.lat, point.lng));
                    const x = (w.x - bl.x) * scale;
                    const y = (w.y - tr.y) * scale;
                    
                    const size = entryExitSize * Math.min(1.5, point.width / 15);
                    
                    // Glow
                    ctx.beginPath();
                    ctx.arc(x, y, size + 4, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(233, 30, 99, 0.3)';
                    ctx.fill();
                    
                    // Marker
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fillStyle = '#e91e63';
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Label
                    if (zoom >= 14) {
                        ctx.font = 'bold 9px Arial';
                        ctx.fillStyle = '#333';
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.textAlign = 'center';
                        ctx.strokeText(point.width + 'm', x, y + size + 12);
                        ctx.fillText(point.width + 'm', x, y + size + 12);
                    }
                });
            }
            
            // Draw parcels
            const pi2 = Math.PI * 2;
            parcels.forEach(p => {
                if (p.lat < swLat || p.lat > neLat || p.lng < swLng || p.lng > neLng) return;
                
                const w = proj.fromLatLngToPoint(new google.maps.LatLng(p.lat, p.lng));
                const x = (w.x - bl.x) * scale;
                const y = (w.y - tr.y) * scale;
                
                if (p.type === 'apt' && showApt) {
                    ctx.fillStyle = 'rgba(33, 150, 243, 0.6)';
                    ctx.beginPath();
                    ctx.arc(x, y, aptSize, 0, pi2);
                    ctx.fill();
                    viewApt++;
                } else if (p.type === 'villa' && showVilla) {
                    ctx.fillStyle = 'rgba(76, 175, 80, 0.6)';
                    ctx.beginPath();
                    ctx.arc(x, y, villaSize, 0, pi2);
                    ctx.fill();
                    viewVilla++;
                } else if (p.type === 'other' && showOther) {
                    ctx.fillStyle = 'rgba(255, 152, 0, 0.4)';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, pi2);
                    ctx.fill();
                    viewOther++;
                }
            });
            
            // Update view stats
            const viewTotal = viewApt + viewVilla + viewOther;
            const villaPct = viewTotal > 0 ? (viewVilla / viewTotal * 100).toFixed(1) : 0;
            
            document.getElementById('viewApt').textContent = viewApt.toLocaleString();
            document.getElementById('viewVilla').textContent = viewVilla.toLocaleString();
            document.getElementById('viewOther').textContent = viewOther.toLocaleString();
            document.getElementById('viewTotal').textContent = viewTotal.toLocaleString();
            document.getElementById('viewVillaPct').textContent = villaPct + '%';
        }
        
        // File handlers
        document.getElementById('parcelsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split('\n');
                const headers = lines[0].toLowerCase().split(',');
                
                const latIdx = headers.findIndex(h => h.includes('lat'));
                const lngIdx = headers.findIndex(h => h.includes('lon') || h === 'lng');
                const typeIdx = headers.findIndex(h => h.includes('parcel_type'));
                
                parcels = [];
                let aptCount = 0, villaCount = 0, otherCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const lat = parseFloat(values[latIdx]);
                    const lng = parseFloat(values[lngIdx]);
                    if (isNaN(lat) || isNaN(lng)) continue;
                    
                    let type = 'other';
                    if (typeIdx >= 0) {
                        const t = (values[typeIdx] || '').trim().toLowerCase();
                        if (t === 'villa') type = 'villa';
                        else if (t === 'apartment') type = 'apt';
                    }
                    
                    parcels.push({ lat, lng, type });
                    if (type === 'apt') aptCount++;
                    else if (type === 'villa') villaCount++;
                    else otherCount++;
                }
                
                document.getElementById('parcelsStatus').innerHTML = 'Loaded: ' + parcels.length.toLocaleString() + ' parcels';
                document.getElementById('parcelsStatus').classList.add('loaded');
                document.getElementById('totalParcels').textContent = parcels.length.toLocaleString();
                document.getElementById('totalApt').textContent = aptCount.toLocaleString();
                document.getElementById('totalVilla').textContent = villaCount.toLocaleString();
                document.getElementById('totalOther').textContent = otherCount.toLocaleString();
                render();
            };
            reader.readAsText(file);
        });
        
        document.getElementById('roadsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    roads = data.features || [];
                    
                    let totalLength = 0;
                    roads.forEach(r => {
                        totalLength += parseFloat(r.properties?.length_m || r.properties?.LENGTH || 0);
                    });
                    
                    document.getElementById('roadsStatus').innerHTML = 'Loaded: ' + roads.length + ' roads (' + (totalLength/1000).toFixed(2) + ' km)';
                    document.getElementById('roadsStatus').classList.add('loaded');
                    document.getElementById('roadCount').textContent = roads.length;
                    document.getElementById('totalRoads').textContent = roads.length;
                    document.getElementById('roadLegend').classList.add('show');
                    
                    // If district selected, recalculate entry/exit
                    if (selectedDistrict) {
                        const result = calculateEntryExitForDistrict(selectedDistrict);
                        entryExitPoints = result.points;
                        updateDistrictEntryExitStats(result.stats);
                    }
                    
                    // Zoom to roads
                    if (roads.length > 0 && roads[0].geometry) {
                        const coords = roads[0].geometry.coordinates;
                        const c = coords[0] || coords;
                        if (c && c.length >= 2) {
                            map.setCenter({ lat: c[1], lng: c[0] });
                            map.setZoom(14);
                        }
                    }
                    
                    render();
                } catch (err) {
                    document.getElementById('roadsStatus').innerHTML = 'Error: ' + err.message;
                }
            };
            reader.readAsText(file);
        });
        
        document.getElementById('distFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    districts = data.features || [data];
                    document.getElementById('distStatus').innerHTML = 'Loaded: ' + districts.length + ' districts';
                    document.getElementById('distStatus').classList.add('loaded');
                    render();
                } catch (err) {
                    document.getElementById('distStatus').innerHTML = 'Error: ' + err.message;
                }
            };
            reader.readAsText(file);
        });
        
        function updateDistrictEntryExitStats(stats) {
            document.getElementById('distEntryExit').textContent = stats.total;
            document.getElementById('distMajorCrossings').textContent = stats.major;
            document.getElementById('distSecCrossings').textContent = stats.secondary;
            document.getElementById('distLocalCrossings').textContent = stats.local;
            document.getElementById('distUniqueRoads').textContent = stats.uniqueRoads;
            document.getElementById('entryExitCount').textContent = stats.total;
        }
        
        function showInfoPopup(x, y, title, content) {
            const popup = document.getElementById('infoPopup');
            document.getElementById('popupTitle').innerHTML = title;
            document.getElementById('popupContent').innerHTML = content;
            popup.style.left = Math.min(x + 15, window.innerWidth - 420) + 'px';
            popup.style.top = Math.min(y + 15, window.innerHeight - 300) + 'px';
            popup.classList.add('show');
        }
        
        function closeInfoPopup() {
            document.getElementById('infoPopup').classList.remove('show');
        }
        
        function selectDistrict(dist) {
            selectedDistrict = dist;
            const props = dist.properties || {};
            const nameAr = props.name_ar || props.DISTRICT_NAME_A || '';
            const nameEn = props.name_en || props.DISTRICT_NAME_E || '';
            
            document.getElementById('districtStatsTitle').textContent = 'DISTRICT: ' + (nameAr || nameEn);
            document.getElementById('districtStats').classList.add('active');
            
            // Count parcels in district
            const boundary = dist.geometry.type === 'Polygon' ? 
                dist.geometry.coordinates[0] : 
                dist.geometry.coordinates[0][0];
            
            let distApt = 0, distVilla = 0, distOther = 0;
            parcels.forEach(p => {
                if (pointInPolygon(p.lng, p.lat, boundary)) {
                    if (p.type === 'apt') distApt++;
                    else if (p.type === 'villa') distVilla++;
                    else distOther++;
                }
            });
            
            document.getElementById('distApt').textContent = distApt.toLocaleString();
            document.getElementById('distVilla').textContent = distVilla.toLocaleString();
            document.getElementById('distOther').textContent = distOther.toLocaleString();
            document.getElementById('distTotal').textContent = (distApt + distVilla + distOther).toLocaleString();
            
            // Count roads in district
            let roadCount = 0, totalLength = 0, majorRoads = 0;
            roads.forEach(road => {
                const geom = road.geometry;
                if (!geom) return;
                
                const coords = geom.type === 'LineString' ? geom.coordinates : geom.coordinates[0];
                if (!coords || coords.length < 1) return;
                
                // Check if road center is in district
                const midIdx = Math.floor(coords.length / 2);
                const [lng, lat] = coords[midIdx];
                
                if (pointInPolygon(lng, lat, boundary)) {
                    roadCount++;
                    const props = road.properties || {};
                    totalLength += parseFloat(props.length_m || props.LENGTH || 0);
                    if (parseFloat(props.width_m || props.WIDTH || 0) >= 20) majorRoads++;
                }
            });
            
            document.getElementById('distRoads').textContent = roadCount;
            document.getElementById('distRoadLength').textContent = (totalLength / 1000).toFixed(2) + ' km';
            document.getElementById('distMajorRoads').textContent = majorRoads;
            
            // Calculate entry/exit points
            const result = calculateEntryExitForDistrict(dist);
            entryExitPoints = result.points;
            updateDistrictEntryExitStats(result.stats);
            
            render();
        }
        
        function handleMapClick(e) {
            closeInfoPopup();
            
            const lat = e.latLng.lat();
            const lng = e.latLng.lng();
            const proj = map.getProjection();
            const zoom = map.getZoom();
            const scale = Math.pow(2, zoom);
            const clickPt = proj.fromLatLngToPoint(e.latLng);
            const tolerance = 15 / scale;
            
            // Check entry/exit points first
            for (const point of entryExitPoints) {
                const pt = proj.fromLatLngToPoint(new google.maps.LatLng(point.lat, point.lng));
                const dist = Math.sqrt((pt.x - clickPt.x) ** 2 + (pt.y - clickPt.y) ** 2);
                
                if (dist < tolerance * 2) {
                    showInfoPopup(e.pixel.x, e.pixel.y,
                        '<span class="type-badge" style="background:#e91e63;">Entry/Exit</span> Point',
                        '<div style="direction:rtl;text-align:right;font-size:14px;font-weight:bold;margin-bottom:8px;">' + point.name + '</div>' +
                        '<table>' +
                        '<tr><td>Road Width</td><td><b>' + point.width + 'm</b></td></tr>' +
                        '<tr><td>Type</td><td>' + (point.roadProps?.highway_type || point.roadProps?.category || '-') + '</td></tr>' +
                        '<tr><td>Location</td><td>' + point.lat.toFixed(5) + ', ' + point.lng.toFixed(5) + '</td></tr>' +
                        '</table>' +
                        '<div style="margin-top:8px;padding:8px;background:#fce4ec;border-radius:4px;font-size:10px;">' +
                        'This is where the road crosses the district boundary' +
                        '</div>'
                    );
                    return;
                }
            }
            
            // Check roads
            for (const road of roads) {
                const geom = road.geometry;
                if (!geom) continue;
                
                const lines = geom.type === 'LineString' ? [geom.coordinates] : geom.coordinates;
                
                for (const coords of lines) {
                    if (!coords || coords.length < 2) continue;
                    
                    for (let i = 0; i < coords.length - 1; i++) {
                        const [lon1, lat1] = coords[i];
                        const [lon2, lat2] = coords[i + 1];
                        
                        const pt1 = proj.fromLatLngToPoint(new google.maps.LatLng(lat1, lon1));
                        const pt2 = proj.fromLatLngToPoint(new google.maps.LatLng(lat2, lon2));
                        
                        const A = clickPt.x - pt1.x, B = clickPt.y - pt1.y;
                        const C = pt2.x - pt1.x, D = pt2.y - pt1.y;
                        const dot = A * C + B * D;
                        const lenSq = C * C + D * D;
                        let param = lenSq !== 0 ? dot / lenSq : -1;
                        
                        let xx, yy;
                        if (param < 0) { xx = pt1.x; yy = pt1.y; }
                        else if (param > 1) { xx = pt2.x; yy = pt2.y; }
                        else { xx = pt1.x + param * C; yy = pt1.y + param * D; }
                        
                        const dist = Math.sqrt((clickPt.x - xx) ** 2 + (clickPt.y - yy) ** 2);
                        
                        if (dist < tolerance * 2) {
                            const props = road.properties || {};
                            const width = props.width_m || props.WIDTH || '-';
                            const nameAr = props.name_ar || props.ROADCENTERLINENAME_AR || '-';
                            const nameEn = props.name_en || props.ROADCENTERLINENAME_EN || '';
                            const length = props.length_m || props.LENGTH || '-';
                            
                            showInfoPopup(e.pixel.x, e.pixel.y,
                                '<span class="type-badge" style="background:' + getRoadColor(parseFloat(width) || 10) + ';">Road</span> ' + width + 'm',
                                '<div style="direction:rtl;text-align:right;font-size:14px;font-weight:bold;margin-bottom:5px;">' + nameAr + '</div>' +
                                '<div style="color:#666;margin-bottom:8px;">' + nameEn + '</div>' +
                                '<table>' +
                                '<tr><td>Width</td><td><b>' + width + 'm</b></td></tr>' +
                                '<tr><td>Length</td><td>' + (typeof length === 'number' ? length.toFixed(0) + 'm' : length) + '</td></tr>' +
                                '<tr><td>Type</td><td>' + (props.highway_type || props.category || '-') + '</td></tr>' +
                                '<tr><td>Source</td><td>' + (props.source || 'Balady') + '</td></tr>' +
                                '</table>'
                            );
                            return;
                        }
                    }
                }
            }
            
            // Check districts
            for (const dist of districts) {
                const boundary = dist.geometry.type === 'Polygon' ? 
                    dist.geometry.coordinates[0] : 
                    dist.geometry.coordinates[0][0];
                
                if (pointInPolygon(lng, lat, boundary)) {
                    const props = dist.properties || {};
                    const nameAr = props.name_ar || props.DISTRICT_NAME_A || '';
                    const nameEn = props.name_en || props.DISTRICT_NAME_E || '';
                    
                    // Calculate quick stats
                    let distParcels = 0, distRoads = 0;
                    parcels.forEach(p => {
                        if (pointInPolygon(p.lng, p.lat, boundary)) distParcels++;
                    });
                    roads.forEach(r => {
                        const geom = r.geometry;
                        if (!geom) return;
                        const coords = geom.type === 'LineString' ? geom.coordinates : geom.coordinates[0];
                        if (coords && coords.length > 0) {
                            const midIdx = Math.floor(coords.length / 2);
                            if (pointInPolygon(coords[midIdx][0], coords[midIdx][1], boundary)) distRoads++;
                        }
                    });
                    
                    // Calculate entry/exit
                    const entryExit = calculateEntryExitForDistrict(dist);
                    
                    showInfoPopup(e.pixel.x, e.pixel.y,
                        '<span class="type-badge" style="background:#9c27b0;">District</span>',
                        '<div style="direction:rtl;text-align:right;font-size:16px;font-weight:bold;margin-bottom:5px;">' + nameAr + '</div>' +
                        '<div style="color:#666;margin-bottom:10px;">' + nameEn + '</div>' +
                        '<table>' +
                        '<tr><td>Total Parcels</td><td><b>' + distParcels.toLocaleString() + '</b></td></tr>' +
                        '<tr><td>Total Roads</td><td><b>' + distRoads + '</b></td></tr>' +
                        '</table>' +
                        '<div style="margin-top:10px;padding:10px;background:#fce4ec;border-radius:6px;">' +
                        '<div style="font-weight:bold;color:#c2185b;margin-bottom:5px;">ENTRY/EXIT POINTS</div>' +
                        '<table style="width:100%;">' +
                        '<tr><td>Total Crossings</td><td><b style="font-size:14px;">' + entryExit.stats.total + '</b></td></tr>' +
                        '<tr><td>Major (20m+)</td><td>' + entryExit.stats.major + '</td></tr>' +
                        '<tr><td>Secondary (15-20m)</td><td>' + entryExit.stats.secondary + '</td></tr>' +
                        '<tr><td>Local (<15m)</td><td>' + entryExit.stats.local + '</td></tr>' +
                        '<tr><td>Unique Roads</td><td>' + entryExit.stats.uniqueRoads + '</td></tr>' +
                        '</table>' +
                        '</div>' +
                        '<button class="btn btn-primary" onclick="selectDistrict(districts.find(d=>d.properties?.name_en===\'' + nameEn + '\'))" style="margin-top:10px;">Select This District</button>'
                    );
                    return;
                }
            }
        }
        
        function initMap() {
            if (map) return;
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 24.7136, lng: 46.6753 },
                zoom: 11,
                mapTypeControl: true,
                gestureHandling: 'greedy'
            });
            
            map.addListener('idle', render);
            map.addListener('click', handleMapClick);
            window.addEventListener('resize', render);
            
            console.log('Map ready. Upload your data files.');
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForGoogleMaps);
        } else {
            waitForGoogleMaps();
        }
    </script>
    <script src="https://somanchiu.github.io/Keyless-Google-Maps-API/mapsJavaScriptAPI.js" async defer></script>
</body>
</html>
