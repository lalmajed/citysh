<!DOCTYPE html>
<html>
<head>
    <title>Riyadh Map - Dynamic Counts</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
        
        .panel {
            position: absolute; top: 10px; left: 10px;
            background: white; padding: 12px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); z-index: 1000;
            max-width: 380px; max-height: 95vh; overflow-y: auto; font-size: 12px;
        }
        .panel h2 { color: #1a73e8; margin-bottom: 8px; font-size: 15px; }
        
        .section { margin: 8px 0; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .section-header {
            background: #f5f5f5; padding: 8px 10px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600; font-size: 12px;
        }
        .section-header:hover { background: #e8e8e8; }
        .section-content { padding: 8px; display: none; }
        .section-content.open { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin: 8px 0; }
        .stat-box { padding: 8px; border-radius: 6px; text-align: center; color: white; }
        .stat-box .num { font-size: 1.2em; font-weight: bold; }
        .stat-box .lbl { font-size: 9px; opacity: 0.9; }
        .stat-box.apt { background: #2196F3; }
        .stat-box.villa { background: #4CAF50; }
        .stat-box.other { background: #FF9800; }
        .stat-box.poi { background: #9C27B0; }
        
        .dynamic-stats { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 10px; margin: 8px 0; }
        .dynamic-stats h3 { color: #2e7d32; font-size: 13px; margin-bottom: 8px; }
        .dynamic-stats .row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .dynamic-stats .row.total { font-weight: bold; border-top: 1px solid #a5d6a7; padding-top: 5px; margin-top: 5px; }
        
        .district-stats { background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 10px; margin: 8px 0; display: none; }
        .district-stats.active { display: block; }
        .district-stats h3 { color: #e65100; font-size: 13px; margin-bottom: 8px; }
        .district-stats .row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .district-stats .row.total { font-weight: bold; border-top: 1px solid #ffcc80; padding-top: 5px; margin-top: 5px; }
        
        .layer-control { padding: 8px; margin: 5px 0; background: #f9f9f9; border-radius: 6px; }
        .layer-control .header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .layer-control .dot { width: 14px; height: 14px; border-radius: 50%; }
        .layer-control .name { font-weight: 600; flex: 1; }
        .layer-control .count { font-size: 10px; color: #666; }
        .layer-control input[type="range"] { width: 100%; margin: 2px 0; }
        
        .btn { padding: 8px 12px; margin: 3px 0; cursor: pointer; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; width: 100%; }
        .btn-primary { background: #1a73e8; color: white; border: none; }
        .btn-success { background: #28a745; color: white; border: none; }
        
        .file-input { margin: 5px 0; }
        .file-input label { display: block; font-weight: 600; font-size: 10px; margin-bottom: 2px; }
        .file-input input[type="file"] { font-size: 9px; width: 100%; }
        .file-status { font-size: 9px; color: #666; }
        .file-status.loaded { color: #28a745; font-weight: bold; }
        
        .info-popup {
            position: absolute; background: white; padding: 12px 15px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 2000; min-width: 280px; max-width: 350px;
            font-size: 12px; display: none; border-left: 4px solid #1a73e8;
        }
        .info-popup.show { display: block; }
        .info-popup h3 { margin: 0 0 8px 0; color: #1a73e8; font-size: 14px; }
        .info-popup .close { position: absolute; top: 5px; right: 8px; cursor: pointer; color: #999; font-size: 18px; }
        .info-popup table { width: 100%; border-collapse: collapse; }
        .info-popup td { padding: 4px 5px; border-bottom: 1px solid #eee; font-size: 11px; }
        .info-popup td:first-child { font-weight: 600; color: #555; width: 35%; }
        .type-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; color: white; font-size: 10px; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="infoPopup" class="info-popup">
        <span class="close" onclick="closeInfoPopup()">&times;</span>
        <h3 id="popupTitle">Details</h3>
        <div id="popupContent"></div>
    </div>
    
    <div class="panel">
        <h2>Riyadh Map - Dynamic Counts</h2>
        
        <div class="stats-grid">
            <div class="stat-box" style="background:#9c27b0;"><div class="num" id="totalBldg">0</div><div class="lbl">Buildings</div></div>
            <div class="stat-box apt"><div class="num" id="totalApt">0</div><div class="lbl">Apartments</div></div>
            <div class="stat-box villa"><div class="num" id="totalVilla">0</div><div class="lbl">Villas</div></div>
            <div class="stat-box other"><div class="num" id="totalOther">0</div><div class="lbl">Other</div></div>
        </div>
        <div style="text-align:center; font-size:11px; color:#666; margin-bottom:8px;">
            Total Parcels: <b id="totalParcels">0</b> | POIs: <b id="totalPoi">0</b> | Roads: <b id="totalRoads">0</b>
        </div>
        
        <div class="district-stats" id="districtStats">
            <h3 id="districtStatsTitle">DISTRICT: None</h3>
            <div class="row" style="color:#9c27b0;"><span>Buildings:</span><span id="distBldg">0</span></div>
            <div class="row" style="color:#2196F3;"><span>Apartments:</span><span id="distApt">0</span></div>
            <div class="row" style="color:#4CAF50;"><span>Villas:</span><span id="distVilla">0</span></div>
            <div class="row" style="color:#FF9800;"><span>Other:</span><span id="distOther">0</span></div>
            <div class="row total"><span>Total Parcels:</span><span id="distTotal">0</span></div>
            <div class="row"><span>POIs:</span><span id="distPoi">0</span></div>
            <div class="row total" style="color:#4CAF50;"><span>Villa %:</span><span id="distVillaPct">0%</span></div>
            <div class="row total" style="color:#2196F3;"><span>Apt %:</span><span id="distAptPct">0%</span></div>
            <div style="border-top:2px solid #2196F3;margin-top:8px;padding-top:8px;">
                <div class="row" style="color:#2196F3;font-weight:bold;"><span>ROADS</span><span></span></div>
                <div class="row"><span>Total Roads:</span><span id="distRoads">0</span></div>
                <div class="row"><span>Total Length:</span><span id="distRoadLength">0 km</span></div>
                <div class="row"><span>Major (20m+):</span><span id="distMajorRoads">0</span></div>
                <div class="row"><span>Entry/Exit Points:</span><span id="distEntryExit">~0</span></div>
            </div>
        </div>
        
        <div class="dynamic-stats">
            <h3>IN CURRENT VIEW</h3>
            <div class="row" style="color:#9c27b0;"><span>Buildings:</span><span id="viewBldg">0</span></div>
            <div class="row" style="color:#2196F3;"><span>Apartments:</span><span id="viewApt">0</span></div>
            <div class="row" style="color:#4CAF50;"><span>Villas:</span><span id="viewVilla">0</span></div>
            <div class="row" style="color:#FF9800;"><span>Other:</span><span id="viewOther">0</span></div>
            <div class="row total"><span>Total Parcels:</span><span id="viewTotal">0</span></div>
            <div class="row"><span>POIs:</span><span id="viewPoi">0</span></div>
            <div class="row total" style="color:#4CAF50;"><span>Villa %:</span><span id="viewVillaPct">0%</span></div>
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                LAYERS <span>[+]</span>
            </div>
            <div class="section-content open">
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showApt" checked onchange="updateLayers()">
                        <div class="dot" style="background:#2196F3;"></div>
                        <span class="name">Apartments</span>
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showVilla" checked onchange="updateLayers()">
                        <div class="dot" style="background:#4CAF50;"></div>
                        <span class="name">Villas</span>
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showOther" checked onchange="updateLayers()">
                        <div class="dot" style="background:#FF9800;"></div>
                        <span class="name">Other Parcels</span>
                    </div>
                </div>
                <div class="layer-control" style="background:#e3f2fd;">
                    <div class="header">
                        <input type="checkbox" id="showRoads" checked onchange="updateLayers()">
                        <div class="dot" style="background:#d32f2f;"></div>
                        <span class="name">Roads</span>
                        <span class="count" id="roadCount">0</span>
                    </div>
                </div>
                <div class="layer-control">
                    <div class="header">
                        <input type="checkbox" id="showDistricts" checked onchange="updateLayers()">
                        <div class="dot" style="background:#607D8B;"></div>
                        <span class="name">Districts</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                DATA FILES <span>[+]</span>
            </div>
            <div class="section-content open">
                <div class="file-input">
                    <label>Parcels CSV:</label>
                    <input type="file" id="parcelsFile" accept=".csv">
                    <div id="parcelsStatus" class="file-status">Upload parcels CSV</div>
                </div>
                <div class="file-input">
                    <label>POI CSV:</label>
                    <input type="file" id="poiFile" accept=".csv">
                    <div id="poiStatus" class="file-status">Upload POI CSV</div>
                </div>
                <div class="file-input">
                    <label>Districts GeoJSON:</label>
                    <input type="file" id="distFile" accept=".json,.geojson">
                    <div id="distStatus" class="file-status">Upload districts GeoJSON</div>
                </div>
                <div class="file-input" style="background:#e3f2fd;padding:8px;border-radius:6px;margin-top:8px;">
                    <label>Roads GeoJSON:</label>
                    <input type="file" id="roadsFile" accept=".json,.geojson">
                    <div id="roadsStatus" class="file-status">Upload roads GeoJSON</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                DISTRICTS <span>[+]</span>
            </div>
            <div class="section-content">
                <input type="text" style="width:100%;padding:5px;margin-bottom:5px;border:1px solid #ddd;border-radius:4px;font-size:11px;" id="districtSearch" placeholder="Search districts..." oninput="filterDistricts()">
                <button class="btn" onclick="clearDistrictSelection()">Clear Selection</button>
                <div id="districtList" style="max-height:120px;overflow-y:auto;margin-top:5px;"></div>
            </div>
        </div>
        
        <div id="roadLegend" style="display:none;margin-top:10px;padding:8px;background:#e3f2fd;border-radius:6px;">
            <div style="font-weight:600;font-size:11px;margin-bottom:5px;">Road Width Legend</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;font-size:9px;">
                <div><span style="display:inline-block;width:20px;height:4px;background:#d32f2f;border-radius:2px;"></span> 36m+</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#ff5722;border-radius:2px;"></span> 30m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#ff9800;border-radius:2px;"></span> 25m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#ffc107;border-radius:2px;"></span> 20m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#8bc34a;border-radius:2px;"></span> 15m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#4caf50;border-radius:2px;"></span> 12m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#009688;border-radius:2px;"></span> 10m</div>
                <div><span style="display:inline-block;width:20px;height:4px;background:#607d8b;border-radius:2px;"></span> 8m</div>
            </div>
        </div>
        
        <div style="margin-top:8px;font-size:9px;color:#888;text-align:center;">
            Zoom: <span id="zoomLevel">11</span> | <a href="#" onclick="resetView();return false;">Reset View</a>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([24.7136, 46.6753], 11);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Data arrays
        let parcels = [];
        let poiData = [];
        let districts = [];
        let roads = [];
        
        // Layer groups
        let parcelLayers = { apt: L.layerGroup(), villa: L.layerGroup(), other: L.layerGroup() };
        let roadsLayer = L.layerGroup().addTo(map);
        let districtsLayer = L.layerGroup().addTo(map);
        let poiLayer = L.layerGroup().addTo(map);
        
        let selectedDistrict = null;
        let selectedDistrictLayer = null;
        
        // Road color by width
        function getRoadColor(width) {
            if (width >= 36) return '#d32f2f';
            if (width >= 30) return '#ff5722';
            if (width >= 25) return '#ff9800';
            if (width >= 20) return '#ffc107';
            if (width >= 15) return '#8bc34a';
            if (width >= 12) return '#4caf50';
            if (width >= 10) return '#009688';
            return '#607d8b';
        }
        
        function getRoadWeight(width) {
            if (width >= 30) return 6;
            if (width >= 20) return 5;
            if (width >= 15) return 4;
            return 3;
        }
        
        function toggleSection(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            header.querySelector('span').textContent = content.classList.contains('open') ? '[-]' : '[+]';
        }
        
        function resetView() {
            map.setView([24.7136, 46.6753], 11);
        }
        
        // Update zoom display
        map.on('zoomend moveend', function() {
            document.getElementById('zoomLevel').textContent = map.getZoom().toFixed(1);
            updateViewStats();
        });
        
        function updateViewStats() {
            const bounds = map.getBounds();
            let viewApt = 0, viewVilla = 0, viewOther = 0, viewPoi = 0;
            
            parcels.forEach(p => {
                if (bounds.contains([p.lat, p.lng])) {
                    if (p.type === 'apt') viewApt++;
                    else if (p.type === 'villa') viewVilla++;
                    else viewOther++;
                }
            });
            
            poiData.forEach(p => {
                if (bounds.contains([p.lat, p.lng])) viewPoi++;
            });
            
            const viewTotal = viewApt + viewVilla + viewOther;
            const villaPct = viewTotal > 0 ? (viewVilla / viewTotal * 100).toFixed(1) : 0;
            
            document.getElementById('viewApt').textContent = viewApt.toLocaleString();
            document.getElementById('viewVilla').textContent = viewVilla.toLocaleString();
            document.getElementById('viewOther').textContent = viewOther.toLocaleString();
            document.getElementById('viewTotal').textContent = viewTotal.toLocaleString();
            document.getElementById('viewPoi').textContent = viewPoi.toLocaleString();
            document.getElementById('viewVillaPct').textContent = villaPct + '%';
        }
        
        function updateLayers() {
            if (document.getElementById('showApt').checked) {
                map.addLayer(parcelLayers.apt);
            } else {
                map.removeLayer(parcelLayers.apt);
            }
            if (document.getElementById('showVilla').checked) {
                map.addLayer(parcelLayers.villa);
            } else {
                map.removeLayer(parcelLayers.villa);
            }
            if (document.getElementById('showOther').checked) {
                map.addLayer(parcelLayers.other);
            } else {
                map.removeLayer(parcelLayers.other);
            }
            if (document.getElementById('showRoads').checked) {
                map.addLayer(roadsLayer);
            } else {
                map.removeLayer(roadsLayer);
            }
            if (document.getElementById('showDistricts').checked) {
                map.addLayer(districtsLayer);
            } else {
                map.removeLayer(districtsLayer);
            }
        }
        
        // File handlers
        document.getElementById('parcelsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const lines = evt.target.result.split('\n');
                const headers = lines[0].toLowerCase().split(',');
                
                const latIdx = headers.findIndex(h => h.includes('lat'));
                const lngIdx = headers.findIndex(h => h.includes('lon') || h === 'lng');
                const typeIdx = headers.findIndex(h => h.includes('parcel_type'));
                
                parcels = [];
                let aptCount = 0, villaCount = 0, otherCount = 0;
                
                // Clear existing layers
                parcelLayers.apt.clearLayers();
                parcelLayers.villa.clearLayers();
                parcelLayers.other.clearLayers();
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const lat = parseFloat(values[latIdx]);
                    const lng = parseFloat(values[lngIdx]);
                    if (isNaN(lat) || isNaN(lng)) continue;
                    
                    let type = 'other';
                    if (typeIdx >= 0) {
                        const t = (values[typeIdx] || '').trim().toLowerCase();
                        if (t === 'villa') type = 'villa';
                        else if (t === 'apartment') type = 'apt';
                    }
                    
                    parcels.push({ lat, lng, type });
                    
                    const color = type === 'apt' ? '#2196F3' : type === 'villa' ? '#4CAF50' : '#FF9800';
                    const marker = L.circleMarker([lat, lng], {
                        radius: 4,
                        fillColor: color,
                        color: color,
                        weight: 1,
                        fillOpacity: 0.6
                    });
                    
                    marker.bindPopup(`<b>${type.charAt(0).toUpperCase() + type.slice(1)}</b><br>Location: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
                    parcelLayers[type].addLayer(marker);
                    
                    if (type === 'apt') aptCount++;
                    else if (type === 'villa') villaCount++;
                    else otherCount++;
                }
                
                // Add layers to map
                map.addLayer(parcelLayers.apt);
                map.addLayer(parcelLayers.villa);
                map.addLayer(parcelLayers.other);
                
                document.getElementById('parcelsStatus').innerHTML = `OK: ${parcels.length.toLocaleString()} parcels`;
                document.getElementById('parcelsStatus').classList.add('loaded');
                document.getElementById('totalParcels').textContent = parcels.length.toLocaleString();
                document.getElementById('totalApt').textContent = aptCount.toLocaleString();
                document.getElementById('totalVilla').textContent = villaCount.toLocaleString();
                document.getElementById('totalOther').textContent = otherCount.toLocaleString();
                
                updateViewStats();
            };
            reader.readAsText(file);
        });
        
        document.getElementById('roadsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    roads = data.features || [];
                    
                    roadsLayer.clearLayers();
                    let totalLength = 0;
                    
                    roads.forEach(road => {
                        const props = road.properties || {};
                        const width = parseFloat(props.width_m || props.WIDTH || 10);
                        const length = parseFloat(props.length_m || props.LENGTH || 0);
                        totalLength += length;
                        
                        const color = getRoadColor(width);
                        const weight = getRoadWeight(width);
                        
                        const layer = L.geoJSON(road, {
                            style: {
                                color: color,
                                weight: weight,
                                opacity: 0.8
                            }
                        });
                        
                        const nameAr = props.name_ar || props.ROADCENTERLINENAME_AR || 'Unknown';
                        const nameEn = props.name_en || props.ROADCENTERLINENAME_EN || '';
                        
                        layer.bindPopup(`
                            <div style="direction:rtl;text-align:right;font-weight:bold;font-size:14px;">${nameAr}</div>
                            <div style="color:#666;margin-bottom:8px;">${nameEn}</div>
                            <table style="width:100%;font-size:11px;">
                                <tr><td><b>Width:</b></td><td>${width}m</td></tr>
                                <tr><td><b>Length:</b></td><td>${length.toFixed(0)}m</td></tr>
                                <tr><td><b>Lanes:</b></td><td>${props.num_lanes || props.NOOFLANES || '-'}</td></tr>
                                <tr><td><b>Paved:</b></td><td>${props.paved || props.PAVED || '-'}</td></tr>
                                <tr><td><b>Category:</b></td><td>${props.category || '-'}</td></tr>
                                <tr><td><b>Source:</b></td><td>${props.source || 'Balady'}</td></tr>
                            </table>
                        `);
                        
                        roadsLayer.addLayer(layer);
                    });
                    
                    document.getElementById('roadsStatus').innerHTML = `OK: ${roads.length} roads (${(totalLength/1000).toFixed(2)} km)`;
                    document.getElementById('roadsStatus').classList.add('loaded');
                    document.getElementById('roadCount').textContent = roads.length;
                    document.getElementById('totalRoads').textContent = roads.length;
                    document.getElementById('roadLegend').style.display = 'block';
                    
                    // Zoom to roads
                    if (roads.length > 0) {
                        const bounds = roadsLayer.getBounds();
                        if (bounds.isValid()) {
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    }
                } catch (err) {
                    document.getElementById('roadsStatus').innerHTML = `Error: ${err.message}`;
                }
            };
            reader.readAsText(file);
        });
        
        document.getElementById('distFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    districts = data.features || data;
                    
                    districtsLayer.clearLayers();
                    
                    districts.forEach((d, idx) => {
                        const name = d.properties?.name || d.properties?.NAME || d.properties?.name_en || `District ${idx + 1}`;
                        
                        const layer = L.geoJSON(d, {
                            style: {
                                color: '#607D8B',
                                weight: 2,
                                fillColor: '#607D8B',
                                fillOpacity: 0.1
                            }
                        });
                        
                        layer.on('click', function() {
                            selectDistrict(name, d);
                        });
                        
                        layer.bindTooltip(name, { permanent: false, direction: 'center' });
                        districtsLayer.addLayer(layer);
                    });
                    
                    document.getElementById('distStatus').innerHTML = `OK: ${districts.length} districts`;
                    document.getElementById('distStatus').classList.add('loaded');
                    updateDistrictList();
                } catch (err) {
                    document.getElementById('distStatus').innerHTML = `Error: ${err.message}`;
                }
            };
            reader.readAsText(file);
        });
        
        function getDistrictName(d) {
            if (d.properties) {
                return d.properties.name || d.properties.NAME || d.properties.name_en || d.properties.name_ar || 'Unknown';
            }
            return 'Unknown';
        }
        
        function updateDistrictList() {
            const search = document.getElementById('districtSearch').value.toLowerCase();
            const container = document.getElementById('districtList');
            container.innerHTML = '';
            
            districts.forEach((d, idx) => {
                const name = getDistrictName(d);
                if (search && !name.toLowerCase().includes(search)) return;
                
                const div = document.createElement('div');
                div.style.cssText = 'padding:4px 8px;margin:2px 0;background:#f5f5f5;border-radius:4px;cursor:pointer;font-size:10px;';
                if (selectedDistrict === name) div.style.background = '#1a73e8';
                if (selectedDistrict === name) div.style.color = 'white';
                div.textContent = name;
                div.onclick = () => selectDistrict(name, d);
                container.appendChild(div);
            });
        }
        
        function filterDistricts() {
            updateDistrictList();
        }
        
        function selectDistrict(name, districtData) {
            selectedDistrict = name;
            updateDistrictList();
            
            // Highlight district
            if (selectedDistrictLayer) {
                map.removeLayer(selectedDistrictLayer);
            }
            
            selectedDistrictLayer = L.geoJSON(districtData, {
                style: {
                    color: '#FF5722',
                    weight: 4,
                    fillColor: '#FF5722',
                    fillOpacity: 0.2
                }
            }).addTo(map);
            
            // Zoom to district
            const bounds = selectedDistrictLayer.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Calculate stats
            calculateDistrictStats(districtData);
        }
        
        function clearDistrictSelection() {
            selectedDistrict = null;
            if (selectedDistrictLayer) {
                map.removeLayer(selectedDistrictLayer);
                selectedDistrictLayer = null;
            }
            document.getElementById('districtStats').classList.remove('active');
            updateDistrictList();
            resetView();
        }
        
        function pointInPolygon(lat, lng, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const [xi, yi] = polygon[i];
                const [xj, yj] = polygon[j];
                if (((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }
        
        function calculateDistrictStats(districtData) {
            const geom = districtData.geometry;
            if (!geom) return;
            
            const coords = geom.type === 'Polygon' ? geom.coordinates[0] : 
                           geom.type === 'MultiPolygon' ? geom.coordinates[0][0] : null;
            if (!coords) return;
            
            const poly = coords.map(([lon, lat]) => [lon, lat]);
            
            let apt = 0, villa = 0, other = 0, poi = 0;
            
            parcels.forEach(p => {
                if (pointInPolygon(p.lat, p.lng, poly)) {
                    if (p.type === 'apt') apt++;
                    else if (p.type === 'villa') villa++;
                    else other++;
                }
            });
            
            poiData.forEach(p => {
                if (pointInPolygon(p.lat, p.lng, poly)) poi++;
            });
            
            // Road stats
            let roadCount = 0, totalLength = 0, majorRoads = 0;
            const uniqueRoads = new Set();
            
            roads.forEach(road => {
                const roadGeom = road.geometry;
                if (!roadGeom) return;
                
                const props = road.properties || {};
                const width = parseFloat(props.width_m || props.WIDTH || 0);
                const length = parseFloat(props.length_m || props.LENGTH || 0);
                const nameAr = props.name_ar || props.ROADCENTERLINENAME_AR || '';
                
                const lines = roadGeom.type === 'LineString' ? [roadGeom.coordinates] : roadGeom.coordinates;
                
                for (const lineCoords of lines) {
                    for (const [lon, lat] of lineCoords) {
                        if (pointInPolygon(lat, lon, poly)) {
                            roadCount++;
                            totalLength += length;
                            if (width >= 20) majorRoads++;
                            if (nameAr) uniqueRoads.add(nameAr);
                            break;
                        }
                    }
                }
            });
            
            const total = apt + villa + other;
            const villaPct = total > 0 ? (villa / total * 100).toFixed(1) : 0;
            const aptPct = total > 0 ? (apt / total * 100).toFixed(1) : 0;
            
            document.getElementById('districtStatsTitle').textContent = 'DISTRICT: ' + selectedDistrict;
            document.getElementById('distApt').textContent = apt.toLocaleString();
            document.getElementById('distVilla').textContent = villa.toLocaleString();
            document.getElementById('distOther').textContent = other.toLocaleString();
            document.getElementById('distTotal').textContent = total.toLocaleString();
            document.getElementById('distPoi').textContent = poi.toLocaleString();
            document.getElementById('distVillaPct').textContent = villaPct + '%';
            document.getElementById('distAptPct').textContent = aptPct + '%';
            document.getElementById('distRoads').textContent = roadCount.toLocaleString();
            document.getElementById('distRoadLength').textContent = (totalLength / 1000).toFixed(2) + ' km';
            document.getElementById('distMajorRoads').textContent = majorRoads.toLocaleString();
            document.getElementById('distEntryExit').textContent = '~' + (uniqueRoads.size * 2);
            
            document.getElementById('districtStats').classList.add('active');
        }
        
        function showInfoPopup(x, y, title, content) {
            const popup = document.getElementById('infoPopup');
            document.getElementById('popupTitle').innerHTML = title;
            document.getElementById('popupContent').innerHTML = content;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            popup.classList.add('show');
        }
        
        function closeInfoPopup() {
            document.getElementById('infoPopup').classList.remove('show');
        }
        
        console.log('Map ready. Upload your data files.');
    </script>
</body>
</html>
