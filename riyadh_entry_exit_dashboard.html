<!DOCTYPE html>
<html>
<head>
    <title>Entry/Exit Dashboard</title>
    <meta charset="utf-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; }
        
        #sidebar {
            position: fixed; left: 0; top: 0; width: 300px; height: 100vh;
            background: rgba(22, 33, 62, 0.97); padding: 12px; overflow-y: auto; z-index: 1000; color: white;
        }
        
        h1 { font-size: 14px; color: #e94560; margin-bottom: 10px; }
        h3 { font-size: 10px; background: #e94560; padding: 4px 8px; margin: 10px 0 6px 0; border-radius: 3px; }
        
        .box { background: #0f3460; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .box-title { font-size: 11px; font-weight: bold; margin-bottom: 6px; }
        .box input[type="file"] { width: 100%; padding: 6px; background: #1a1a2e; border: 1px dashed #e94560; color: white; border-radius: 3px; font-size: 10px; }
        .status { font-size: 10px; color: #4caf50; margin-top: 4px; }
        .status.wait { color: #666; }
        
        .slider-row { margin: 8px 0; }
        .slider-row label { font-size: 11px; display: block; margin-bottom: 4px; }
        .slider-row input { width: 100%; }
        .slider-row .val { float: right; color: #e94560; font-weight: bold; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .stat { background: #0f3460; padding: 8px; border-radius: 4px; text-align: center; }
        .stat .n { font-size: 20px; font-weight: bold; color: #e94560; }
        .stat .l { font-size: 9px; color: #888; }
        .stat.main { grid-column: span 2; background: #e94560; }
        .stat.main .n { color: white; font-size: 26px; }
        .stat.main .l { color: #fcc; }
        
        button { width: 100%; padding: 10px; background: #e94560; border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 3px 0; }
        button:disabled { background: #444; }
        
        .list { max-height: 130px; overflow-y: auto; font-size: 10px; }
        .item { display: flex; align-items: center; padding: 4px; background: #0f3460; margin: 2px 0; border-radius: 3px; cursor: pointer; }
        .item:hover { background: #1a4a7a; }
        .item .dot { width: 20px; height: 20px; background: #e94560; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; margin-right: 6px; border: 2px solid white; }
        .item .name { flex: 1; direction: rtl; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 10px; }
        
        #mapContainer { position: fixed; left: 300px; top: 0; right: 0; bottom: 0; }
        #map { width: 100%; height: 100%; }
        #overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 100; }
        
        #loadingOverlay {
            position: fixed; left: 300px; top: 0; right: 0; bottom: 0;
            background: #1a1a2e; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 500;
        }
        #loadingOverlay.hidden { display: none; }
        .loader { width: 60px; height: 60px; border: 5px solid #333; border-top-color: #e94560; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loadingText { color: #e94560; margin-top: 20px; font-size: 16px; }
        #loadingAttempt { color: #888; margin-top: 10px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h1>Entry/Exit Point Finder</h1>
        
        <div class="box">
            <div class="box-title">1. Load Roads GeoJSON</div>
            <input type="file" id="fileRoads" accept=".geojson,.json">
            <div class="status wait" id="statusRoads">No roads loaded</div>
        </div>
        
        <div class="box">
            <div class="box-title">2. Load District Boundary</div>
            <input type="file" id="fileDistrict" accept=".geojson,.json">
            <div class="status wait" id="statusDistrict">No district loaded</div>
        </div>
        
        <h3>EXTEND ROADS</h3>
        <div class="box">
            <div class="slider-row">
                <label>Road Extension <span class="val" id="valExt">300m</span></label>
                <input type="range" id="sliderExt" min="0" max="1500" value="300" step="50">
            </div>
            <div style="font-size:9px;color:#888;">Make roads longer to find boundary crossings</div>
        </div>
        
        <div class="box">
            <div class="slider-row">
                <label>Min Road Width <span class="val" id="valWidth">10m</span></label>
                <input type="range" id="sliderWidth" min="0" max="40" value="10" step="2">
            </div>
            <div class="slider-row">
                <label>Dot Size <span class="val" id="valDot">15</span></label>
                <input type="range" id="sliderDot" min="8" max="30" value="15">
            </div>
        </div>
        
        <h3>RESULTS</h3>
        <div class="stats">
            <div class="stat main"><div class="n" id="sTotal">0</div><div class="l">ENTRY/EXIT POINTS</div></div>
            <div class="stat"><div class="n" id="sMajor">0</div><div class="l">Major 30m+</div></div>
            <div class="stat"><div class="n" id="sOther">0</div><div class="l">Other</div></div>
        </div>
        
        <h3>EXPORT</h3>
        <button id="btnExport" onclick="exportData()" disabled>Download GeoJSON</button>
        
        <h3>LIST</h3>
        <div class="list" id="list"><div style="color:#666;text-align:center;padding:15px;">Load data</div></div>
    </div>
    
    <div id="loadingOverlay">
        <div class="loader"></div>
        <div id="loadingText">Loading Google Maps Keyless...</div>
        <div id="loadingAttempt">Please wait...</div>
    </div>
    
    <div id="mapContainer">
        <div id="map"></div>
        <canvas id="overlay"></canvas>
    </div>

<script>
var map, roads = [], boundary = [], entryExits = [], mapReady = false;
var canvas = document.getElementById('overlay');
var ctx = canvas.getContext('2d');

// Wait for Google Maps with multiple attempts
var attempt = 0;
var maxAttempts = 300; // 30 seconds

function waitForGoogleMaps() {
    attempt++;
    document.getElementById('loadingAttempt').textContent = 'Attempt ' + attempt + '/' + maxAttempts;
    
    if (window.google && window.google.maps && window.google.maps.Map) {
        console.log('Google Maps loaded after ' + attempt + ' attempts');
        initializeMap();
    } else if (attempt < maxAttempts) {
        setTimeout(waitForGoogleMaps, 100);
    } else {
        document.getElementById('loadingText').textContent = 'Loading taking longer than expected...';
        document.getElementById('loadingAttempt').textContent = 'Still trying... Please wait or refresh';
        setTimeout(waitForGoogleMaps, 100);
    }
}

function initializeMap() {
    try {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 24.73, lng: 46.65 },
            zoom: 14,
            gestureHandling: 'greedy',
            zoomControl: true,
            mapTypeControl: true,
            scaleControl: true,
            streetViewControl: false,
            rotateControl: false,
            fullscreenControl: true
        });
        
        mapReady = true;
        document.getElementById('loadingOverlay').classList.add('hidden');
        
        resizeCanvas();
        
        google.maps.event.addListener(map, 'idle', draw);
        google.maps.event.addListener(map, 'bounds_changed', function() { setTimeout(draw, 50); });
        
    } catch(e) {
        console.error('Error initializing map:', e);
        document.getElementById('loadingText').textContent = 'Error: ' + e.message;
    }
}

function resizeCanvas() {
    canvas.width = document.getElementById('mapContainer').clientWidth;
    canvas.height = document.getElementById('mapContainer').clientHeight;
    draw();
}
window.onresize = resizeCanvas;

function toPixel(lat, lng) {
    if (!mapReady || !map) return { x: -9999, y: -9999 };
    var proj = map.getProjection();
    var bounds = map.getBounds();
    if (!proj || !bounds) return { x: -9999, y: -9999 };
    
    var ne = bounds.getNorthEast(), sw = bounds.getSouthWest();
    var tr = proj.fromLatLngToPoint(ne), bl = proj.fromLatLngToPoint(sw);
    var scale = Math.pow(2, map.getZoom());
    var wp = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lng));
    
    return { x: (wp.x - bl.x) * scale, y: (wp.y - tr.y) * scale };
}

function lineIntersect(x1,y1,x2,y2,x3,y3,x4,y4) {
    var d = (y4-y3)*(x2-x1)-(x4-x3)*(y2-y1);
    if (Math.abs(d) < 1e-12) return null;
    var u = ((x4-x3)*(y1-y3)-(y4-y3)*(x1-x3))/d;
    var v = ((x2-x1)*(y1-y3)-(y2-y1)*(x1-x3))/d;
    return (u>=0 && u<=1 && v>=0 && v<=1) ? [x1+u*(x2-x1), y1+u*(y2-y1)] : null;
}

function extendLine(x1,y1,x2,y2,m) {
    var d = m/111000, dx = x2-x1, dy = y2-y1, l = Math.sqrt(dx*dx+dy*dy);
    if (l < 1e-7) return {x1:x1,y1:y1,x2:x2,y2:y2};
    return { x1: x1-dx/l*d, y1: y1-dy/l*d, x2: x2+dx/l*d, y2: y2+dy/l*d };
}

function findCrossings() {
    entryExits = [];
    if (!boundary.length || !roads.length) { updateUI(); return; }
    
    var ext = +document.getElementById('sliderExt').value;
    var minW = +document.getElementById('sliderWidth').value;
    var seen = {};
    
    roads.forEach(function(road) {
        var p = road.properties || {};
        var w = +(p.width_m || p.WIDTH || p.width || 10);
        var name = p.name_ar || p.ROADCENTERLINENAME_AR || p.name_en || 'Road';
        if (w < minW) return;
        
        var g = road.geometry;
        if (!g) return;
        var lines = g.type === 'LineString' ? [g.coordinates] : (g.coordinates || []);
        
        lines.forEach(function(coords) {
            if (!coords || coords.length < 2) return;
            
            var es = extendLine(coords[1][0], coords[1][1], coords[0][0], coords[0][1], ext);
            var ee = extendLine(coords[coords.length-2][0], coords[coords.length-2][1], coords[coords.length-1][0], coords[coords.length-1][1], ext);
            
            var ec = [[es.x2, es.y2]].concat(coords).concat([[ee.x2, ee.y2]]);
            
            for (var i = 0; i < ec.length-1; i++) {
                for (var j = 0; j < boundary.length-1; j++) {
                    var hit = lineIntersect(ec[i][0],ec[i][1],ec[i+1][0],ec[i+1][1], boundary[j][0],boundary[j][1],boundary[j+1][0],boundary[j+1][1]);
                    if (hit) {
                        var k = hit[0].toFixed(5)+'_'+hit[1].toFixed(5);
                        if (!seen[k]) { seen[k]=1; entryExits.push({lng:hit[0],lat:hit[1],name:name,width:w}); }
                    }
                }
            }
        });
    });
    
    entryExits.sort(function(a,b){return b.width-a.width;});
    updateUI();
    draw();
}

function updateUI() {
    document.getElementById('sTotal').textContent = entryExits.length;
    document.getElementById('sMajor').textContent = entryExits.filter(function(p){return p.width>=30;}).length;
    document.getElementById('sOther').textContent = entryExits.filter(function(p){return p.width<30;}).length;
    document.getElementById('btnExport').disabled = !entryExits.length;
    
    var list = document.getElementById('list');
    if (!entryExits.length) {
        list.innerHTML = '<div style="color:#666;text-align:center;padding:15px;">'+(roads.length?(boundary.length?'Increase extension':'Load district'):'Load roads')+'</div>';
        return;
    }
    var html = '';
    for (var i = 0; i < Math.min(35, entryExits.length); i++) {
        var p = entryExits[i];
        html += '<div class="item" onclick="gotoPoint('+i+')"><div class="dot">'+Math.round(p.width)+'</div><div class="name">'+p.name+'</div></div>';
    }
    if (entryExits.length > 35) html += '<div style="color:#888;text-align:center;padding:5px;">+'+(entryExits.length-35)+' more</div>';
    list.innerHTML = html;
}

function gotoPoint(i) {
    if (mapReady && entryExits[i]) {
        map.setCenter({lat: entryExits[i].lat, lng: entryExits[i].lng});
        map.setZoom(17);
    }
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (!mapReady) return;
    
    var ext = +document.getElementById('sliderExt').value;
    var minW = +document.getElementById('sliderWidth').value;
    var dotSize = +document.getElementById('sliderDot').value;
    
    // Roads
    roads.forEach(function(road) {
        var p = road.properties || {};
        var w = +(p.width_m || p.WIDTH || p.width || 10);
        if (w < minW) return;
        
        var g = road.geometry;
        if (!g) return;
        var lines = g.type === 'LineString' ? [g.coordinates] : (g.coordinates || []);
        
        lines.forEach(function(coords) {
            if (!coords || coords.length < 2) return;
            
            var es = extendLine(coords[1][0], coords[1][1], coords[0][0], coords[0][1], ext);
            var ee = extendLine(coords[coords.length-2][0], coords[coords.length-2][1], coords[coords.length-1][0], coords[coords.length-1][1], ext);
            var ec = [[es.x2, es.y2]].concat(coords).concat([[ee.x2, ee.y2]]);
            
            ctx.beginPath();
            ec.forEach(function(c, i) {
                var px = toPixel(c[1], c[0]);
                i === 0 ? ctx.moveTo(px.x, px.y) : ctx.lineTo(px.x, px.y);
            });
            ctx.strokeStyle = w >= 30 ? '#e94560' : w >= 15 ? '#ff9800' : '#4caf50';
            ctx.lineWidth = w >= 30 ? 5 : w >= 15 ? 3 : 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        });
    });
    
    // Boundary
    if (boundary.length) {
        ctx.beginPath();
        boundary.forEach(function(c, i) {
            var px = toPixel(c[1], c[0]);
            i === 0 ? ctx.moveTo(px.x, px.y) : ctx.lineTo(px.x, px.y);
        });
        ctx.closePath();
        ctx.fillStyle = 'rgba(233,69,96,0.1)';
        ctx.fill();
        ctx.strokeStyle = '#e94560';
        ctx.lineWidth = 3;
        ctx.setLineDash([10,5]);
        ctx.stroke();
        ctx.setLineDash([]);
    }
    
    // Red dots
    entryExits.forEach(function(p) {
        var px = toPixel(p.lat, p.lng);
        var r = p.width >= 40 ? dotSize*1.4 : p.width >= 20 ? dotSize*1.1 : dotSize*0.85;
        
        ctx.beginPath(); ctx.arc(px.x, px.y, r+5, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(233,69,96,0.5)'; ctx.fill();
        
        ctx.beginPath(); ctx.arc(px.x, px.y, r, 0, Math.PI*2);
        ctx.fillStyle = '#e94560'; ctx.fill();
        ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
        
        ctx.fillStyle = 'white';
        ctx.font = 'bold '+Math.max(9,r*0.6)+'px Arial';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(Math.round(p.width), px.x, px.y);
    });
}

// File handlers
document.getElementById('fileRoads').onchange = function(e) {
    var f = e.target.files[0]; if (!f) return;
    var r = new FileReader();
    r.onload = function(ev) {
        try {
            var d = JSON.parse(ev.target.result);
            roads = d.features || [d];
            document.getElementById('statusRoads').textContent = roads.length + ' roads';
            document.getElementById('statusRoads').className = 'status';
            if (mapReady) {
                var lat=0,lng=0,n=0;
                roads.slice(0,50).forEach(function(rd) {
                    var g = rd.geometry; if (!g) return;
                    var ls = g.type==='LineString'?[g.coordinates]:(g.coordinates||[]);
                    ls.forEach(function(cs){ var m=cs[Math.floor(cs.length/2)]; lng+=m[0]; lat+=m[1]; n++; });
                });
                if (n) map.setCenter({lat:lat/n, lng:lng/n});
            }
            findCrossings();
        } catch(err) { alert('Error: '+err.message); }
    };
    r.readAsText(f);
};

document.getElementById('fileDistrict').onchange = function(e) {
    var f = e.target.files[0]; if (!f) return;
    var r = new FileReader();
    r.onload = function(ev) {
        try {
            var d = JSON.parse(ev.target.result);
            var ft = d.features ? d.features[0] : d;
            var gm = ft.geometry;
            boundary = gm.type === 'Polygon' ? gm.coordinates[0] : gm.coordinates[0][0];
            document.getElementById('statusDistrict').textContent = 'Loaded ('+boundary.length+' pts)';
            document.getElementById('statusDistrict').className = 'status';
            if (mapReady) {
                var lat=0,lng=0;
                boundary.forEach(function(c){lng+=c[0];lat+=c[1];});
                map.setCenter({lat:lat/boundary.length, lng:lng/boundary.length});
            }
            findCrossings();
        } catch(err) { alert('Error: '+err.message); }
    };
    r.readAsText(f);
};

// Sliders
document.getElementById('sliderExt').oninput = function() { document.getElementById('valExt').textContent = this.value+'m'; findCrossings(); };
document.getElementById('sliderWidth').oninput = function() { document.getElementById('valWidth').textContent = this.value+'m'; findCrossings(); };
document.getElementById('sliderDot').oninput = function() { document.getElementById('valDot').textContent = this.value; draw(); };

// Export
function exportData() {
    if (!entryExits.length) return;
    var gj = {type:'FeatureCollection',features:entryExits.map(function(p){
        return {type:'Feature',geometry:{type:'Point',coordinates:[p.lng,p.lat]},properties:{name_ar:p.name,width_m:p.width}};
    })};
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(gj,null,2)],{type:'application/json'}));
    a.download = 'entry_exit_points.geojson';
    a.click();
}

// Start
waitForGoogleMaps();
</script>
<script src="https://somanchiu.github.io/Keyless-Google-Maps-API/mapsJavaScriptAPI.js" async defer></script>
</body>
</html>
