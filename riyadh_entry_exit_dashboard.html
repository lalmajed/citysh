<!DOCTYPE html>
<html>
<head>
    <title>Entry/Exit Dashboard</title>
    <meta charset="utf-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; display: flex; height: 100vh; background: #1a1a2e; color: white; }
        
        #sidebar {
            width: 300px;
            background: #16213e;
            padding: 15px;
            overflow-y: auto;
        }
        
        h1 { font-size: 16px; color: #e94560; margin-bottom: 15px; }
        h3 { font-size: 12px; background: #e94560; padding: 5px 8px; margin: 10px 0; border-radius: 3px; }
        
        .file-box { margin-bottom: 10px; }
        .file-box input { width: 100%; padding: 8px; background: #0f3460; border: 1px solid #e94560; color: white; border-radius: 4px; }
        .file-box label { font-size: 11px; color: #888; display: block; margin-top: 3px; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .stat { background: #0f3460; padding: 10px; border-radius: 5px; text-align: center; }
        .stat .num { font-size: 22px; font-weight: bold; color: #e94560; }
        .stat .lbl { font-size: 10px; color: #888; }
        .stat.big { grid-column: span 2; background: #e94560; }
        .stat.big .num { color: white; font-size: 28px; }
        .stat.big .lbl { color: #ffccd5; }
        
        button { width: 100%; padding: 10px; background: #e94560; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px 0; }
        button:hover { background: #c73e54; }
        
        .list { max-height: 250px; overflow-y: auto; font-size: 11px; }
        .item { display: flex; align-items: center; padding: 5px; background: #0f3460; margin: 3px 0; border-radius: 3px; cursor: pointer; }
        .item:hover { background: #1a4a7a; }
        .item .dot { width: 22px; height: 22px; background: #e94560; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; margin-right: 8px; }
        .item .name { flex: 1; direction: rtl; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #mapArea { flex: 1; position: relative; }
        #canvas { width: 100%; height: 100%; display: block; }
        
        #legend {
            position: absolute; bottom: 15px; right: 15px;
            background: rgba(22,33,62,0.95); padding: 10px; border-radius: 5px;
            font-size: 10px; border: 1px solid #e94560;
        }
        #legend div { margin: 3px 0; display: flex; align-items: center; }
        #legend span { display: inline-block; width: 16px; height: 4px; margin-right: 6px; border-radius: 2px; }
        #legend .dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h1>Entry/Exit Dashboard</h1>
        
        <h3>1. Upload Files</h3>
        <div class="file-box">
            <input type="file" id="fileDistrict" accept=".geojson,.json">
            <label>District Boundary GeoJSON</label>
        </div>
        <div class="file-box">
            <input type="file" id="fileRoads" accept=".geojson,.json">
            <label>Roads GeoJSON</label>
        </div>
        
        <h3>2. Statistics</h3>
        <div class="stats">
            <div class="stat big"><div class="num" id="sTotal">0</div><div class="lbl">ENTRY/EXIT POINTS</div></div>
            <div class="stat"><div class="num" id="sMajor">0</div><div class="lbl">Major 30m+</div></div>
            <div class="stat"><div class="num" id="sArterial">0</div><div class="lbl">Arterial 15-30m</div></div>
            <div class="stat"><div class="num" id="sLocal">0</div><div class="lbl">Local &lt;15m</div></div>
            <div class="stat"><div class="num" id="sRoads">0</div><div class="lbl">Total Roads</div></div>
        </div>
        
        <h3>3. Export</h3>
        <button onclick="exportJSON()">Download Entry/Exit GeoJSON</button>
        
        <h3>4. Entry/Exit Points</h3>
        <div class="list" id="list">
            <div style="color:#666;text-align:center;padding:20px;">Upload files to see points</div>
        </div>
    </div>
    
    <div id="mapArea">
        <canvas id="canvas"></canvas>
        <div id="legend">
            <b style="color:#e94560;">Legend</b>
            <div><span style="background:#e94560;height:5px;"></span> Major Road 30m+</div>
            <div><span style="background:#ff9800;"></span> Arterial 15-30m</div>
            <div><span style="background:#4caf50;"></span> Local Road</div>
            <div><span style="background:#444;"></span> Outside District</div>
            <div><span class="dot" style="background:#e94560;"></span> Entry/Exit Point</div>
        </div>
    </div>

<script>
// Data
let boundary = [];
let roads = [];
let points = [];

// View
let view = { x1: 46.63, x2: 46.67, y1: 24.71, y2: 24.75 };

// Canvas
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Resize
function resize() {
    canvas.width = canvas.parentElement.clientWidth;
    canvas.height = canvas.parentElement.clientHeight;
    draw();
}
window.onresize = resize;
window.onload = resize;

// Convert coords
function toX(lng) { return (lng - view.x1) / (view.x2 - view.x1) * canvas.width; }
function toY(lat) { return canvas.height - (lat - view.y1) / (view.y2 - view.y1) * canvas.height; }

// Line intersection
function intersect(ax, ay, bx, by, cx, cy, dx, dy) {
    const d = (dy - cy) * (bx - ax) - (dx - cx) * (by - ay);
    if (Math.abs(d) < 1e-10) return null;
    const u = ((dx - cx) * (ay - cy) - (dy - cy) * (ax - cx)) / d;
    const v = ((bx - ax) * (ay - cy) - (by - ay) * (ax - cx)) / d;
    if (u >= 0 && u <= 1 && v >= 0 && v <= 1) {
        return [ax + u * (bx - ax), ay + u * (by - ay)];
    }
    return null;
}

// Point in polygon
function inside(x, y) {
    let c = false;
    for (let i = 0, j = boundary.length - 1; i < boundary.length; j = i++) {
        const [xi, yi] = boundary[i], [xj, yj] = boundary[j];
        if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) c = !c;
    }
    return c;
}

// Calculate entry/exit points
function calculate() {
    points = [];
    if (!boundary.length || !roads.length) return;
    
    const seen = new Set();
    
    roads.forEach(road => {
        const p = road.properties || {};
        const w = parseFloat(p.width_m || p.WIDTH || p.width || 10);
        const name = p.name_ar || p.ROADCENTERLINENAME_AR || p.name_en || 'Unnamed';
        
        if (w < 6) return;
        
        const g = road.geometry;
        if (!g) return;
        
        const lines = g.type === 'LineString' ? [g.coordinates] : (g.coordinates || []);
        
        lines.forEach(coords => {
            if (!coords || coords.length < 2) return;
            
            for (let i = 0; i < coords.length - 1; i++) {
                const [x1, y1] = coords[i];
                const [x2, y2] = coords[i + 1];
                
                for (let j = 0; j < boundary.length - 1; j++) {
                    const [x3, y3] = boundary[j];
                    const [x4, y4] = boundary[j + 1];
                    
                    const hit = intersect(x1, y1, x2, y2, x3, y3, x4, y4);
                    if (hit) {
                        const key = hit[0].toFixed(5) + '_' + hit[1].toFixed(5);
                        if (!seen.has(key)) {
                            seen.add(key);
                            points.push({ lng: hit[0], lat: hit[1], name, width: w });
                        }
                    }
                }
            }
        });
    });
    
    points.sort((a, b) => b.width - a.width);
    updateStats();
    updateList();
}

// Update stats
function updateStats() {
    document.getElementById('sTotal').textContent = points.length;
    document.getElementById('sMajor').textContent = points.filter(p => p.width >= 30).length;
    document.getElementById('sArterial').textContent = points.filter(p => p.width >= 15 && p.width < 30).length;
    document.getElementById('sLocal').textContent = points.filter(p => p.width < 15).length;
    document.getElementById('sRoads').textContent = roads.length;
}

// Update list
function updateList() {
    const el = document.getElementById('list');
    if (!points.length) {
        el.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">No points found</div>';
        return;
    }
    el.innerHTML = points.slice(0, 40).map((p, i) => 
        `<div class="item" onclick="focus(${i})"><div class="dot">${Math.round(p.width)}</div><div class="name">${p.name}</div></div>`
    ).join('') + (points.length > 40 ? `<div style="color:#666;text-align:center;padding:5px;">+${points.length-40} more</div>` : '');
}

// Focus on point
function focus(i) {
    const p = points[i];
    const r = 0.004;
    view = { x1: p.lng - r, x2: p.lng + r, y1: p.lat - r, y2: p.lat + r };
    draw();
}

// Draw
function draw() {
    // Clear
    ctx.fillStyle = '#0f3460';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Message if no data
    if (!boundary.length) {
        ctx.fillStyle = '#e94560';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Upload District and Roads GeoJSON files', canvas.width/2, canvas.height/2);
        return;
    }
    
    // District fill
    ctx.beginPath();
    boundary.forEach(([x, y], i) => i === 0 ? ctx.moveTo(toX(x), toY(y)) : ctx.lineTo(toX(x), toY(y)));
    ctx.closePath();
    ctx.fillStyle = 'rgba(233,69,96,0.15)';
    ctx.fill();
    
    // Roads
    roads.forEach(road => {
        const p = road.properties || {};
        const w = parseFloat(p.width_m || p.WIDTH || p.width || 10);
        if (w < 6) return;
        
        const g = road.geometry;
        if (!g) return;
        
        const lines = g.type === 'LineString' ? [g.coordinates] : (g.coordinates || []);
        
        lines.forEach(coords => {
            if (!coords || coords.length < 2) return;
            
            ctx.beginPath();
            coords.forEach(([x, y], i) => i === 0 ? ctx.moveTo(toX(x), toY(y)) : ctx.lineTo(toX(x), toY(y)));
            
            // Check if inside
            const mid = coords[Math.floor(coords.length/2)];
            const isIn = inside(mid[0], mid[1]);
            
            ctx.strokeStyle = !isIn ? '#444' : w >= 30 ? '#e94560' : w >= 15 ? '#ff9800' : '#4caf50';
            ctx.lineWidth = w >= 30 ? 4 : w >= 15 ? 3 : 2;
            ctx.stroke();
        });
    });
    
    // Boundary
    ctx.beginPath();
    boundary.forEach(([x, y], i) => i === 0 ? ctx.moveTo(toX(x), toY(y)) : ctx.lineTo(toX(x), toY(y)));
    ctx.closePath();
    ctx.strokeStyle = '#e94560';
    ctx.lineWidth = 3;
    ctx.setLineDash([8, 4]);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Entry/Exit points - RED DOTS
    points.forEach(p => {
        const x = toX(p.lng);
        const y = toY(p.lat);
        const r = p.width >= 40 ? 14 : p.width >= 25 ? 11 : 9;
        
        // Glow
        ctx.beginPath();
        ctx.arc(x, y, r + 4, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(233,69,96,0.4)';
        ctx.fill();
        
        // Red dot
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fillStyle = '#e94560';
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Width label
        ctx.fillStyle = 'white';
        ctx.font = 'bold ' + (r * 0.8) + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(Math.round(p.width), x, y);
    });
}

// File handlers
document.getElementById('fileDistrict').onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    try {
        const data = JSON.parse(await file.text());
        const feat = data.features ? data.features[0] : data;
        const geom = feat.geometry;
        boundary = geom.type === 'Polygon' ? geom.coordinates[0] : geom.coordinates[0][0];
        
        // Set view
        const xs = boundary.map(c => c[0]), ys = boundary.map(c => c[1]);
        view = { x1: Math.min(...xs) - 0.005, x2: Math.max(...xs) + 0.005, y1: Math.min(...ys) - 0.005, y2: Math.max(...ys) + 0.005 };
        
        calculate();
        draw();
    } catch (err) {
        alert('Error: ' + err.message);
    }
};

document.getElementById('fileRoads').onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    try {
        const data = JSON.parse(await file.text());
        roads = data.features || [data];
        calculate();
        draw();
    } catch (err) {
        alert('Error: ' + err.message);
    }
};

// Export
function exportJSON() {
    if (!points.length) { alert('No points to export'); return; }
    
    const data = {
        type: 'FeatureCollection',
        features: points.map(p => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [p.lng, p.lat] },
            properties: { name_ar: p.name, width_m: p.width, road_class: p.width >= 30 ? 'Major' : p.width >= 15 ? 'Arterial' : 'Local' }
        }))
    };
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}));
    a.download = 'entry_exit_points.geojson';
    a.click();
}

// Pan & Zoom
let drag = false, lastX, lastY;
canvas.onmousedown = e => { drag = true; lastX = e.clientX; lastY = e.clientY; };
canvas.onmouseup = () => drag = false;
canvas.onmouseleave = () => drag = false;
canvas.onmousemove = e => {
    if (!drag) return;
    const dx = (e.clientX - lastX) / canvas.width * (view.x2 - view.x1);
    const dy = (e.clientY - lastY) / canvas.height * (view.y2 - view.y1);
    view.x1 -= dx; view.x2 -= dx;
    view.y1 += dy; view.y2 += dy;
    lastX = e.clientX; lastY = e.clientY;
    draw();
};
canvas.onwheel = e => {
    e.preventDefault();
    const z = e.deltaY > 0 ? 1.2 : 0.8;
    const cx = (view.x1 + view.x2) / 2, cy = (view.y1 + view.y2) / 2;
    const w = (view.x2 - view.x1) * z / 2, h = (view.y2 - view.y1) * z / 2;
    view = { x1: cx - w, x2: cx + w, y1: cy - h, y2: cy + h };
    draw();
};
</script>
</body>
</html>
