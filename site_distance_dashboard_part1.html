<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Matrix Builder - Part 1 (Origins 0-123)</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; color: #333; padding: 20px; }
        h1 { color: #4285f4; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 400px 1fr; gap: 20px; }
        .panel { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .panel h2 { font-size: 1rem; color: #4285f4; margin-bottom: 15px; border-bottom: 2px solid #4285f4; padding-bottom: 10px; }
        select { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 15px; font-size: 1rem; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; }
        .btn-start { background: #4285f4; color: white; }
        .btn-start:hover { background: #3367d6; }
        .btn-start:disabled { background: #ccc; }
        .btn-stop { background: #ea4335; color: white; }
        .btn-download { background: #34a853; color: white; padding: 10px; font-size: 0.9rem; }
        .progress-bar { height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4285f4, #34a853); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
        .stat { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #4285f4; }
        .stat-label { font-size: 0.8rem; color: #666; }
        .current { background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; font-size: 1.1rem; color: #1565c0; margin: 15px 0; }
        .log { background: #1e1e1e; color: #0f0; padding: 15px; font-family: monospace; font-size: 0.8rem; height: 200px; overflow-y: auto; border-radius: 8px; }
        #map { height: 400px; border-radius: 10px; }
        .downloads { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .part-indicator { background: #4285f4; color: white; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Google Maps Matrix Builder - PART 1 (Origins 0-123)</h1>
    
    <div class="container">
        <div class="sidebar">
            <div class="panel">
                <div class="part-indicator">PART 1: Processing Origins 0-123 (124 origins)</div>
                <h2>PARALLEL EXTRACTION (with waypoint verification)</h2>
                <div style="margin-bottom:10px;">
                    <label>Workers: </label>
                    <select id="workerCount" style="width:100px;padding:5px;">
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                        <option value="50">50</option>
                        <option value="60">60</option>
                        <option value="70">70</option>
                        <option value="84" selected>84</option>
                    </select>
                    <span style="font-size:0.75rem;color:#666;margin-left:10px;">(84 = max parallel)</span>
                </div>
                
                <button class="btn btn-start" id="startAllBtn" onclick="startParallelAll()">
                    START PART 1 (Origins 0-123)
                </button>
                
                <button class="btn btn-stop" id="stopAllBtn" onclick="stopAll()" style="display:none;">
                    STOP ALL
                </button>
                
                <hr style="margin:15px 0;">
                
                <h2>OR SINGLE ORIGIN (0-123 only)</h2>
                <select id="originSelect">
                    <option value="">-- Select origin --</option>
                </select>
                
                <button class="btn btn-start" id="startBtn" onclick="startAutoCalc()" style="background:#34a853;">
                    RUN SINGLE ORIGIN
                </button>
                
                <button class="btn btn-stop" id="stopBtn" onclick="stopAutoCalc()" style="display:none;">
                    STOP
                </button>
            </div>
            
            <div class="panel">
                <h2>PROGRESS</h2>
                <div class="current" id="currentCalc">Part 1: Origins 0-123</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width:0%">0%</div>
                </div>
                <div class="stats">
                    <div class="stat"><div class="stat-value" id="statDone">0</div><div class="stat-label">Done</div></div>
                    <div class="stat"><div class="stat-value" id="statTotal">124</div><div class="stat-label">Origins (Part 1)</div></div>
                    <div class="stat"><div class="stat-value" id="statCached">0</div><div class="stat-label">Routes Cached</div></div>
                    <div class="stat"><div class="stat-value" id="statPercent">0%</div><div class="stat-label">Part 1 Matrix</div></div>
                </div>
            </div>
            
            <div class="panel">
                <h2>DOWNLOAD</h2>
                <div class="downloads">
                    <button class="btn btn-download" onclick="downloadDistCSV()">Distance CSV</button>
                    <button class="btn btn-download" onclick="downloadTimeCSV()">Time CSV</button>
                    <button class="btn btn-download" onclick="downloadJSON()">Full JSON</button>
                    <button class="btn btn-download" onclick="clearCache()" style="background:#ea4335;">Clear Cache</button>
                </div>
            </div>
            
            <div class="panel">
                <h2>LOG</h2>
                <div class="log" id="log"></div>
            </div>
        </div>
        
        <div class="map-area">
            <div class="panel">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
const SITES = [{"site_id": "RUHSM001", "lat": 24.7403322023658, "lon": 46.6273981332779, "osmid": 161824693, "road_name": "طريق الأمير تركي بن عبدالعزيز الأول", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM002", "lat": 24.740427194217, "lon": 46.6274785995483, "osmid": 569788808, "road_name": "طريق الأمير تركي بن عبدالعزيز الأول", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM003", "lat": 24.7546965432207, "lon": 46.6325774788857, "osmid": 710508486, "road_name": "الدائري الشمالي", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM007", "lat": 24.6726265911391, "lon": 46.656776368618, "osmid": 39445700, "road_name": "طريق الملك خالد", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM009", "lat": 24.7209740445557, "lon": 46.6058734059334, "osmid": null, "road_name": "طريق الملك خالد", "road_direction": null, "site_direction": "N"}, {"site_id": "RUHSM012", "lat": 24.6483701639916, "lon": 46.7946767807007, "osmid": 40854376, "road_name": "طريق الدائري الشرقي", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM015", "lat": 24.5439855825558, "lon": 46.872533261776, "osmid": 741596406, "road_name": "الخرج", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM018", "lat": 24.8287062928303, "lon": 46.6193702816963, "osmid": 53823323, "road_name": "طريق الملك سلمان", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM019", "lat": 24.8178075375809, "lon": 46.6184422373772, "osmid": 569823073, "road_name": "طريق الملك فهد", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM022", "lat": 24.670488879256, "lon": 46.6602820158005, "osmid": 39375332, "road_name": "طريق الملك خالد", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM023", "lat": 24.780546768419, "lon": 46.7285308241844, "osmid": 710009868, "road_name": null, "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM024", "lat": 24.6799116099266, "lon": 46.6544723510742, "osmid": 1247148402, "road_name": "شارع أم الحمام", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM025", "lat": 24.7649189230075, "lon": 46.6561299562454, "osmid": 592883518, "road_name": "الدائري الشمالي", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM026", "lat": 24.7731896590511, "lon": 46.7319613695145, "osmid": 592833059, "road_name": "الدائري الشرقي", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM027", "lat": 24.6750541016666, "lon": 46.6531071066856, "osmid": 39445700, "road_name": "طريق الملك خالد", "road_direction": "SE", "site_direction": "E"}, {"site_id": "RUHSM029", "lat": 24.9694129976553, "lon": 46.7820569872856, "osmid": 158959637, "road_name": null, "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM030", "lat": 25.0012034832327, "lon": 46.7709928750992, "osmid": 815453207, "road_name": "طريق الجنادرية", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM032", "lat": 24.7120199687664, "lon": 46.6719147562981, "osmid": 266899333, "road_name": "طريق الملك فهد الفرعي", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM033", "lat": 24.7897540511277, "lon": 46.7158091068268, "osmid": 593117942, "road_name": "الطريق الدائري الشمالي", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM034", "lat": 24.6755122958506, "lon": 46.6905936598778, "osmid": 38095413, "road_name": null, "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM035", "lat": 24.6203516108267, "lon": 46.5742367506027, "osmid": 1351551729, "road_name": "طريق مكة المكرمة", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM038", "lat": 24.6846274081011, "lon": 46.7023712396622, "osmid": 42176353, "road_name": null, "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM042", "lat": 24.740704875449, "lon": 46.5987414121628, "osmid": 710508488, "road_name": "الطريق الدائري الشمالي", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM044", "lat": 24.8400178982926, "lon": 46.6072306036949, "osmid": 790301603, "road_name": null, "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM045", "lat": 24.6261962301252, "lon": 46.7836314439774, "osmid": 131300092, "road_name": "طريق الدائري الجنوبي", "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM046", "lat": 24.5856708282881, "lon": 46.6952633857727, "osmid": 157620778, "road_name": "طريق الدائري الجنوبي", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM049", "lat": 24.8066959557292, "lon": 46.7554226517677, "osmid": 47497526, "road_name": "طريق الدمام", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM051", "lat": 24.5581848394885, "lon": 46.6767024993897, "osmid": 157620709, "road_name": "طريق ديراب", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM052", "lat": 24.7243240497979, "lon": 46.6658690571785, "osmid": 38124839, "road_name": "طريق الملك فهد", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM053", "lat": 24.6729043824091, "lon": 46.6916853189468, "osmid": 413593861, "road_name": null, "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM054", "lat": 24.6123632798959, "lon": 46.7067539691925, "osmid": 159100653, "road_name": "طريق الملك فهد", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM055", "lat": 24.6110781730948, "lon": 46.707022190094, "osmid": 47594631, "road_name": "طريق الملك فهد", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM057", "lat": 24.6656945509571, "lon": 46.6192603111267, "osmid": 783932747, "road_name": "طريق جدة", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM059", "lat": 24.831956030886, "lon": 46.8484577536583, "osmid": 792787210, "road_name": "طريق الجنادرية", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM060", "lat": 24.8321897210297, "lon": 46.7234346270561, "osmid": 83257231, "road_name": "Airport Road", "road_direction": "SW", "site_direction": "S"}, {"site_id": "RUHSM062", "lat": 24.7980377711983, "lon": 46.569601893425, "osmid": 47588131, "road_name": null, "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM069", "lat": 24.56560566558, "lon": 46.6250592470169, "osmid": 157752006, "road_name": "الطريق الدائري الغربي", "road_direction": "SE", "site_direction": "E"}, {"site_id": "RUHSM070", "lat": 24.6942463632656, "lon": 46.5634649991989, "osmid": 157772368, "road_name": "الطريق الدائري الغربي", "road_direction": "SW", "site_direction": "S"}, {"site_id": "RUHSM071", "lat": 24.6711544395348, "lon": 46.6223931312561, "osmid": 708124920, "road_name": "طريق عبد الله بن حذافة السهمي", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM072", "lat": 24.6707963331305, "lon": 46.6222590208054, "osmid": 42325901, "road_name": "طريق عبد الله بن حذافة السهمي", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM073", "lat": 24.6870447823229, "lon": 46.6315904259682, "osmid": 39445683, "road_name": "Flags Roundabout", "road_direction": "NW", "site_direction": "W"}, {"site_id": "RUHSM074", "lat": 24.6869545710959, "lon": 46.6317647695541, "osmid": 42327048, "road_name": "شارع عمرو الضمري", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM077", "lat": 24.8111586340332, "lon": 46.7348715662956, "osmid": 53844447, "road_name": "طريق سعيد بن زيد", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM078", "lat": 24.8110612436613, "lon": 46.7346113920212, "osmid": 39254023, "road_name": "طريق سعيد بن زيد", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM079", "lat": 24.5588531422709, "lon": 46.6225674748421, "osmid": 331548802, "road_name": "Al Tawhed", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM080", "lat": 24.5589824415937, "lon": 46.622556746006, "osmid": 709511230, "road_name": "Al Tawhed", "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM093", "lat": 24.8325232108086, "lon": 46.8203857541084, "osmid": 47497520, "road_name": "طريق الدمام", "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM095", "lat": 24.7800816178938, "lon": 46.8530228734016, "osmid": 534338369, "road_name": "طريق خريص", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM096", "lat": 24.5348626583046, "lon": 46.6983264684677, "osmid": 331945797, "road_name": "Al-Khaleefa Al Mamoun", "road_direction": "NE", "site_direction": "N"}, {"site_id": "RUHSM097", "lat": 24.598323749187, "lon": 46.7443531751633, "osmid": 160690777, "road_name": "طريق الدائري الجنوبي", "road_direction": "SW", "site_direction": "S"}, {"site_id": "RUHSM098", "lat": 24.8195992645787, "lon": 46.8459257483482, "osmid": 244034778, "road_name": "طريق الجنادرية", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM100", "lat": 24.5686573528817, "lon": 46.8897798657417, "osmid": 46654594, "road_name": "طريق الخرج السريع", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM102", "lat": 24.7352066774981, "lon": 46.6819301247597, "osmid": 269644725, "road_name": null, "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM106", "lat": 24.7087793016666, "lon": 46.7659583687782, "osmid": 265060216, "road_name": "الدائري الشرقي", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM110", "lat": 24.8409306555311, "lon": 46.5533074736595, "osmid": 258340131, "road_name": "الملك خالد", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM111", "lat": 24.8410231157739, "lon": 46.5536212921143, "osmid": 47588066, "road_name": "الملك خالد", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM112", "lat": 24.5972800762424, "lon": 46.6084000468254, "osmid": 783112827, "road_name": "الإمام أبي حنيفة", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM113", "lat": 24.5971435038554, "lon": 46.6084751486778, "osmid": 43538488, "road_name": "الإمام أبي حنيفة", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM114", "lat": 24.5475208005664, "lon": 46.7195722460747, "osmid": 638609490, "road_name": "عرفات", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM116", "lat": 24.9070265631544, "lon": 46.9199708104134, "osmid": 558643065, "road_name": null, "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM117", "lat": 24.5381879590055, "lon": 46.6897889971733, "osmid": 331905646, "road_name": "الإمام مسلم", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM118", "lat": 24.5382806827733, "lon": 46.6898936033249, "osmid": 160652610, "road_name": "الإمام مسلم", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM121", "lat": 24.6462394879027, "lon": 46.6858944296837, "osmid": 159115335, "road_name": "الأمير طلال بن عبدالعزيز", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM122", "lat": 24.7958463762615, "lon": 46.7296761274338, "osmid": 47497526, "road_name": "طريق الدمام", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM125", "lat": 24.771906272745, "lon": 46.732605099678, "osmid": 592833059, "road_name": "الدائري الشرقي", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM128", "lat": 24.6981526522312, "lon": 46.6789072751999, "osmid": 266901971, "road_name": "طريق الملك فهد", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM129", "lat": 24.6876372637067, "lon": 46.7106726765633, "osmid": 784202297, "road_name": "طريق مكة المكرمة", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM130", "lat": 24.6636397195435, "lon": 46.7306765913963, "osmid": 1137278778, "road_name": "شارع الجامعة", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM131", "lat": 24.6634934669944, "lon": 46.7308187484741, "osmid": 38114489, "road_name": "شارع الجامعة", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM136", "lat": 24.620424801656, "lon": 46.5808054804802, "osmid": 53784923, "road_name": "الطريق الدائري الغربي", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM140", "lat": 24.8769760481679, "lon": 46.8059206008911, "osmid": 39549463, "road_name": "Al Thumama", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM141", "lat": 24.8769687507318, "lon": 46.8060520291329, "osmid": 39549466, "road_name": "Al Thumama", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM142", "lat": 24.5674108328895, "lon": 46.655505001545, "osmid": 333939141, "road_name": "طريق الدائري الجنوبي", "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM144", "lat": 24.5638614614901, "lon": 46.717287003994, "osmid": 644838335, "road_name": "Al-Marouj", "road_direction": "SE", "site_direction": "E"}, {"site_id": "RUHSM145", "lat": 24.5687663130558, "lon": 46.8898630142212, "osmid": 159112152, "road_name": "طريق الخرج السريع", "road_direction": "NW", "site_direction": "W"}, {"site_id": "RUHSM147", "lat": 24.6038597752923, "lon": 46.6194561123848, "osmid": 43538488, "road_name": "الإمام أبي حنيفة", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM148", "lat": 24.6040012164286, "lon": 46.6193461418152, "osmid": 783112827, "road_name": "الإمام أبي حنيفة", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM152", "lat": 24.6854562001529, "lon": 46.6520261764526, "osmid": 1247148402, "road_name": "شارع أم الحمام", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM153", "lat": 24.6855219810628, "lon": 46.6522246599197, "osmid": 539918135, "road_name": "شارع أم الحمام", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM156", "lat": 24.7259342868167, "lon": 46.7802920937538, "osmid": 784202303, "road_name": "طريق خريص", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM157", "lat": 24.6409759484262, "lon": 46.8291538953781, "osmid": 331128588, "road_name": "طريق الدائري الجنوبي", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM160", "lat": 24.6086054881289, "lon": 46.7729669809341, "osmid": 593114187, "road_name": "طريق الخرج", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM161", "lat": 24.6336106991616, "lon": 46.8119421601295, "osmid": 40994373, "road_name": "طريق الدائري الجنوبي", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM164", "lat": 24.5796291806517, "lon": 46.5517866611481, "osmid": 157711942, "road_name": "بلال بن رباح", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM165", "lat": 24.5797877232525, "lon": 46.5518108010292, "osmid": 783932731, "road_name": "بلال بن رباح", "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM168", "lat": 24.5844927893916, "lon": 46.7547172307968, "osmid": 55419534, "road_name": "An-Nasar Road", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM169", "lat": 24.5982237727608, "lon": 46.6173076629639, "osmid": 741824091, "road_name": "حمزة بن عبد المطلب", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM170", "lat": 24.5981359902433, "lon": 46.6171762347221, "osmid": 157620811, "road_name": "حمزة بن عبد المطلب", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM173", "lat": 24.7946969705971, "lon": 46.6560655832291, "osmid": 1342419504, "road_name": "طريق الملك عبدالعزيز", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM174", "lat": 24.5079388888788, "lon": 46.9285324215889, "osmid": 69424408, "road_name": "Al Kharj", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM175", "lat": 24.5081024122122, "lon": 46.9286692142487, "osmid": 792788985, "road_name": "Al Kharj", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM178", "lat": 25.0159432570743, "lon": 46.7664411664009, "osmid": 158959584, "road_name": "طريق الجنادرية", "road_direction": "N", "site_direction": "N"}, {"site_id": "RUHSM179", "lat": 25.0158897994536, "lon": 46.7662614583969, "osmid": 815453207, "road_name": "طريق الجنادرية", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM180", "lat": 24.66748117972, "lon": 46.7952159047127, "osmid": 156738125, "road_name": "أبو عبيدة عامر بن الجراح", "road_direction": "W", "site_direction": "W"}, {"site_id": "RUHSM181", "lat": 24.6672764432188, "lon": 46.7952185869217, "osmid": 161100608, "road_name": "أبو عبيدة عامر بن الجراح", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM182", "lat": 24.6433261861909, "lon": 46.8339711427689, "osmid": 258315154, "road_name": "طريق الدائري الجنوبي", "road_direction": "SW", "site_direction": "S"}, {"site_id": "RUHSM187", "lat": 24.642784983054, "lon": 46.7355394363403, "osmid": 1102350294, "road_name": "الخرج", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM188", "lat": 24.6011674755442, "lon": 46.6398543119431, "osmid": 221379977, "road_name": "ابن الجوزي", "road_direction": "NE", "site_direction": "N"}, {"site_id": "RUHSM189", "lat": 24.6013016369983, "lon": 46.6397336125374, "osmid": 221379976, "road_name": "ابن الجوزي", "road_direction": "SW", "site_direction": "S"}, {"site_id": "RUHSM190", "lat": 24.6326745415304, "lon": 46.5654820203781, "osmid": 569617231, "road_name": "طريق نجد", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM191", "lat": 24.8129651971553, "lon": 46.6760292649269, "osmid": 569596217, "road_name": null, "road_direction": "SW", "site_direction": "S"}, {"site_id": "RUHSM192", "lat": 24.8127826050202, "lon": 46.6761177778244, "osmid": 158922809, "road_name": "الثمامة", "road_direction": "NE", "site_direction": "N"}, {"site_id": "RUHSM195", "lat": 24.7299152397197, "lon": 46.8647655844688, "osmid": 161390131, "road_name": "الطريق الدائري الثاني", "road_direction": "S", "site_direction": "S"}, {"site_id": "RUHSM196", "lat": 24.7999978581173, "lon": 46.6526859998703, "osmid": 1159782964, "road_name": "الربيع - اليرموك", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM198", "lat": 24.7694781484828, "lon": 46.6684493422508, "osmid": 996899621, "road_name": "طريق الملك عبدالعزيز", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM201", "lat": 24.615255335399, "lon": 46.7573323845863, "osmid": 332076124, "road_name": null, "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM207", "lat": 24.7444197548951, "lon": 46.6082498431206, "osmid": 266889822, "road_name": "الطريق الدائري الشمالي", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM208", "lat": 24.823774152058, "lon": 46.7285388708115, "osmid": 53844447, "road_name": "طريق سعيد بن زيد", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM209", "lat": 24.8236621627272, "lon": 46.7282545566559, "osmid": 39254023, "road_name": "طريق سعيد بن زيد", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM210", "lat": 24.7432407032976, "lon": 46.8001833558083, "osmid": 45984901, "road_name": "عبدالرحمن الناصر", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM211", "lat": 24.7433162129597, "lon": 46.8002933263779, "osmid": 45984900, "road_name": "عبدالرحمن الناصر", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM212", "lat": 24.6725825464765, "lon": 46.8299263715744, "osmid": 1239582591, "road_name": "شارع ابن ماجة", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM213", "lat": 24.6725337944213, "lon": 46.8298190832138, "osmid": 334118692, "road_name": "شارع ابن ماجة", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM216", "lat": 24.5872366876198, "lon": 46.5884765982628, "osmid": 157282652, "road_name": "خديجة بنت خويلد", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM217", "lat": 24.5871147808519, "lon": 46.5885651111603, "osmid": 43155650, "road_name": "خديجة بنت خويلد", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM218", "lat": 24.7088894173431, "lon": 46.8437933921814, "osmid": 52993906, "road_name": "طريق طلحة بن عبيدالله", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM221", "lat": 24.6402519488123, "lon": 46.75511687994, "osmid": 1102350297, "road_name": "طريق المدينة المنورة", "road_direction": "E", "site_direction": "E"}, {"site_id": "RUHSM224", "lat": 24.7455602489784, "lon": 46.8242803215981, "osmid": 784215121, "road_name": "شارع حسان بن ثابت", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM225", "lat": 24.7454847342479, "lon": 46.8241676688194, "osmid": 52572580, "road_name": "شارع حسان بن ثابت", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM226", "lat": 24.7641928838335, "lon": 46.8337565660477, "osmid": 135191742, "road_name": "شارع ابن الهيثم", "road_direction": "NW", "site_direction": "N"}, {"site_id": "RUHSM227", "lat": 24.764122238671, "lon": 46.8336492776871, "osmid": 79699130, "road_name": "شارع ابن الهيثم", "road_direction": "SE", "site_direction": "S"}, {"site_id": "RUHSM228", "lat": 24.7395185293973, "lon": 46.5959626436234, "osmid": 710508488, "road_name": "الطريق الدائري الشمالي", "road_direction": "SW", "site_direction": "W"}, {"site_id": "RUHSM232", "lat": 24.4701528666928, "lon": 46.612468957901, "osmid": 333835113, "road_name": "ديراب", "road_direction": "NE", "site_direction": "E"}, {"site_id": "RUHSM233", "lat": 24.5476209553064, "lon": 46.6873374581337, "osmid": 160652581, "road_name": "الخليل بن أحمد", "road_direction": "SE", "site_direction": "E"}, {"site_id": "RUHSM234", "lat": 24.5477331800292, "lon": 46.6874313354492, "osmid": 160652587, "road_name": "الخليل بن أحمد", "road_direction": "NW", "site_direction": "W"}];
const STORAGE_KEY = 'riyadh_gmaps_matrix_part1';
const ORIGIN_START = 0;
const ORIGIN_END = 123;
const TOTAL_ORIGINS = 124;
const TOTAL_ROUTES_PART = 124 * 246; // 30504 routes for part 1

let CACHE = { dist: {}, time: {}, waypoints: {} };
let map, markers = [], directionsService;
let running = false;

// Haversine distance in km
function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// Find candidate waypoints near the path (pre-filter)
function findCandidatesNearPath(path, startIdx, endIdx) {
    const candidates = [];
    const THRESHOLD = 0.05; // 50 meters - strict but reasonable
    
    log('Path has ' + path.length + ' points');
    
    SITES.forEach((site, idx) => {
        if (idx === startIdx || idx === endIdx) return;
        
        let minDist = Infinity, pathIdx = 0;
        for (let i = 0; i < path.length; i++) {
            const d = haversine(site.lat, site.lon, path[i].lat(), path[i].lng());
            if (d < minDist) { minDist = d; pathIdx = i; }
        }
        
        if (minDist < THRESHOLD) {
            candidates.push({ idx, pathIdx, dist: minDist });
            log('  Candidate: ' + site.site_id + ' (' + (minDist*1000).toFixed(0) + 'm from path)');
        }
    });
    
    candidates.sort((a, b) => a.pathIdx - b.pathIdx);
    log('Found ' + candidates.length + ' candidates within 30m of path');
    return candidates;
}

// Verify waypoint using Google Maps - SIMPLE: if distance barely increases, it's on the route
async function verifyWaypointWithGoogle(startIdx, waypointIdx, endIdx, directDist) {
    return new Promise(resolve => {
        directionsService.route({
            origin: {lat: SITES[startIdx].lat, lng: SITES[startIdx].lon},
            destination: {lat: SITES[endIdx].lat, lng: SITES[endIdx].lon},
            waypoints: [{
                location: {lat: SITES[waypointIdx].lat, lng: SITES[waypointIdx].lon},
                stopover: true
            }],
            travelMode: 'DRIVING'
        }, (res, status) => {
            if (status === 'OK') {
                let totalDist = 0;
                res.routes[0].legs.forEach(leg => totalDist += leg.distance.value);
                totalDist = totalDist / 1000; // km
                
                // ULTRA STRICT: 0.1% threshold
                // If waypoint is truly ON the route, distance should be IDENTICAL
                // Even tiny detour to wrong side adds measurable distance
                const increase = (totalDist - directDist) / directDist;
                const isOnRoute = increase < 0.001; // 0.1% - essentially zero increase
                
                const result = isOnRoute ? '✓ ON ROUTE' : '✗ OFF';
                log('  ' + result + ' ' + SITES[waypointIdx].site_id + 
                    ' (direct: ' + directDist.toFixed(2) + 'km, with wp: ' + totalDist.toFixed(2) + 'km, +' + (increase*100).toFixed(2) + '%)');
                resolve(isOnRoute);
            } else {
                log('  ERROR ' + SITES[waypointIdx].site_id + ': ' + status);
                resolve(false);
            }
        });
    });
}

// Get route direction at a specific path index
function getLocalRouteDirection(path, pathIdx) {
    const i = Math.max(0, Math.min(pathIdx, path.length - 2));
    const p1 = path[i];
    const p2 = path[i + 1];
    const dLat = p2.lat() - p1.lat();
    const dLon = p2.lng() - p1.lng();
    if (Math.abs(dLat) > Math.abs(dLon)) {
        return dLat > 0 ? 'N' : 'S';
    } else {
        return dLon > 0 ? 'E' : 'W';
    }
}

// Find and verify waypoints using Google Maps
async function findWaypointsOnPath(path, startIdx, endIdx, directDist) {
    log('Origin: ' + SITES[startIdx].site_id);
    log('Destination: ' + SITES[endIdx].site_id);
    log('Direct route: ' + directDist.toFixed(2) + 'km');
    
    // STEP 1: Find candidates near path
    log('STEP 1: Finding candidates within 50m of path...');
    let candidates = findCandidatesNearPath(path, startIdx, endIdx);
    
    if (candidates.length === 0) {
        log('No candidates found');
        return [];
    }
    
    // STEP 2: Check LOCAL route direction at each candidate's position
    log('STEP 2: Checking LOCAL route direction at each candidate...');
    candidates = candidates.filter(c => {
        const localDir = getLocalRouteDirection(path, c.pathIdx);
        const siteDir = SITES[c.idx].site_direction;
        const match = siteDir === localDir;
        log('  ' + SITES[c.idx].site_id + ': site=' + siteDir + ', route=' + localDir + ' → ' + (match ? '✓ MATCH' : '✗ WRONG SIDE'));
        return match;
    });
    
    if (candidates.length === 0) {
        log('No candidates match local route direction');
        return [];
    }
    
    // STEP 3: Verify with Google Maps
    log('STEP 3: Verifying ' + candidates.length + ' with Google...');
    const verified = [];
    
    for (const c of candidates) {
        log('  Checking ' + SITES[c.idx].site_id + ' (' + SITES[c.idx].site_direction + ')...');
        const isOnRoute = await verifyWaypointWithGoogle(startIdx, c.idx, endIdx, directDist);
        if (isOnRoute) {
            verified.push(c.idx);
        }
        await new Promise(r => setTimeout(r, 150)); // Rate limit
    }
    
    // POST-FILTER: If two verified waypoints are very close, keep only one
    const filtered = filterNearbyDuplicates(verified, path);
    
    log('═══════════════════════════════════');
    log('RESULT: ' + filtered.length + ' waypoints on route');
    if (filtered.length > 0) {
        log('  ' + filtered.map(i => SITES[i].site_id).join(', '));
    }
    return filtered;
}

// If two waypoints are within 100m of each other, keep only the one matching route direction
function filterNearbyDuplicates(waypointIdxs, path) {
    if (waypointIdxs.length < 2) return waypointIdxs;
    
    const dominated = new Set();
    
    for (let i = 0; i < waypointIdxs.length; i++) {
        if (dominated.has(i)) continue;
        
        for (let j = i + 1; j < waypointIdxs.length; j++) {
            if (dominated.has(j)) continue;
            
            const siteA = SITES[waypointIdxs[i]];
            const siteB = SITES[waypointIdxs[j]];
            
            // Check if sites are very close (within 100m)
            const dist = haversine(siteA.lat, siteA.lon, siteB.lat, siteB.lon);
            if (dist < 0.1) {
                // Find which one matches route direction better
                // Get path index for each
                let pathIdxA = 0, pathIdxB = 0;
                let minDistA = Infinity, minDistB = Infinity;
                
                for (let p = 0; p < path.length; p++) {
                    const dA = haversine(siteA.lat, siteA.lon, path[p].lat(), path[p].lng());
                    const dB = haversine(siteB.lat, siteB.lon, path[p].lat(), path[p].lng());
                    if (dA < minDistA) { minDistA = dA; pathIdxA = p; }
                    if (dB < minDistB) { minDistB = dB; pathIdxB = p; }
                }
                
                // Get route direction at that point
                const avgIdx = Math.floor((pathIdxA + pathIdxB) / 2);
                const routeDir = getRouteDir(path, avgIdx);
                
                log('  Nearby pair: ' + siteA.site_id + '(' + siteA.site_direction + ') vs ' + siteB.site_id + '(' + siteB.site_direction + ') - route going ' + routeDir);
                
                // Keep the one matching route direction
                if (siteA.site_direction === routeDir && siteB.site_direction !== routeDir) {
                    dominated.add(j);
                    log('    → Keep ' + siteA.site_id);
                } else if (siteB.site_direction === routeDir && siteA.site_direction !== routeDir) {
                    dominated.add(i);
                    log('    → Keep ' + siteB.site_id);
                } else {
                    // Same direction or neither matches - keep closer one
                    if (minDistA <= minDistB) {
                        dominated.add(j);
                        log('    → Keep ' + siteA.site_id + ' (closer)');
                    } else {
                        dominated.add(i);
                        log('    → Keep ' + siteB.site_id + ' (closer)');
                    }
                }
            }
        }
    }
    
    return waypointIdxs.filter((_, idx) => !dominated.has(idx));
}

// Get route direction at a path index
function getRouteDir(path, idx) {
    const i = Math.min(Math.max(idx, 0), path.length - 2);
    const dLat = path[i + 1].lat() - path[i].lat();
    const dLon = path[i + 1].lng() - path[i].lng();
    if (Math.abs(dLat) > Math.abs(dLon)) {
        return dLat > 0 ? 'N' : 'S';
    } else {
        return dLon > 0 ? 'E' : 'W';
    }
}

function log(msg) {
    const el = document.getElementById('log');
    el.innerHTML += '[' + new Date().toLocaleTimeString() + '] ' + msg + '\n';
    el.scrollTop = el.scrollHeight;
    console.log(msg);
}

function loadCache() {
    try {
        const s = localStorage.getItem(STORAGE_KEY);
        if (s) {
            const loaded = JSON.parse(s);
            CACHE.dist = loaded.dist || {};
            CACHE.time = loaded.time || {};
            CACHE.waypoints = loaded.waypoints || {};
        }
        log('Loaded ' + Object.keys(CACHE.dist).length + ' routes from cache');
    } catch(e) { log('Cache load error: ' + e); }
    updateStats();
}

function saveCache() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(CACHE));
    updateStats();
}

function updateStats() {
    const n = Object.keys(CACHE.dist).length;
    document.getElementById('statCached').textContent = n;
    document.getElementById('statPercent').textContent = ((n / TOTAL_ROUTES_PART) * 100).toFixed(1) + '%';
}

function getKey(i, j) { return i + '_' + j; }
function getCached(i, j) { 
    const k = getKey(i,j); 
    return CACHE.dist[k] !== undefined ? {
        dist: CACHE.dist[k], 
        time: CACHE.time[k],
        waypoints: CACHE.waypoints[k] || []
    } : null; 
}
function setCache(i, j, d, t, w) { 
    const k = getKey(i,j);
    CACHE.dist[k] = d; 
    CACHE.time[k] = t;
    if (w && w.length > 0) CACHE.waypoints[k] = w;
}

function initMap() {
    loadCache();
    map = new google.maps.Map(document.getElementById('map'), { center: {lat:24.7,lng:46.7}, zoom: 10 });
    directionsService = new google.maps.DirectionsService();
    
    SITES.forEach((s,i) => {
        markers.push(new google.maps.Marker({ position:{lat:s.lat,lng:s.lon}, map, title:s.site_id }));
    });
    
    // Only populate origins 0-123 in the dropdown
    const sel = document.getElementById('originSelect');
    for (let i = ORIGIN_START; i <= ORIGIN_END; i++) {
        const s = SITES[i];
        let done = 0;
        for (let j = 0; j < SITES.length; j++) if (i !== j && getCached(i,j)) done++;
        const status = done === 246 ? ' [DONE]' : done > 0 ? ' [' + done + '/246]' : '';
        sel.innerHTML += '<option value="' + i + '">' + s.site_id + status + '</option>';
    }
    
    log('PART 1: Ready! Processing origins 0-123 (124 origins)');
    log('Click START to begin parallel extraction with 84 workers');
}

async function fetchRoute(i, j) {
    return new Promise(async (resolve) => {
        directionsService.route({
            origin: {lat: SITES[i].lat, lng: SITES[i].lon},
            destination: {lat: SITES[j].lat, lng: SITES[j].lon},
            travelMode: 'DRIVING'
        }, async (res, status) => {
            if (status === 'OK') {
                const leg = res.routes[0].legs[0];
                const dist = leg.distance.value/1000;
                const time = leg.duration.value/60;
                const path = res.routes[0].overview_path;
                
                // Find and verify waypoints
                const waypoints = await findWaypointsOnPath(path, i, j, dist);
                
                resolve({ dist, time, waypoints });
            } else resolve({error: status});
        });
    });
}

async function startAutoCalc() {
    const idx = parseInt(document.getElementById('originSelect').value);
    if (isNaN(idx)) { alert('Select an origin first!'); return; }
    
    running = true;
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'block';
    document.getElementById('originSelect').disabled = true;
    
    const origin = SITES[idx];
    log('Starting from ' + origin.site_id + '...');
    markers[idx].setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
    
    let done = 0;
    for (let j = 0; j < SITES.length && running; j++) {
        if (j === idx) continue;
        
        if (getCached(idx, j)) { done++; continue; }
        
        document.getElementById('currentCalc').textContent = origin.site_id + ' → ' + SITES[j].site_id;
        markers[j].setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
        
        const r = await fetchRoute(idx, j);
        if (r.error) {
            log('ERROR: ' + origin.site_id + ' → ' + SITES[j].site_id + ': ' + r.error);
        } else {
            setCache(idx, j, r.dist, r.time, r.waypoints);
            const wpInfo = r.waypoints.length > 0 ? ' [' + r.waypoints.length + ' waypoints]' : '';
            log(origin.site_id + ' → ' + SITES[j].site_id + ': ' + r.dist.toFixed(1) + 'km' + wpInfo);
        }
        
        markers[j].setIcon(null);
        done++;
        
        const pct = Math.round((done/246)*100);
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressFill').textContent = pct + '%';
        document.getElementById('statDone').textContent = done;
        
        if (done % 10 === 0) saveCache();
        await new Promise(r => setTimeout(r, 150));
    }
    
    saveCache();
    running = false;
    document.getElementById('startBtn').style.display = 'block';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('originSelect').disabled = false;
    document.getElementById('currentCalc').textContent = 'Done! ' + origin.site_id + ' complete.';
    log('Finished ' + origin.site_id);
}

function stopAutoCalc() { running = false; log('Stopped'); }

// PARALLEL PROCESSING - with full waypoint verification
let parallelRunning = false;
let activeWorkers = 0;

async function startParallelAll() {
    if (parallelRunning) return;
    
    parallelRunning = true;
    document.getElementById('startAllBtn').style.display = 'none';
    document.getElementById('stopAllBtn').style.display = 'block';
    
    const workerCount = parseInt(document.getElementById('workerCount').value);
    log('═══════════════════════════════════');
    log('PART 1: STARTING ' + workerCount + ' PARALLEL WORKERS');
    log('Processing origins 0-123 (124 origins)');
    log('With FULL waypoint verification');
    log('═══════════════════════════════════');
    
    // Find incomplete origins IN THIS PART ONLY (0-123)
    const incompleteOrigins = [];
    for (let i = ORIGIN_START; i <= ORIGIN_END; i++) {
        let done = 0;
        for (let j = 0; j < SITES.length; j++) {
            if (i !== j && getCached(i, j)) done++;
        }
        if (done < 246) {
            incompleteOrigins.push({ idx: i, done: done });
        }
    }
    
    // Sort: most complete first
    incompleteOrigins.sort((a, b) => b.done - a.done);
    
    log('Found ' + incompleteOrigins.length + ' incomplete origins in Part 1');
    
    if (incompleteOrigins.length === 0) {
        log('PART 1 ALL COMPLETE!');
        parallelRunning = false;
        document.getElementById('startAllBtn').style.display = 'block';
        document.getElementById('stopAllBtn').style.display = 'none';
        return;
    }
    
    let currentIdx = 0;
    let totalRoutesDone = Object.keys(CACHE.dist).length;
    
    // Worker function - processes one origin at a time with full verification
    async function worker(workerId) {
        while (parallelRunning && currentIdx < incompleteOrigins.length) {
            const origin = incompleteOrigins[currentIdx++];
            if (!origin) break;
            
            const originSite = SITES[origin.idx];
            log('[W' + workerId + '] Starting ' + originSite.site_id + ' (' + origin.done + '/246 done)');
            
            let routesDone = 0;
            for (let j = 0; j < SITES.length && parallelRunning; j++) {
                if (j === origin.idx) continue;
                if (getCached(origin.idx, j)) { routesDone++; continue; }
                
                // Full route fetch with waypoint verification
                const r = await fetchRoute(origin.idx, j);
                if (!r.error) {
                    setCache(origin.idx, j, r.dist, r.time, r.waypoints);
                    totalRoutesDone++;
                    routesDone++;
                    
                    const wpInfo = r.waypoints.length > 0 ? ' [' + r.waypoints.length + ' wp]' : '';
                    log('[W' + workerId + '] ' + originSite.site_id + '→' + SITES[j].site_id + ': ' + r.dist.toFixed(1) + 'km' + wpInfo);
                }
                
                // Save periodically
                if (totalRoutesDone % 20 === 0) {
                    saveCache();
                    updateParallelProgress(totalRoutesDone);
                }
                
                // Rate limit - important to avoid Google blocking
                await new Promise(r => setTimeout(r, 200));
            }
            
            saveCache();
            log('[W' + workerId + '] Finished ' + originSite.site_id);
        }
        
        activeWorkers--;
        log('[W' + workerId + '] Worker stopped');
        
        if (activeWorkers === 0) {
            parallelRunning = false;
            document.getElementById('startAllBtn').style.display = 'block';
            document.getElementById('stopAllBtn').style.display = 'none';
            log('═══════════════════════════════════');
            log('PART 1 ALL WORKERS FINISHED!');
            log('Total routes: ' + Object.keys(CACHE.dist).length);
            log('═══════════════════════════════════');
        }
    }
    
    // Start workers
    activeWorkers = workerCount;
    for (let w = 0; w < workerCount; w++) {
        worker(w + 1);
        await new Promise(r => setTimeout(r, 100)); // Stagger worker starts
    }
}

function updateParallelProgress(total) {
    const pct = ((total / TOTAL_ROUTES_PART) * 100).toFixed(1);
    document.getElementById('statCached').textContent = total;
    document.getElementById('statPercent').textContent = pct + '%';
    document.getElementById('currentCalc').textContent = 'Part 1: ' + total + ' routes (' + pct + '%)';
}

function stopAll() {
    parallelRunning = false;
    log('Stopping all workers...');
}

function downloadDistCSV() {
    let csv = ',' + SITES.map(s=>s.site_id).join(',') + '\n';
    SITES.forEach((s,i) => {
        let row = [s.site_id];
        SITES.forEach((_,j) => { row.push(i===j ? '0' : (getCached(i,j)?.dist.toFixed(2) || '')); });
        csv += row.join(',') + '\n';
    });
    download(csv, 'distance_km_part1.csv', 'text/csv');
}

function downloadTimeCSV() {
    let csv = ',' + SITES.map(s=>s.site_id).join(',') + '\n';
    SITES.forEach((s,i) => {
        let row = [s.site_id];
        SITES.forEach((_,j) => { row.push(i===j ? '0' : (getCached(i,j)?.time.toFixed(1) || '')); });
        csv += row.join(',') + '\n';
    });
    download(csv, 'time_min_part1.csv', 'text/csv');
}

function downloadJSON() {
    download(JSON.stringify({
        source: 'Google Maps',
        part: 1,
        origin_range: '0-123',
        sites: SITES,
        distance_km: CACHE.dist,
        time_min: CACHE.time,
        waypoints: CACHE.waypoints
    }, null, 2), 'google_matrix_part1.json', 'application/json');
}

function download(c, f, t) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([c],{type:t}));
    a.download = f; a.click();
}

function clearCache() {
    if(confirm('Clear all cached data for Part 1?')) { 
        CACHE = {dist:{}, time:{}, waypoints:{}}; 
        localStorage.removeItem(STORAGE_KEY); 
        updateStats(); 
        log('Part 1 cache cleared'); 
    }
}

    </script>
    <script src="https://cdn.jsdelivr.net/gh/somanchiu/Keyless-Google-Maps-API@v7.1/mapsJavaScriptAPI.js" async defer></script>
    <script>
    // Wait for Google Maps to load then init
    function waitForMaps() {
        if (typeof google !== 'undefined' && google.maps) {
            initMap();
        } else {
            setTimeout(waitForMaps, 100);
        }
    }
    waitForMaps();
    </script>
</body>
</html>
