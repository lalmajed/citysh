<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge OD Results - google_matrix + od_results</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; padding: 20px; }
        h1 { color: #4285f4; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .panel h2 { font-size: 1rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid; }
        .panel.file1 h2 { color: #4285f4; border-color: #4285f4; }
        .panel.file2 h2 { color: #ea4335; border-color: #ea4335; }
        .panel.merged h2 { color: #34a853; border-color: #34a853; }
        .btn { padding: 12px 20px; font-size: 1rem; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        .btn-blue { background: #4285f4; color: white; }
        .btn-red { background: #ea4335; color: white; }
        .btn-green { background: #34a853; color: white; }
        .btn-purple { background: #9c27b0; color: white; }
        .btn:hover { opacity: 0.9; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .stat { background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; }
        .stat-label { font-size: 0.75rem; color: #666; }
        .file-info { background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 0.85rem; }
        .file-info.error { background: #ffebee; color: #c62828; }
        .file-info.success { background: #e8f5e9; color: #2e7d32; }
        .log { background: #1e1e1e; color: #0f0; padding: 15px; font-family: monospace; font-size: 0.8rem; height: 200px; overflow-y: auto; border-radius: 6px; margin-top: 15px; }
        .schema { background: #f5f5f5; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.75rem; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }
        input[type="file"] { display: none; }
        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Merge OD Results</h1>
        <p class="subtitle">Merge google_matrix (index-based) with od_results (site_id-based)</p>
        
        <div class="row">
            <div class="panel file1">
                <h2>üìÅ File 1: google_matrix (old format)</h2>
                <input type="file" id="file1Input" accept=".json" onchange="loadFile1(this)">
                <button class="btn btn-blue" onclick="document.getElementById('file1Input').click()">
                    Upload google_matrix.json
                </button>
                <div id="file1Info" class="file-info" style="display:none;"></div>
                <div class="stats" id="file1Stats" style="display:none;">
                    <div class="stat"><div class="stat-value" id="f1Sites">0</div><div class="stat-label">Sites</div></div>
                    <div class="stat"><div class="stat-value" id="f1Routes">0</div><div class="stat-label">Routes</div></div>
                    <div class="stat"><div class="stat-value" id="f1Waypoints">0</div><div class="stat-label">With Waypoints</div></div>
                </div>
                <div class="schema" id="file1Schema" style="display:none;"></div>
            </div>
            
            <div class="panel file2">
                <h2>üìÅ File 2: od_results (new format)</h2>
                <input type="file" id="file2Input" accept=".json" onchange="loadFile2(this)">
                <button class="btn btn-red" onclick="document.getElementById('file2Input').click()">
                    Upload od_results.json
                </button>
                <div id="file2Info" class="file-info" style="display:none;"></div>
                <div class="stats" id="file2Stats" style="display:none;">
                    <div class="stat"><div class="stat-value" id="f2Sites">0</div><div class="stat-label">Sites</div></div>
                    <div class="stat"><div class="stat-value" id="f2Routes">0</div><div class="stat-label">Routes</div></div>
                    <div class="stat"><div class="stat-value" id="f2Waypoints">0</div><div class="stat-label">With Waypoints</div></div>
                </div>
                <div class="schema" id="file2Schema" style="display:none;"></div>
            </div>
        </div>
        
        <div class="panel merged full-width">
            <h2>üîó Merge & Download</h2>
            <div style="text-align:center;margin:20px 0;">
                <button class="btn btn-green" onclick="mergeFiles()" id="mergeBtn" disabled>
                    üîó MERGE FILES
                </button>
            </div>
            <div id="mergeInfo" class="file-info success" style="display:none;"></div>
            <div class="stats" id="mergeStats" style="display:none;">
                <div class="stat"><div class="stat-value" id="mSites">0</div><div class="stat-label">Total Sites</div></div>
                <div class="stat"><div class="stat-value" id="mRoutes">0</div><div class="stat-label">Total Routes</div></div>
                <div class="stat"><div class="stat-value" id="mWaypoints">0</div><div class="stat-label">With Waypoints</div></div>
            </div>
            <div style="text-align:center;margin-top:20px;" id="downloadBtns" style="display:none;">
                <button class="btn btn-purple" onclick="downloadMerged('new')">
                    üì• Download (new format - site_ids)
                </button>
                <button class="btn btn-blue" onclick="downloadMerged('old')">
                    üì• Download (old format - indices)
                </button>
                <button class="btn btn-green" onclick="downloadCSV()">
                    üì• Download CSV
                </button>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìã Log</h2>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
let file1Data = null;  // google_matrix format
let file2Data = null;  // od_results format
let mergedData = null;

function log(msg) {
    const el = document.getElementById('log');
    el.innerHTML += '[' + new Date().toLocaleTimeString() + '] ' + msg + '\n';
    el.scrollTop = el.scrollHeight;
    console.log(msg);
}

function loadFile1(input) {
    const file = input.files[0];
    if (!file) return;
    
    log('Loading File 1: ' + file.name);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            file1Data = data;
            
            // Detect format
            const isOldFormat = Array.isArray(data.sites) && data.distance_km;
            const isNewFormat = data.results && typeof data.sites === 'object' && !Array.isArray(data.sites);
            
            let sitesCount, routesCount, wpCount;
            
            if (isOldFormat) {
                sitesCount = data.sites.length;
                routesCount = Object.keys(data.distance_km || {}).length;
                wpCount = Object.values(data.waypoints || {}).filter(w => w && w.length > 0).length;
                
                document.getElementById('file1Schema').textContent = 
                    'Format: OLD (index-based)\n' +
                    'Keys: ' + Object.keys(data).join(', ') + '\n' +
                    'Sample key: "0_1" (index_index)';
            } else if (isNewFormat) {
                sitesCount = Object.keys(data.sites).length;
                routesCount = Object.keys(data.results || {}).length;
                wpCount = Object.values(data.results || {}).filter(r => r.waypoints && r.waypoints.length > 0).length;
                
                document.getElementById('file1Schema').textContent = 
                    'Format: NEW (site_id-based)\n' +
                    'Keys: ' + Object.keys(data).join(', ') + '\n' +
                    'Sample key: "RUHSM001__RUHSM002"';
            } else {
                throw new Error('Unknown format');
            }
            
            document.getElementById('f1Sites').textContent = sitesCount.toLocaleString();
            document.getElementById('f1Routes').textContent = routesCount.toLocaleString();
            document.getElementById('f1Waypoints').textContent = wpCount.toLocaleString();
            
            document.getElementById('file1Info').style.display = 'block';
            document.getElementById('file1Info').className = 'file-info success';
            document.getElementById('file1Info').textContent = '‚úì Loaded: ' + file.name;
            document.getElementById('file1Stats').style.display = 'grid';
            document.getElementById('file1Schema').style.display = 'block';
            
            log('File 1 loaded: ' + routesCount + ' routes, ' + sitesCount + ' sites');
            checkMergeReady();
            
        } catch(err) {
            log('Error loading File 1: ' + err.message);
            document.getElementById('file1Info').style.display = 'block';
            document.getElementById('file1Info').className = 'file-info error';
            document.getElementById('file1Info').textContent = '‚úó Error: ' + err.message;
        }
    };
    reader.readAsText(file);
}

function loadFile2(input) {
    const file = input.files[0];
    if (!file) return;
    
    log('Loading File 2: ' + file.name);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            file2Data = data;
            
            // Detect format
            const isOldFormat = Array.isArray(data.sites) && data.distance_km;
            const isNewFormat = data.results && typeof data.sites === 'object' && !Array.isArray(data.sites);
            
            let sitesCount, routesCount, wpCount;
            
            if (isOldFormat) {
                sitesCount = data.sites.length;
                routesCount = Object.keys(data.distance_km || {}).length;
                wpCount = Object.values(data.waypoints || {}).filter(w => w && w.length > 0).length;
                
                document.getElementById('file2Schema').textContent = 
                    'Format: OLD (index-based)\n' +
                    'Keys: ' + Object.keys(data).join(', ') + '\n' +
                    'Sample key: "0_1" (index_index)';
            } else if (isNewFormat) {
                sitesCount = Object.keys(data.sites).length;
                routesCount = Object.keys(data.results || {}).length;
                wpCount = Object.values(data.results || {}).filter(r => r.waypoints && r.waypoints.length > 0).length;
                
                document.getElementById('file2Schema').textContent = 
                    'Format: NEW (site_id-based)\n' +
                    'Keys: ' + Object.keys(data).join(', ') + '\n' +
                    'Sample key: "RUHSM001__RUHSM002"';
            } else {
                throw new Error('Unknown format');
            }
            
            document.getElementById('f2Sites').textContent = sitesCount.toLocaleString();
            document.getElementById('f2Routes').textContent = routesCount.toLocaleString();
            document.getElementById('f2Waypoints').textContent = wpCount.toLocaleString();
            
            document.getElementById('file2Info').style.display = 'block';
            document.getElementById('file2Info').className = 'file-info success';
            document.getElementById('file2Info').textContent = '‚úì Loaded: ' + file.name;
            document.getElementById('file2Stats').style.display = 'grid';
            document.getElementById('file2Schema').style.display = 'block';
            
            log('File 2 loaded: ' + routesCount + ' routes, ' + sitesCount + ' sites');
            checkMergeReady();
            
        } catch(err) {
            log('Error loading File 2: ' + err.message);
            document.getElementById('file2Info').style.display = 'block';
            document.getElementById('file2Info').className = 'file-info error';
            document.getElementById('file2Info').textContent = '‚úó Error: ' + err.message;
        }
    };
    reader.readAsText(file);
}

function checkMergeReady() {
    document.getElementById('mergeBtn').disabled = !(file1Data && file2Data);
}

function convertOldToNew(oldData) {
    // Convert old format (index-based) to new format (site_id-based)
    const sites = {};
    const results = {};
    
    // Build sites map
    oldData.sites.forEach((site, idx) => {
        sites[site.site_id] = site;
    });
    
    // Convert routes
    const distKeys = Object.keys(oldData.distance_km || {});
    distKeys.forEach(key => {
        const [iStr, jStr] = key.split('_');
        const i = parseInt(iStr);
        const j = parseInt(jStr);
        
        if (i >= 0 && i < oldData.sites.length && j >= 0 && j < oldData.sites.length) {
            const originId = oldData.sites[i].site_id;
            const destId = oldData.sites[j].site_id;
            const newKey = originId + '__' + destId;
            
            // Convert waypoint indices to site_ids
            const wpIndices = oldData.waypoints[key] || [];
            const wpSiteIds = wpIndices.map(wpIdx => {
                if (wpIdx >= 0 && wpIdx < oldData.sites.length) {
                    return oldData.sites[wpIdx].site_id;
                }
                return null;
            }).filter(id => id !== null);
            
            results[newKey] = {
                distance_km: oldData.distance_km[key],
                time_min: oldData.time_min[key],
                waypoints: wpSiteIds
            };
        }
    });
    
    return { sites, results };
}

function convertNewToOld(newData, sitesList) {
    // Convert new format (site_id-based) to old format (index-based)
    // sitesList is the ordered array of sites
    
    const siteIdToIdx = {};
    sitesList.forEach((site, idx) => {
        siteIdToIdx[site.site_id] = idx;
    });
    
    const distance_km = {};
    const time_min = {};
    const waypoints = {};
    
    Object.entries(newData.results || {}).forEach(([key, result]) => {
        const [originId, destId] = key.split('__');
        const i = siteIdToIdx[originId];
        const j = siteIdToIdx[destId];
        
        if (i !== undefined && j !== undefined) {
            const oldKey = i + '_' + j;
            distance_km[oldKey] = result.distance_km;
            time_min[oldKey] = result.time_min;
            
            // Convert waypoint site_ids to indices
            const wpIndices = (result.waypoints || []).map(wpId => siteIdToIdx[wpId]).filter(idx => idx !== undefined);
            waypoints[oldKey] = wpIndices;
        }
    });
    
    return { distance_km, time_min, waypoints };
}

function mergeFiles() {
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    log('MERGING FILES...');
    
    // Detect formats
    const f1IsOld = Array.isArray(file1Data.sites) && file1Data.distance_km;
    const f2IsOld = Array.isArray(file2Data.sites) && file2Data.distance_km;
    
    // Convert both to new format for merging
    let data1, data2;
    
    if (f1IsOld) {
        log('Converting File 1 from OLD to NEW format...');
        data1 = convertOldToNew(file1Data);
    } else {
        data1 = { sites: file1Data.sites, results: file1Data.results };
    }
    
    if (f2IsOld) {
        log('Converting File 2 from OLD to NEW format...');
        data2 = convertOldToNew(file2Data);
    } else {
        data2 = { sites: file2Data.sites, results: file2Data.results };
    }
    
    // Merge sites
    const mergedSites = { ...data1.sites, ...data2.sites };
    log('Sites: ' + Object.keys(data1.sites).length + ' + ' + Object.keys(data2.sites).length + ' = ' + Object.keys(mergedSites).length + ' unique');
    
    // Merge results (file2 overwrites file1 for duplicates)
    const mergedResults = { ...data1.results, ...data2.results };
    
    const f1Routes = Object.keys(data1.results).length;
    const f2Routes = Object.keys(data2.results).length;
    const totalRoutes = Object.keys(mergedResults).length;
    const overlap = f1Routes + f2Routes - totalRoutes;
    
    log('Routes: ' + f1Routes + ' + ' + f2Routes + ' = ' + totalRoutes + ' unique (' + overlap + ' overlapping)');
    
    // Count waypoints
    const wpCount = Object.values(mergedResults).filter(r => r.waypoints && r.waypoints.length > 0).length;
    
    // Store merged data
    mergedData = {
        source: 'Merged',
        merged_date: new Date().toISOString(),
        file1_routes: f1Routes,
        file2_routes: f2Routes,
        sites: mergedSites,
        results: mergedResults
    };
    
    // Also store sites as array for old format export
    mergedData._sitesArray = Object.values(mergedSites);
    
    // Update UI
    document.getElementById('mergeInfo').style.display = 'block';
    document.getElementById('mergeInfo').textContent = '‚úì Merged successfully! ' + totalRoutes.toLocaleString() + ' total routes';
    document.getElementById('mergeStats').style.display = 'grid';
    document.getElementById('mSites').textContent = Object.keys(mergedSites).length.toLocaleString();
    document.getElementById('mRoutes').textContent = totalRoutes.toLocaleString();
    document.getElementById('mWaypoints').textContent = wpCount.toLocaleString();
    document.getElementById('downloadBtns').style.display = 'block';
    
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    log('MERGE COMPLETE!');
    log('Total sites: ' + Object.keys(mergedSites).length);
    log('Total routes: ' + totalRoutes);
    log('With waypoints: ' + wpCount);
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
}

function downloadMerged(format) {
    if (!mergedData) {
        alert('Merge files first!');
        return;
    }
    
    let output, filename;
    
    if (format === 'new') {
        // New format (site_id-based)
        output = {
            source: 'Merged OD Results',
            merged_date: mergedData.merged_date,
            total_routes: Object.keys(mergedData.results).length,
            sites: mergedData.sites,
            results: mergedData.results
        };
        filename = 'merged_od_results_' + Date.now() + '.json';
    } else {
        // Old format (index-based)
        const sitesList = mergedData._sitesArray;
        const converted = convertNewToOld(mergedData, sitesList);
        
        output = {
            source: 'Merged',
            merged_date: mergedData.merged_date,
            sites: sitesList,
            distance_km: converted.distance_km,
            time_min: converted.time_min,
            waypoints: converted.waypoints
        };
        filename = 'merged_google_matrix_' + Date.now() + '.json';
    }
    
    download(JSON.stringify(output, null, 2), filename, 'application/json');
    log('Downloaded: ' + filename);
}

function downloadCSV() {
    if (!mergedData) {
        alert('Merge files first!');
        return;
    }
    
    let csv = 'origin_site_id,destination_site_id,distance_km,time_min,waypoints\n';
    
    Object.entries(mergedData.results).forEach(([key, result]) => {
        const [origin, dest] = key.split('__');
        const wpStr = (result.waypoints || []).join(';');
        csv += origin + ',' + dest + ',' + result.distance_km.toFixed(3) + ',' + result.time_min.toFixed(2) + ',"' + wpStr + '"\n';
    });
    
    download(csv, 'merged_od_results_' + Date.now() + '.csv', 'text/csv');
    log('Downloaded CSV');
}

function download(content, filename, type) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type }));
    a.download = filename;
    a.click();
}

log('Ready! Upload both files to merge.');
    </script>
</body>
</html>
