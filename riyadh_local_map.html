<!DOCTYPE html>
<html>
<head>
    <title>Riyadh Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
        
        .panel {
            position: absolute; top: 10px; left: 60px;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); z-index: 1000;
            max-width: 300px; font-size: 13px;
        }
        .panel h2 { color: #1a73e8; margin-bottom: 10px; font-size: 16px; }
        .stats { display: flex; gap: 10px; margin: 10px 0; }
        .stat { background: #f5f5f5; padding: 10px; border-radius: 6px; text-align: center; flex: 1; }
        .stat b { display: block; font-size: 16px; }
        .stat small { color: #666; font-size: 10px; }
        .filters { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .filters label { display: inline-flex; align-items: center; gap: 5px; margin-right: 15px; cursor: pointer; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 450; }
        
        .loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 2000;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid #eee; border-top-color: #4285f4;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { margin-top: 20px; font-size: 16px; color: #333; }
        .progress { width: 300px; height: 6px; background: #eee; border-radius: 3px; margin-top: 15px; }
        .progress-bar { height: 100%; background: #4285f4; border-radius: 3px; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="status">Loading...</p>
        <div class="progress"><div id="progress" class="progress-bar" style="width:0%"></div></div>
    </div>
    
    <div id="map"></div>
    <canvas id="canvas"></canvas>
    
    <div class="panel">
        <h2>üèôÔ∏è Riyadh Map</h2>
        <div class="stats">
            <div class="stat" style="border-left:3px solid #34a853">
                <b id="villa-count">0</b>
                <small>üè† Villas</small>
            </div>
            <div class="stat" style="border-left:3px solid #4285f4">
                <b id="apt-count">0</b>
                <small>üè¢ Apartments</small>
            </div>
        </div>
        <div class="filters">
            <label><input type="checkbox" id="showV" checked><span class="dot" style="background:#34a853"></span> Villas</label>
            <label><input type="checkbox" id="showA" checked><span class="dot" style="background:#4285f4"></span> Apartments</label>
        </div>
        <div style="margin-top:10px;font-size:11px;color:#888;">
            Showing: <span id="visible">0</span> points | Zoom: <span id="zoom">0</span>
        </div>
    </div>

    <script>
        let map, villas = [], apts = [];
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let mapsLoadAttempts = 0;
        const MAX_LOAD_ATTEMPTS = 100;
        
        function status(msg, pct) {
            document.getElementById('status').textContent = msg;
            document.getElementById('progress').style.width = pct + '%';
        }
        
        // Wait for Google Maps API to be available
        function waitForGoogleMaps() {
            mapsLoadAttempts++;
            if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
                console.log('Google Maps API loaded after', mapsLoadAttempts, 'attempts');
                initMap();
            } else if (mapsLoadAttempts < MAX_LOAD_ATTEMPTS) {
                setTimeout(waitForGoogleMaps, 100);
            } else {
                status('Error: Google Maps failed to load. Please refresh.', 0);
            }
        }
        
        // Start checking when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForGoogleMaps);
        } else {
            waitForGoogleMaps();
        }
        
        function initMap() {
            if (map) return; // Prevent double initialization
            
            status('Initializing Google Maps...', 5);
            
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 24.7136, lng: 46.6753 },
                    zoom: 11,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true
                });
                
                map.addListener('idle', render);
                window.addEventListener('resize', render);
                
                loadData();
            } catch (err) {
                status('Error initializing map: ' + err.message, 0);
            }
        }
        
        // Expose for callback compatibility
        window.initMap = initMap;
        
        async function loadData() {
            try {
                // Load villas from local file
                status('Loading villas_geo.json...', 20);
                const vRes = await fetch('villas_geo.json');
                if (!vRes.ok) throw new Error('villas_geo.json not found');
                villas = await vRes.json();
                document.getElementById('villa-count').textContent = villas.length.toLocaleString();
                
                // Load apartments from local file
                status('Loading apartments_geo.json...', 60);
                const aRes = await fetch('apartments_geo.json');
                if (!aRes.ok) throw new Error('apartments_geo.json not found');
                apts = await aRes.json();
                document.getElementById('apt-count').textContent = apts.length.toLocaleString();
                
                status('Rendering...', 90);
                console.log('Loaded:', villas.length, 'villas,', apts.length, 'apartments');
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    render();
                }, 100);
                
            } catch (e) {
                status('Error: ' + e.message, 0);
                console.error(e);
            }
        }
        
        function render() {
            if (!map) return;
            
            const bounds = map.getBounds();
            const proj = map.getProjection();
            if (!bounds || !proj) return;
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const zoom = map.getZoom();
            const ne = bounds.getNorthEast(), sw = bounds.getSouthWest();
            
            document.getElementById('zoom').textContent = zoom;
            
            // Sample rate - show fewer points when zoomed out
            let sample = 1;
            if (zoom <= 9) sample = 50;
            else if (zoom <= 10) sample = 20;
            else if (zoom <= 11) sample = 10;
            else if (zoom <= 12) sample = 5;
            else if (zoom <= 13) sample = 2;
            
            const ps = Math.max(1, Math.min(zoom - 9, 5)); // point size
            let visible = 0;
            
            function toPixel(lat, lng) {
                const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lng));
                const tr = proj.fromLatLngToPoint(ne);
                const bl = proj.fromLatLngToPoint(sw);
                const scale = Math.pow(2, zoom);
                return { x: (w.x - bl.x) * scale, y: (w.y - tr.y) * scale };
            }
            
            function inBounds(lat, lng) {
                return lat >= sw.lat() && lat <= ne.lat() && lng >= sw.lng() && lng <= ne.lng();
            }
            
            // Draw villas (green)
            if (document.getElementById('showV').checked) {
                ctx.fillStyle = 'rgba(52, 168, 83, 0.6)';
                for (let i = 0; i < villas.length; i += sample) {
                    const [lat, lng] = villas[i];
                    if (inBounds(lat, lng)) {
                        const p = toPixel(lat, lng);
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, ps, 0, Math.PI * 2);
                        ctx.fill();
                        visible++;
                    }
                }
            }
            
            // Draw apartments (blue)
            if (document.getElementById('showA').checked) {
                ctx.fillStyle = 'rgba(66, 133, 244, 0.7)';
                for (let i = 0; i < apts.length; i += sample) {
                    const [lat, lng] = apts[i];
                    if (inBounds(lat, lng)) {
                        const p = toPixel(lat, lng);
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, ps, 0, Math.PI * 2);
                        ctx.fill();
                        visible++;
                    }
                }
            }
            
            document.getElementById('visible').textContent = visible.toLocaleString();
        }
        
        document.getElementById('showV').addEventListener('change', render);
        document.getElementById('showA').addEventListener('change', render);
    </script>
    <script src="https://somanchiu.github.io/Keyless-Google-Maps-API/mapsJavaScriptAPI.js" async defer></script>
</body>
</html>
