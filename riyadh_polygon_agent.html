<!DOCTYPE html>
<html>
<head>
    <title>Riyadh Smart Agent - Detect Mislabeled Places</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
        
        .panel {
            position: absolute; top: 10px; left: 60px;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); z-index: 1000;
            max-width: 340px; max-height: 50vh; overflow-y: auto; font-size: 13px;
        }
        .panel h2 { color: #1a73e8; margin-bottom: 10px; font-size: 16px; }
        
        .file-section { margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .file-section label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 12px; }
        .file-section input[type="file"] { font-size: 11px; width: 100%; }
        .file-status { font-size: 11px; color: #666; margin-top: 5px; }
        .file-status.loaded { color: #34a853; }
        
        .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; vertical-align: middle; }
        
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 450; }
        
        .agent-panel {
            position: absolute; top: 10px; right: 10px;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); z-index: 1000;
            width: 400px; max-height: 90vh; overflow-y: auto; font-size: 13px;
        }
        .agent-panel h2 { color: #9c27b0; margin-bottom: 10px; font-size: 16px; }
        
        .instructions {
            background: #f3e5f5; padding: 10px; border-radius: 8px;
            margin: 10px 0; font-size: 11px; color: #7b1fa2;
        }
        
        .tool-section {
            margin: 10px 0; padding: 10px; background: #ede7f6; border-radius: 8px;
            display: flex; flex-wrap: wrap; gap: 5px;
        }
        
        .draw-btn {
            padding: 10px 15px;
            border: 2px solid #9c27b0; border-radius: 8px;
            background: white; color: #9c27b0;
            font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .draw-btn:hover { background: #f3e5f5; }
        .draw-btn.active { background: #9c27b0; color: white; }
        
        .action-btn {
            width: 100%; padding: 10px; margin: 4px 0;
            border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .scan-btn { background: #9c27b0; color: white; }
        .export-btn { background: #1a73e8; color: white; }
        .clear-btn { background: #ea4335; color: white; }
        
        .results-section {
            margin-top: 10px; border-top: 2px solid #9c27b0; padding-top: 10px;
        }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; flex-wrap: wrap; gap: 5px;
        }
        .results-count { font-weight: bold; color: #9c27b0; }
        
        .results-list {
            max-height: 320px; overflow-y: auto;
            border: 1px solid #e0e0e0; border-radius: 8px;
        }
        
        .result-item {
            padding: 10px; border-bottom: 1px solid #eee;
            display: flex; flex-direction: column; gap: 5px;
        }
        .result-item:last-child { border-bottom: none; }
        .result-item:hover { background: #fafafa; }
        .result-item.approved { background: #e8f5e9; }
        .result-item.rejected { background: #ffebee; opacity: 0.6; }
        .result-item.mislabeled { border-left: 4px solid #ff9800; }
        
        .result-header {
            display: flex; justify-content: space-between; align-items: center;
        }
        .result-name {
            font-weight: 600; font-size: 12px;
            max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .result-coords { font-size: 10px; color: #666; }
        
        .result-category {
            display: flex; align-items: center; gap: 8px;
        }
        .category-select {
            flex: 1; padding: 6px; border-radius: 6px;
            border: 1px solid #ddd; font-size: 12px;
        }
        
        .result-actions {
            display: flex; gap: 5px;
        }
        .result-actions button {
            padding: 5px 12px; border: none; border-radius: 4px;
            font-size: 11px; cursor: pointer;
        }
        .btn-approve { background: #34a853; color: white; }
        .btn-reject { background: #ea4335; color: white; }
        
        .mislabel-badge {
            font-size: 9px; padding: 2px 6px; border-radius: 10px;
            background: #ff9800; color: white; font-weight: bold;
        }
        .correct-badge {
            font-size: 9px; padding: 2px 6px; border-radius: 10px;
            background: #4caf50; color: white;
        }
        
        .original-label {
            font-size: 10px; color: #888; display: flex; align-items: center; gap: 5px;
        }
        .original-label .arrow { color: #9c27b0; font-weight: bold; }
        
        .stats-bar {
            display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;
        }
        .stat-item {
            padding: 6px 12px; background: #f5f5f5; border-radius: 8px;
            font-size: 12px; display: flex; align-items: center; gap: 6px;
        }
        .stat-item b { font-size: 16px; }
        
        .filter-bar {
            display: flex; gap: 5px; margin: 10px 0; flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 12px; border: 1px solid #ddd; border-radius: 15px;
            background: white; font-size: 11px; cursor: pointer;
        }
        .filter-btn.active { background: #9c27b0; color: white; border-color: #9c27b0; }
        
        .legend {
            margin: 10px 0; padding: 10px; background: #fff8e1; border-radius: 8px;
            font-size: 11px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    </style>
</head>
<body>
    <div id="map"></div>
    <canvas id="canvas"></canvas>
    
    <!-- Left Panel: Data Loaders -->
    <div class="panel">
        <h2>üó∫Ô∏è Riyadh Data Sources</h2>
        
        <div class="file-section">
            <label>üìä Land Use CSV (with lat, lng, category):</label>
            <input type="file" id="landUseFile" accept=".csv">
            <div id="landUseStatus" class="file-status">No file loaded</div>
        </div>
        
        <div class="file-section">
            <label>üè™ Embedded Businesses:</label>
            <div id="businessStatus" class="file-status">Loading...</div>
        </div>
        
        <div class="legend">
            <strong>3 Categories:</strong>
            <div class="legend-item"><span class="dot" style="background:#34a853;"></span> Villa (ÿ≥ŸÉŸÜŸäÿå ŸÅŸäŸÑÿß)</div>
            <div class="legend-item"><span class="dot" style="background:#4285f4;"></span> Apartment (ÿ¥ŸÇŸÇÿå ŸÅŸÜÿØŸÇ)</div>
            <div class="legend-item"><span class="dot" style="background:#ea4335;"></span> Business (ŸÉŸÑ ÿ¥Ÿäÿ° ÿ¢ÿÆÿ±)</div>
        </div>
        
        <div style="margin: 10px 0; padding: 8px; background: #e3f2fd; border-radius: 6px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" id="showData" checked>
                Show data points on map
            </label>
        </div>
        
        <div style="font-size:11px;color:#666;margin-top:10px;">
            Zoom: <span id="zoom">0</span> | 
            Points: <span id="visible">0</span>
        </div>
    </div>
    
    <!-- Right Panel: Agent Controls -->
    <div class="agent-panel">
        <h2>ü§ñ Smart Mislabel Detector</h2>
        
        <div class="instructions">
            <strong>How it works:</strong><br>
            1. Load your Land Use CSV (or use embedded data)<br>
            2. Draw a polygon around an area<br>
            3. Agent scans and detects <b>mislabeled</b> places<br>
            &nbsp;&nbsp;&nbsp;(e.g., "Tahakom HQ" labeled as Apartment ‚Üí Business)<br>
            4. Review, correct, approve, then export
        </div>
        
        <div class="tool-section">
            <button class="draw-btn" id="drawBtn" onclick="startDrawing()">‚úèÔ∏è Draw Polygon</button>
            <button class="draw-btn" id="finishBtn" onclick="finishDrawing()" style="display:none;background:#34a853;color:white;border-color:#34a853;">‚úì Finish</button>
            <button class="draw-btn" onclick="clearPolygon()">üóëÔ∏è Clear</button>
        </div>
        
        <button class="action-btn scan-btn" id="scanBtn" onclick="scanPolygon()" disabled>
            üîç Scan & Detect Mislabels
        </button>
        
        <div class="stats-bar" id="statsBar" style="display:none;">
            <div class="stat-item"><span class="dot" style="background:#34a853;"></span><b id="statVilla">0</b> Villa</div>
            <div class="stat-item"><span class="dot" style="background:#4285f4;"></span><b id="statApartment">0</b> Apt</div>
            <div class="stat-item"><span class="dot" style="background:#ea4335;"></span><b id="statBusiness">0</b> Biz</div>
            <div class="stat-item" style="background:#fff3e0;"><span class="mislabel-badge">!</span><b id="statMislabeled">0</b> Mislabeled</div>
        </div>
        
        <div class="filter-bar" id="filterBar" style="display:none;">
            <button class="filter-btn active" onclick="filterResults('all')">All</button>
            <button class="filter-btn" onclick="filterResults('mislabeled')">‚ö†Ô∏è Mislabeled</button>
            <button class="filter-btn" onclick="filterResults('approved')">‚úÖ Approved</button>
            <button class="filter-btn" onclick="filterResults('rejected')">‚ùå Rejected</button>
        </div>
        
        <div class="results-section" id="resultsSection" style="display:none;">
            <div class="results-header">
                <span class="results-count">Found: <span id="resultsCount">0</span> places</span>
                <button class="action-btn" style="width:auto;padding:6px 12px;font-size:11px;background:#34a853;color:white;" onclick="approveAll()">
                    ‚úÖ Approve All Corrections
                </button>
            </div>
            
            <div class="results-list" id="resultsList"></div>
            
            <button class="action-btn export-btn" onclick="exportCSV()" style="margin-top:10px;">
                üì• Export Approved to CSV
            </button>
            <button class="action-btn clear-btn" onclick="clearResults()">
                üóëÔ∏è Clear Results
            </button>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let map, currentPolygon = null;
        let businesses = [];      // Embedded business data
        let landUsePoints = [];   // From loaded CSV
        let allDataPoints = [];   // Combined for scanning
        let detectedPlaces = [];
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // ========== 3 SIMPLE CATEGORIES ==========
        const categories = {
            villa: {
                color: '#34a853',
                emoji: 'üè†',
                label: 'Villa'
            },
            apartment: {
                color: '#4285f4', 
                emoji: 'üè¢',
                label: 'Apartment'
            },
            business: {
                color: '#ea4335',
                emoji: 'üè™',
                label: 'Business'
            }
        };
        
        // ========== SMART CLASSIFICATION RULES ==========
        // Keywords that indicate BUSINESS (not apartment/villa)
        const businessKeywords = [
            // English
            'hq', 'headquarters', 'office', 'company', 'corp', 'inc', 'ltd',
            'restaurant', 'cafe', 'coffee', 'food', 'grill', 'kitchen',
            'bank', 'atm', 'pharmacy', 'clinic', 'hospital', 'medical',
            'shop', 'store', 'market', 'mall', 'supermarket', 'hypermarket',
            'gas', 'fuel', 'petrol', 'station',
            'school', 'university', 'college', 'institute', 'academy',
            'mosque', 'church', 'masjid',
            'police', 'fire', 'government', 'ministry', 'authority', 'embassy',
            'gym', 'fitness', 'salon', 'spa', 'barber',
            'car', 'auto', 'garage', 'repair', 'wash',
            'hotel', // Note: hotels are businesses, not apartments
            'tower', 'center', 'centre', 'plaza', 'complex',
            // Arabic
            'ŸÖŸÇÿ±', 'ÿ¥ÿ±ŸÉÿ©', 'ŸÖÿ§ÿ≥ÿ≥ÿ©', 'ŸÖŸÉÿ™ÿ®',
            'ŸÖÿ∑ÿπŸÖ', 'ŸÖŸÇŸáŸâ', 'ŸÇŸáŸàÿ©', 'ŸÉÿßŸÅŸäŸá', 'ŸÖÿÆÿ®ÿ≤',
            'ÿ®ŸÜŸÉ', 'ÿµÿ±ÿßŸÅ', 'ÿµŸäÿØŸÑŸäÿ©', 'ÿπŸäÿßÿØÿ©', 'ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ', 'ÿ∑ÿ®Ÿä',
            'ŸÖÿ≠ŸÑ', 'ŸÖÿ™ÿ¨ÿ±', 'ÿ≥ŸàŸÇ', 'ŸÖŸàŸÑ', 'ŸáÿßŸäÿ®ÿ±', 'ÿ≥Ÿàÿ®ÿ±',
            'ŸÖÿ≠ÿ∑ÿ©', 'ÿ®ŸÜÿ≤ŸäŸÜ', 'ŸàŸÇŸàÿØ',
            'ŸÖÿØÿ±ÿ≥ÿ©', 'ÿ¨ÿßŸÖÿπÿ©', 'ŸÉŸÑŸäÿ©', 'ŸÖÿπŸáÿØ', 'ÿ£ŸÉÿßÿØŸäŸÖŸäÿ©',
            'ŸÖÿ≥ÿ¨ÿØ', 'ÿ¨ÿßŸÖÿπ',
            'ÿ¥ÿ±ÿ∑ÿ©', 'ÿ•ÿ∑ŸÅÿßÿ°', 'ÿ≠ŸÉŸàŸÖÿ©', 'Ÿàÿ≤ÿßÿ±ÿ©', 'ŸáŸäÿ¶ÿ©', 'ÿ≥ŸÅÿßÿ±ÿ©',
            'ÿµÿßŸÑÿ©', 'ÿµÿßŸÑŸàŸÜ', 'ÿ≠ŸÑÿßŸÇ',
            'ÿ≥Ÿäÿßÿ±ÿßÿ™', 'Ÿàÿ±ÿ¥ÿ©', 'ÿ∫ÿ≥ŸäŸÑ',
            'ŸÅŸÜÿØŸÇ', 'ŸÜÿ≤ŸÑ', // Hotels are businesses
            'ÿ®ÿ±ÿ¨', 'ŸÖÿ±ŸÉÿ≤', 'ÿ®ŸÑÿßÿ≤ÿß', 'ŸÖÿ¨ŸÖÿπ',
            'ÿ™ÿ≠ŸÉŸÖ', 'tahakom' // Specific example user mentioned
        ];
        
        // Keywords that indicate APARTMENT (residential units, not hotels)
        const apartmentKeywords = [
            'apartment', 'apartments', 'flat', 'flats', 'unit', 'units',
            'furnished', 'residential', 'residence', 'housing',
            'ÿ¥ŸÇÿ©', 'ÿ¥ŸÇŸÇ', 'ŸÖŸÅÿ±Ÿàÿ¥ÿ©', 'ŸÖŸÅÿ±Ÿàÿ¥', 'ÿ≥ŸÉŸÜŸä', 'ÿ≥ŸÉŸÜ', 'ÿ•ŸÇÿßŸÖÿ©',
            'ÿπŸÖÿßÿ±ÿ©', 'Ÿàÿ≠ÿØÿßÿ™'
        ];
        
        // Keywords that indicate VILLA
        const villaKeywords = [
            'villa', 'villas', 'house', 'home', 'duplex', 'mansion', 'palace',
            'ŸÅŸäŸÑÿß', 'ŸÅŸÑŸÑ', 'ŸÖŸÜÿ≤ŸÑ', 'ÿ®Ÿäÿ™', 'ÿØŸàÿ®ŸÑŸÉÿ≥', 'ŸÇÿµÿ±'
        ];
        
        // Subcategories from data that mean BUSINESS
        const businessSubcategories = [
            'restaurant', 'fast_food', 'cafe', 'bar', 'food_court',
            'bank', 'atm', 'pharmacy', 'clinic', 'hospital', 'doctors',
            'shop', 'supermarket', 'mall', 'convenience', 'retail',
            'fuel', 'car_wash', 'car_repair', 'car_rental',
            'school', 'university', 'college', 'kindergarten',
            'place_of_worship', 'mosque', 'church',
            'police', 'fire_station', 'government', 'embassy', 'diplomatic',
            'gym', 'fitness', 'sports',
            'hotel', 'hostel', 'motel', 'guest_house', // Hotels = business
            'office', 'company', 'coworking',
            'parking', 'bus_station', 'taxi'
        ];
        
        // Subcategories that mean APARTMENT
        const apartmentSubcategories = [
            'apartment', 'apartments', 'residential', 'furnished'
        ];
        
        // Subcategories that mean VILLA
        const villaSubcategories = [
            'villa', 'villas', 'house', 'detached'
        ];
        
        // ========== SMART CLASSIFICATION FUNCTION ==========
        function classifyPlace(name, originalCategory, subcategory) {
            name = (name || '').toLowerCase();
            originalCategory = (originalCategory || '').toLowerCase();
            subcategory = (subcategory || '').toLowerCase();
            
            const allText = `${name} ${originalCategory} ${subcategory}`;
            
            // Check for BUSINESS indicators (strongest signal)
            for (const keyword of businessKeywords) {
                if (allText.includes(keyword.toLowerCase())) {
                    return 'business';
                }
            }
            
            // Check subcategories
            for (const sub of businessSubcategories) {
                if (subcategory.includes(sub) || originalCategory.includes(sub)) {
                    return 'business';
                }
            }
            
            // Check for VILLA indicators
            for (const keyword of villaKeywords) {
                if (allText.includes(keyword.toLowerCase())) {
                    return 'villa';
                }
            }
            for (const sub of villaSubcategories) {
                if (subcategory.includes(sub) || originalCategory.includes(sub)) {
                    return 'villa';
                }
            }
            
            // Check for APARTMENT indicators
            for (const keyword of apartmentKeywords) {
                if (allText.includes(keyword.toLowerCase())) {
                    return 'apartment';
                }
            }
            for (const sub of apartmentSubcategories) {
                if (subcategory.includes(sub) || originalCategory.includes(sub)) {
                    return 'apartment';
                }
            }
            
            // Default: if can't determine, it's probably a business
            return 'business';
        }
        
        // Map original labels to our 3 categories
        function mapOriginalToCategory(originalCategory, subcategory) {
            originalCategory = (originalCategory || '').toLowerCase();
            subcategory = (subcategory || '').toLowerCase();
            
            // Check for villa
            if (originalCategory.includes('villa') || subcategory.includes('villa') ||
                originalCategory.includes('1000') || originalCategory.includes('1012')) {
                return 'villa';
            }
            
            // Check for apartment
            if (originalCategory.includes('apartment') || subcategory.includes('apartment') ||
                originalCategory.includes('7510') || originalCategory.includes('residential') ||
                subcategory.includes('furnished')) {
                return 'apartment';
            }
            
            // Everything else is business
            return 'business';
        }
        
        // ========== EMBEDDED BUSINESSES ==========
        const EMBEDDED_BUSINESSES = %%EMBEDDED_DATA%%;
        
        function loadBusinesses() {
            businesses = EMBEDDED_BUSINESSES.map(biz => ({
                lat: biz[0],
                lng: biz[1],
                name: biz[2] || 'Unnamed',
                category: biz[3] || '',
                subcategory: biz[4] || '',
                source: 'businesses'
            }));
            
            console.log(`Loaded ${businesses.length} embedded businesses`);
            document.getElementById('businessStatus').textContent = `‚úÖ ${businesses.length.toLocaleString()} businesses`;
            document.getElementById('businessStatus').className = 'file-status loaded';
            
            updateAllDataPoints();
            if (map) render();
        }
        
        function updateAllDataPoints() {
            allDataPoints = [...landUsePoints, ...businesses];
            console.log(`Total data points: ${allDataPoints.length}`);
        }
        
        // ========== MAP INITIALIZATION ==========
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 24.7136, lng: 46.6753 },
                zoom: 12,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true
            });
            
            map.addListener('click', function(e) {
                if (isDrawingMode) {
                    addPolygonPoint(e.latLng);
                }
            });
            
            map.addListener('idle', render);
            window.addEventListener('resize', render);
            
            loadBusinesses();
        }
        
        // ========== POLYGON DRAWING ==========
        let isDrawingMode = false;
        let polygonPoints = [];
        let polygonMarkers = [];
        let polygonLines = [];
        
        function startDrawing() {
            clearPolygon();
            isDrawingMode = true;
            document.getElementById('drawBtn').classList.add('active');
            document.getElementById('drawBtn').textContent = '‚úèÔ∏è Click map...';
            document.getElementById('finishBtn').style.display = 'inline-block';
            map.setOptions({ draggableCursor: 'crosshair' });
        }
        
        function addPolygonPoint(latLng) {
            polygonPoints.push(latLng);
            
            const marker = new google.maps.Marker({
                position: latLng,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#9c27b0',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                },
                draggable: true,
                zIndex: 2000
            });
            
            const idx = polygonPoints.length - 1;
            marker.addListener('drag', function() {
                polygonPoints[idx] = marker.getPosition();
                updatePolygonLines();
            });
            
            polygonMarkers.push(marker);
            updatePolygonLines();
            
            if (polygonPoints.length >= 3) {
                document.getElementById('scanBtn').disabled = false;
            }
        }
        
        function updatePolygonLines() {
            polygonLines.forEach(line => line.setMap(null));
            polygonLines = [];
            
            if (polygonPoints.length < 2) return;
            
            for (let i = 0; i < polygonPoints.length; i++) {
                const nextIdx = (i + 1) % polygonPoints.length;
                const line = new google.maps.Polyline({
                    path: [polygonPoints[i], polygonPoints[nextIdx]],
                    strokeColor: '#9c27b0',
                    strokeWeight: 3,
                    strokeOpacity: 0.8,
                    map: map
                });
                polygonLines.push(line);
            }
            
            if (currentPolygon) currentPolygon.setMap(null);
            if (polygonPoints.length >= 3) {
                currentPolygon = new google.maps.Polygon({
                    paths: polygonPoints,
                    fillColor: '#9c27b0',
                    fillOpacity: 0.15,
                    strokeWeight: 0,
                    map: map
                });
            }
        }
        
        function finishDrawing() {
            isDrawingMode = false;
            document.getElementById('drawBtn').classList.remove('active');
            document.getElementById('drawBtn').textContent = '‚úèÔ∏è Draw Polygon';
            document.getElementById('finishBtn').style.display = 'none';
            map.setOptions({ draggableCursor: null });
        }
        
        function clearPolygon() {
            isDrawingMode = false;
            polygonPoints = [];
            polygonMarkers.forEach(m => m.setMap(null));
            polygonMarkers = [];
            polygonLines.forEach(l => l.setMap(null));
            polygonLines = [];
            if (currentPolygon) {
                currentPolygon.setMap(null);
                currentPolygon = null;
            }
            document.getElementById('drawBtn').classList.remove('active');
            document.getElementById('drawBtn').textContent = '‚úèÔ∏è Draw Polygon';
            document.getElementById('finishBtn').style.display = 'none';
            document.getElementById('scanBtn').disabled = true;
            map.setOptions({ draggableCursor: null });
            clearResults();
        }
        
        // ========== POINT IN POLYGON ==========
        function isPointInPolygon(lat, lng) {
            if (polygonPoints.length < 3) return false;
            
            let inside = false;
            const n = polygonPoints.length;
            
            for (let i = 0, j = n - 1; i < n; j = i++) {
                const xi = polygonPoints[i].lat(), yi = polygonPoints[i].lng();
                const xj = polygonPoints[j].lat(), yj = polygonPoints[j].lng();
                
                if (((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            
            return inside;
        }
        
        // ========== SCAN & DETECT MISLABELS ==========
        function scanPolygon() {
            if (polygonPoints.length < 3) {
                alert('Please draw a polygon with at least 3 points!');
                return;
            }
            
            clearResultMarkers();
            detectedPlaces = [];
            
            let found = 0;
            let mislabelCount = 0;
            
            for (const point of allDataPoints) {
                if (isPointInPolygon(point.lat, point.lng)) {
                    // What does the original data say?
                    const originalLabel = mapOriginalToCategory(point.category, point.subcategory);
                    
                    // What does the agent think based on the name and context?
                    const agentLabel = classifyPlace(point.name, point.category, point.subcategory);
                    
                    // Is it mislabeled?
                    const isMislabeled = originalLabel !== agentLabel;
                    if (isMislabeled) mislabelCount++;
                    
                    // Use agent's suggestion as the assigned category
                    const assignedCategory = agentLabel;
                    
                    const marker = new google.maps.Marker({
                        position: { lat: point.lat, lng: point.lng },
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: isMislabeled ? 14 : 10,
                            fillColor: categories[assignedCategory].color,
                            fillOpacity: 0.9,
                            strokeColor: isMislabeled ? '#ff9800' : '#ffffff',
                            strokeWeight: isMislabeled ? 3 : 2
                        },
                        zIndex: isMislabeled ? 1600 : 1500
                    });
                    
                    const infoContent = `
                        <div style="padding:8px;max-width:280px;">
                            <strong>${point.name}</strong><br>
                            <small>Source: ${point.source}</small><br>
                            <small>Original Data: ${point.category}/${point.subcategory}</small><br>
                            <hr style="margin:5px 0;">
                            <small>Original Label: <b>${originalLabel}</b></small><br>
                            <small>Agent Suggests: <b>${agentLabel}</b></small><br>
                            ${isMislabeled ? '<span style="color:#ff9800;font-weight:bold;">‚ö†Ô∏è MISLABELED</span>' : '<span style="color:#4caf50;">‚úì Correct</span>'}
                        </div>
                    `;
                    const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                    marker.addListener('click', () => infoWindow.open(map, marker));
                    
                    detectedPlaces.push({
                        lat: point.lat,
                        lng: point.lng,
                        name: point.name,
                        source: point.source,
                        originalCategory: point.category,
                        originalSubcategory: point.subcategory,
                        originalLabel: originalLabel,
                        agentLabel: agentLabel,
                        assignedCategory: assignedCategory,
                        isMislabeled: isMislabeled,
                        status: 'pending',
                        marker
                    });
                    
                    found++;
                }
            }
            
            console.log(`Found ${found} places, ${mislabelCount} mislabeled`);
            
            if (found === 0) {
                alert('No places found inside the polygon. Try a larger area or different location.');
                return;
            }
            
            showResults();
        }
        
        // ========== RESULTS DISPLAY ==========
        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('filterBar').style.display = 'flex';
            
            updateStats();
            renderResultsList('all');
        }
        
        function updateStats() {
            const counts = { villa: 0, apartment: 0, business: 0, mislabeled: 0 };
            
            for (const place of detectedPlaces) {
                if (place.status !== 'rejected') {
                    counts[place.assignedCategory]++;
                    if (place.isMislabeled) counts.mislabeled++;
                }
            }
            
            document.getElementById('statVilla').textContent = counts.villa;
            document.getElementById('statApartment').textContent = counts.apartment;
            document.getElementById('statBusiness').textContent = counts.business;
            document.getElementById('statMislabeled').textContent = counts.mislabeled;
            document.getElementById('resultsCount').textContent = detectedPlaces.length;
        }
        
        function renderResultsList(filter) {
            const listEl = document.getElementById('resultsList');
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.textContent.toLowerCase();
                if ((filter === 'all' && btnText.includes('all')) ||
                    (filter === 'mislabeled' && btnText.includes('mislabel')) ||
                    (filter === 'approved' && btnText.includes('approved')) ||
                    (filter === 'rejected' && btnText.includes('rejected'))) {
                    btn.classList.add('active');
                }
            });
            
            let filtered = detectedPlaces;
            if (filter === 'mislabeled') {
                filtered = detectedPlaces.filter(p => p.isMislabeled && p.status !== 'rejected');
            } else if (filter === 'approved') {
                filtered = detectedPlaces.filter(p => p.status === 'approved');
            } else if (filter === 'rejected') {
                filtered = detectedPlaces.filter(p => p.status === 'rejected');
            }
            
            if (filtered.length === 0) {
                listEl.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">No places to show</div>';
                return;
            }
            
            let html = '';
            filtered.forEach((place) => {
                const realIdx = detectedPlaces.indexOf(place);
                const catInfo = categories[place.assignedCategory];
                const statusClass = place.status === 'approved' ? 'approved' : (place.status === 'rejected' ? 'rejected' : '');
                const mislabelClass = place.isMislabeled ? 'mislabeled' : '';
                
                html += `
                    <div class="result-item ${statusClass} ${mislabelClass}" id="result-${realIdx}">
                        <div class="result-header">
                            <span class="result-name" title="${place.name}">${catInfo.emoji} ${place.name}</span>
                            ${place.isMislabeled ? '<span class="mislabel-badge">‚ö†Ô∏è Mislabeled</span>' : '<span class="correct-badge">‚úì</span>'}
                        </div>
                        <div class="original-label">
                            Was: <b>${place.originalLabel}</b> 
                            <span class="arrow">‚Üí</span> 
                            Now: <b>${place.assignedCategory}</b>
                            <span style="color:#888;margin-left:5px;">(${place.originalCategory}/${place.originalSubcategory})</span>
                        </div>
                        <div class="result-coords">${place.lat.toFixed(5)}, ${place.lng.toFixed(5)} | ${place.source}</div>
                        <div class="result-category">
                            <select class="category-select" onchange="changeCategory(${realIdx}, this.value)">
                                <option value="villa" ${place.assignedCategory === 'villa' ? 'selected' : ''}>üè† Villa</option>
                                <option value="apartment" ${place.assignedCategory === 'apartment' ? 'selected' : ''}>üè¢ Apartment</option>
                                <option value="business" ${place.assignedCategory === 'business' ? 'selected' : ''}>üè™ Business</option>
                            </select>
                            <div class="result-actions">
                                <button class="btn-approve" onclick="setStatus(${realIdx}, 'approved')" ${place.status === 'approved' ? 'disabled' : ''}>‚úì</button>
                                <button class="btn-reject" onclick="setStatus(${realIdx}, 'rejected')" ${place.status === 'rejected' ? 'disabled' : ''}>‚úó</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        function filterResults(filter) { renderResultsList(filter); }
        
        function changeCategory(idx, newCategory) {
            detectedPlaces[idx].assignedCategory = newCategory;
            const catInfo = categories[newCategory];
            detectedPlaces[idx].marker.setIcon({
                path: google.maps.SymbolPath.CIRCLE,
                scale: 12,
                fillColor: catInfo.color,
                fillOpacity: 0.9,
                strokeColor: '#ffffff',
                strokeWeight: 2
            });
            updateStats();
        }
        
        function setStatus(idx, status) {
            detectedPlaces[idx].status = status;
            detectedPlaces[idx].marker.setOpacity(status === 'rejected' ? 0.3 : 1);
            
            const item = document.getElementById(`result-${idx}`);
            if (item) {
                item.className = `result-item ${status} ${detectedPlaces[idx].isMislabeled ? 'mislabeled' : ''}`;
                item.querySelector('.btn-approve').disabled = (status === 'approved');
                item.querySelector('.btn-reject').disabled = (status === 'rejected');
            }
            updateStats();
        }
        
        function approveAll() {
            detectedPlaces.forEach((place, idx) => {
                if (place.status !== 'rejected') setStatus(idx, 'approved');
            });
            renderResultsList('all');
        }
        
        // ========== EXPORT ==========
        function exportCSV() {
            const approved = detectedPlaces.filter(p => p.status === 'approved');
            
            if (approved.length === 0) {
                alert('No approved places to export. Please approve some places first.');
                return;
            }
            
            let csv = 'latitude,longitude,name,category,original_label,was_mislabeled,source\n';
            
            for (const place of approved) {
                const safeName = `"${(place.name || '').replace(/"/g, '""')}"`;
                csv += `${place.lat},${place.lng},${safeName},${place.assignedCategory},${place.originalLabel},${place.isMislabeled},${place.source}\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `riyadh_corrected_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            const mislabeledCount = approved.filter(p => p.isMislabeled).length;
            alert(`‚úÖ Exported ${approved.length} places (${mislabeledCount} were mislabeled and corrected)`);
        }
        
        // ========== CLEAR ==========
        function clearResultMarkers() {
            for (const place of detectedPlaces) {
                if (place.marker) place.marker.setMap(null);
            }
        }
        
        function clearResults() {
            clearResultMarkers();
            detectedPlaces = [];
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('statsBar').style.display = 'none';
            document.getElementById('filterBar').style.display = 'none';
        }
        
        // ========== CANVAS RENDERING ==========
        document.getElementById('showData').addEventListener('change', render);
        
        function render() {
            if (!map) return;
            
            const bounds = map.getBounds();
            const proj = map.getProjection();
            if (!bounds || !proj) return;
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const zoom = map.getZoom();
            const ne = bounds.getNorthEast(), sw = bounds.getSouthWest();
            
            document.getElementById('zoom').textContent = zoom;
            
            if (!document.getElementById('showData').checked) {
                document.getElementById('visible').textContent = '0';
                return;
            }
            
            let sample = 1;
            if (zoom <= 10) sample = 30;
            else if (zoom <= 12) sample = 10;
            else if (zoom <= 14) sample = 3;
            
            const baseSize = Math.max(3, Math.min(zoom - 9, 8));
            let visible = 0;
            
            function toPixel(lat, lng) {
                const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lng));
                const tr = proj.fromLatLngToPoint(ne);
                const bl = proj.fromLatLngToPoint(sw);
                const scale = Math.pow(2, zoom);
                return { x: (w.x - bl.x) * scale, y: (w.y - tr.y) * scale };
            }
            
            function inBounds(lat, lng) {
                return lat >= sw.lat() && lat <= ne.lat() && lng >= sw.lng() && lng <= ne.lng();
            }
            
            // Draw all data points
            for (let i = 0; i < allDataPoints.length; i += sample) {
                const point = allDataPoints[i];
                if (inBounds(point.lat, point.lng)) {
                    const p = toPixel(point.lat, point.lng);
                    
                    // Color based on what category we'd assign
                    const cat = classifyPlace(point.name, point.category, point.subcategory);
                    const color = categories[cat].color;
                    
                    ctx.fillStyle = color + 'cc';
                    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, baseSize, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    visible++;
                }
            }
            
            document.getElementById('visible').textContent = visible.toLocaleString();
        }
        
        // ========== LAND USE CSV LOADER ==========
        document.getElementById('landUseFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('landUseStatus').textContent = 'Loading...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.trim().split('\n');
                    const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
                    
                    const latIdx = headers.findIndex(h => h.includes('lat'));
                    const lngIdx = headers.findIndex(h => h.includes('lng') || h.includes('lon'));
                    const catIdx = headers.findIndex(h => h.includes('category') || h.includes('land_use') || h.includes('type'));
                    const nameIdx = headers.findIndex(h => h.includes('name'));
                    
                    if (latIdx === -1 || lngIdx === -1) {
                        throw new Error('CSV must have latitude and longitude columns');
                    }
                    
                    landUsePoints = [];
                    for (let i = 1; i < lines.length; i++) {
                        const vals = lines[i].split(',').map(v => v.trim().replace(/^["']|["']$/g, ''));
                        const lat = parseFloat(vals[latIdx]);
                        const lng = parseFloat(vals[lngIdx]);
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            landUsePoints.push({
                                lat, lng,
                                name: nameIdx !== -1 ? vals[nameIdx] : 'Unnamed',
                                category: catIdx !== -1 ? vals[catIdx] : '',
                                subcategory: '',
                                source: 'landuse_csv'
                            });
                        }
                    }
                    
                    document.getElementById('landUseStatus').textContent = `‚úÖ ${landUsePoints.length.toLocaleString()} points loaded`;
                    document.getElementById('landUseStatus').className = 'file-status loaded';
                    
                    updateAllDataPoints();
                    render();
                    
                } catch (err) {
                    document.getElementById('landUseStatus').textContent = '‚ùå ' + err.message;
                }
            };
            reader.readAsText(file);
        });
    </script>
    <script src="https://somanchiu.github.io/Keyless-Google-Maps-API/mapsJavaScriptAPI.js" async defer></script>
</body>
</html>
