<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ù…Ø§Ø¦Ø± Ø§Ù„Ø±ÙŠØ§Ø¶ - Riyadh Apartment Buildings Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
        }
        #map {
            position: fixed;
            top: 0;
            left: 0;
            right: 280px;
            bottom: 0;
        }
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #16213e 0%, #0f0f23 100%);
            color: #f5f5f5;
            overflow-y: auto;
            padding: 20px;
            border-left: 3px solid #e94560;
        }
        .sidebar h1 {
            color: #e94560;
            font-size: 1.3em;
            margin-bottom: 5px;
            text-align: center;
        }
        .sidebar h2 {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-bottom: 20px;
            font-weight: normal;
            text-align: center;
        }
        .stats-box {
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid #e94560;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .stats-box .big-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #e94560;
            text-align: center;
        }
        .stats-box .label {
            text-align: center;
            color: #a0a0a0;
            font-size: 0.9em;
        }
        .info-section {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .info-section h3 {
            color: #e94560;
            font-size: 1em;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
            padding-bottom: 5px;
        }
        .district-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .district-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85em;
        }
        .district-name {
            color: #f5f5f5;
        }
        .district-count {
            color: #e94560;
            font-weight: bold;
        }
        .source-info {
            text-align: center;
            font-size: 0.75em;
            color: #666;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .source-info a {
            color: #e94560;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(22, 33, 62, 0.95);
            padding: 30px 50px;
            border-radius: 15px;
            color: #e94560;
            font-size: 1.2em;
            z-index: 10000;
            border: 2px solid #e94560;
        }
        .loading.hidden {
            display: none;
        }
        .legend {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .legend-label {
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    
    <div id="map"></div>
    
    <div class="sidebar">
        <h1>ğŸ¢ Ø¹Ù…Ø§Ø¦Ø± Ø§Ù„Ø±ÙŠØ§Ø¶</h1>
        <h2>Apartment Buildings Map</h2>
        
        <div class="stats-box">
            <div class="big-number" id="totalCount">0</div>
            <div class="label">Ø¹Ù…Ø§Ø±Ø© Ø³ÙƒÙ†ÙŠØ©</div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <span class="legend-color" style="background: #e94560;"></span>
                <span class="legend-label">Ø¹Ù…Ø§Ø¦Ø± Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø¥ÙŠØ¬Ø§Ø±</span>
            </div>
        </div>
        
        <div class="info-section">
            <h3>ğŸ“Š Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</h3>
            <div class="district-list" id="districtList">
                <!-- Will be populated by JS -->
            </div>
        </div>
        
        <div class="info-section">
            <h3>â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
            <p style="font-size: 0.85em; color: #a0a0a0;">
                Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØ¹Ø±Ø¶ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù…Ø§Ø¦Ø± Ø§Ù„Ø³ÙƒÙ†ÙŠØ© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙÙ„Ù„).
                <br><br>
                Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ù‚Ø·Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ø§Ø±Ø©.
            </p>
        </div>
        
        <div class="source-info">
            Data source: <a href="https://sa.aqar.fm" target="_blank">Aqar.fm</a><br>
            Last updated: <span id="updateDate"></span>
        </div>
    </div>
    
    <script>
        // Data will be loaded here
        let apartmentsData = [];
        
        // Initialize map
        const map = L.map('map', {
            center: [24.7136, 46.6753],
            zoom: 11,
            preferCanvas: true
        });
        
        // Dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap Â© CARTO',
            maxZoom: 19
        }).addTo(map);
        
        // Load data
        fetch('aqar_apartments_detailed.json')
            .then(response => response.json())
            .then(data => {
                apartmentsData = data;
                displayData(data);
                document.getElementById('loading').classList.add('hidden');
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').textContent = 'Error loading data';
            });
        
        function displayData(data) {
            // Update total count
            document.getElementById('totalCount').textContent = data.length.toLocaleString('ar-SA');
            document.getElementById('updateDate').textContent = new Date().toLocaleDateString('ar-SA');
            
            // Count districts
            const districts = {};
            data.forEach(item => {
                const d = item.district || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                districts[d] = (districts[d] || 0) + 1;
            });
            
            // Display top districts
            const sortedDistricts = Object.entries(districts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            const districtList = document.getElementById('districtList');
            districtList.innerHTML = sortedDistricts.map(([name, count]) => `
                <div class="district-item">
                    <span class="district-name">${name}</span>
                    <span class="district-count">${count}</span>
                </div>
            `).join('');
            
            // Add markers
            const markers = [];
            data.forEach(item => {
                const marker = L.circleMarker([item.lat, item.lng], {
                    radius: 5,
                    fillColor: '#e94560',
                    color: '#e94560',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });
                
                // Format price
                let priceText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (item.price) {
                    priceText = item.price.toLocaleString('ar-SA') + ' Ø±ÙŠØ§Ù„';
                }
                
                // Popup content
                const popup = `
                    <div style="min-width: 200px; direction: rtl; text-align: right;">
                        <strong style="color: #e94560;">${item.title || 'Ø¹Ù…Ø§Ø±Ø© Ø³ÙƒÙ†ÙŠØ©'}</strong>
                        <hr style="margin: 5px 0; border-color: #eee;">
                        <table style="width: 100%; font-size: 12px;">
                            <tr><td>ğŸ“ Ø§Ù„Ø­ÙŠ:</td><td>${item.district || '-'}</td></tr>
                            <tr><td>ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</td><td>${priceText}</td></tr>
                            <tr><td>ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</td><td>${item.area_sqm ? item.area_sqm + ' Ù…Â²' : '-'}</td></tr>
                            <tr><td>ğŸ  Ø§Ù„Ø´Ù‚Ù‚:</td><td>${item.num_apartments || '-'}</td></tr>
                            <tr><td>ğŸšª Ø§Ù„ØºØ±Ù:</td><td>${item.num_rooms || '-'}</td></tr>
                            <tr><td>ğŸ“… Ø§Ù„Ø¹Ù…Ø±:</td><td>${item.age_years ? item.age_years + ' Ø³Ù†Ø©' : '-'}</td></tr>
                            <tr><td>ğŸª Ø§Ù„Ù…Ø­Ù„Ø§Øª:</td><td>${item.num_stores || '0'}</td></tr>
                        </table>
                    </div>
                `;
                
                marker.bindPopup(popup);
                markers.push(marker);
            });
            
            // Add all markers as a layer group
            const markersLayer = L.layerGroup(markers);
            markersLayer.addTo(map);
        }
    </script>
</body>
</html>
