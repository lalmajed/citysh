<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riyadh Buildings - CSV Upload</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a0a0a; }
        #map { position: fixed; top: 0; left: 350px; right: 0; bottom: 0; }
        
        .sidebar {
            position: fixed; left: 0; top: 0; width: 350px; height: 100vh;
            background: linear-gradient(180deg, #2d0a0a 0%, #1a0505 100%);
            color: #f5f5f5; overflow-y: auto; padding: 20px;
            border-right: 3px solid #800020;
        }
        
        h1 { color: #d4a574; font-size: 1.3em; margin-bottom: 5px; }
        .version { color: #666; font-size: 0.7em; }
        h2 { color: #c9a87c; font-size: 0.9em; margin-bottom: 20px; font-weight: normal; }
        
        /* FILE UPLOAD BOX */
        .upload-box {
            background: rgba(128,0,32,0.2);
            padding: 30px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 3px dashed #800020;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-box:hover {
            background: rgba(128,0,32,0.35);
            border-color: #ffd700;
        }
        .upload-box.dragging {
            background: rgba(128,0,32,0.5);
            border-color: #ffd700;
            transform: scale(1.02);
        }
        .upload-box.success {
            border-style: solid;
            border-color: #4CAF50;
            background: rgba(76,175,80,0.1);
        }
        
        .upload-box .icon { font-size: 4em; margin-bottom: 15px; }
        .upload-box .text { font-size: 1.1em; color: #d4a574; font-weight: bold; }
        .upload-box .hint { font-size: 0.8em; color: #888; margin-top: 10px; }
        
        #csvFile { display: none; }
        
        /* STATS */
        .stats {
            background: linear-gradient(135deg, #800020, #4a0000);
            padding: 20px; border-radius: 12px; margin-bottom: 20px;
            text-align: center; display: none;
        }
        .stats.show { display: block; }
        .stats .num { font-size: 2.5em; font-weight: bold; color: #ffd700; }
        .stats .lbl { font-size: 0.85em; color: #d4a574; }
        
        /* BUTTONS */
        .btns { display: none; gap: 10px; margin-bottom: 15px; }
        .btns.show { display: flex; }
        .btns button {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        .btn-show { background: #800020; color: white; }
        .btn-hide { background: #4a0000; color: white; }
        .btns button:hover { opacity: 0.9; transform: scale(1.02); }
        
        /* CATEGORY LIST */
        #catList {
            list-style: none;
            max-height: calc(100vh - 420px);
            overflow-y: auto;
            display: none;
        }
        #catList.show { display: block; }
        
        .cat-item {
            display: flex; align-items: center;
            padding: 10px 12px; margin: 5px 0;
            background: rgba(128,0,32,0.2);
            border-radius: 8px; cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        .cat-item:hover { background: rgba(128,0,32,0.35); }
        .cat-item.on { background: rgba(128,0,32,0.45); border-left-color: #ffd700; }
        .cat-item .dot { width: 18px; height: 18px; border-radius: 50%; margin-right: 12px; }
        .cat-item .info { flex: 1; }
        .cat-item .name { font-size: 0.9em; }
        .cat-item .count { font-size: 0.75em; color: #d4a574; }
        
        /* LOADING */
        #loader {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30,5,5,0.95);
            padding: 30px 50px; border-radius: 15px;
            color: #ffd700; font-size: 1.3em;
            z-index: 9999; border: 2px solid #800020;
            display: none;
        }
        #loader.show { display: block; }
    </style>
</head>
<body>

<div id="loader">Loading data...</div>

<div class="sidebar">
    <h1>üèõÔ∏è Riyadh Buildings <span class="version">v2.0 - NEW</span></h1>
    <h2>Upload CSV File to Map</h2>
    
    <!-- FILE UPLOAD -->
    <div class="upload-box" id="uploadBox">
        <div class="icon">üìÇ</div>
        <div class="text">Click here or drag CSV file</div>
        <div class="hint">Upload riyadh_osm_buildings.csv</div>
        <input type="file" id="csvFile" accept=".csv">
    </div>
    
    <!-- STATS -->
    <div class="stats" id="stats">
        <div class="num" id="totalNum">0</div>
        <div class="lbl">Buildings Loaded</div>
    </div>
    
    <!-- BUTTONS -->
    <div class="btns" id="btns">
        <button class="btn-show" onclick="showAllCats()">‚úì Show All</button>
        <button class="btn-hide" onclick="hideAllCats()">‚úó Hide All</button>
    </div>
    
    <!-- CATEGORIES -->
    <ul id="catList"></ul>
</div>

<div id="map"></div>

<script>
// === VERSION 2.0 - WITH FILE UPLOAD ===

// Category colors
const COLORS = {
    'Houses': '#800020',
    'Apartments': '#A52A2A',
    'Residential': '#800020',
    'Residential - Other': '#722F37',
    'Mosques': '#8B0000',
    'Places of Worship': '#960018',
    'Commercial Buildings': '#C41E3A',
    'Hotels': '#E32636',
    'Tourist Attractions': '#B22222',
    'Healthcare': '#DC143C',
    'Pharmacies': '#D70040',
    'Schools': '#9B111E',
    'Universities': '#702963',
    'Education': '#9B111E',
    'Government & Services': '#4A0000',
    'Restaurants & Cafes': '#CB4154',
    'Shops & Retail': '#B31B1B',
    'Supermarkets & Grocery': '#A45A52',
    'Fashion & Clothing': '#C08081',
    'Electronics': '#5C0120',
    'Automotive Shops': '#6B0F1A',
    'Banks & Finance': '#7B3F00',
    'Parks & Gardens': '#228B22',
    'Sports & Fitness': '#915F6D',
    'Entertainment': '#AA4A44',
    'Fuel & Car Services': '#8E354A',
    'Parking': '#6C3461',
    'Industrial': '#555555',
    'Other Buildings': '#666666',
    'Other': '#777777'
};

function getColor(cat) {
    if (COLORS[cat]) return COLORS[cat];
    let h = 0;
    for (let i = 0; i < cat.length; i++) h = cat.charCodeAt(i) + ((h << 5) - h);
    return `hsl(${Math.abs(h % 360)}, 65%, 45%)`;
}

// Map setup
const map = L.map('map', { center: [24.7136, 46.6753], zoom: 11, preferCanvas: true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '¬© OpenStreetMap ¬© CARTO', maxZoom: 19
}).addTo(map);

let layers = {};

// Upload box events
const uploadBox = document.getElementById('uploadBox');
const csvFile = document.getElementById('csvFile');

uploadBox.onclick = () => csvFile.click();

uploadBox.ondragover = (e) => { e.preventDefault(); uploadBox.classList.add('dragging'); };
uploadBox.ondragleave = () => uploadBox.classList.remove('dragging');
uploadBox.ondrop = (e) => {
    e.preventDefault();
    uploadBox.classList.remove('dragging');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
};

csvFile.onchange = (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); };

// Handle file
function handleFile(file) {
    document.getElementById('loader').classList.add('show');
    const reader = new FileReader();
    reader.onload = (e) => parseCSV(e.target.result);
    reader.readAsText(file);
}

// Parse CSV
function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
    
    const latI = headers.findIndex(h => h === 'latitude' || h === 'lat');
    const lonI = headers.findIndex(h => h === 'longitude' || h === 'lon' || h === 'lng');
    const nameI = headers.findIndex(h => h === 'name');
    const catI = headers.findIndex(h => h === 'category' || h === 'type');
    
    if (latI < 0 || lonI < 0) {
        alert('CSV needs latitude & longitude columns!');
        document.getElementById('loader').classList.remove('show');
        return;
    }
    
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const vals = parseRow(lines[i]);
        const lat = parseFloat(vals[latI]);
        const lon = parseFloat(vals[lonI]);
        if (!isNaN(lat) && !isNaN(lon)) {
            data.push({
                lat, lon,
                name: nameI >= 0 ? vals[nameI] : 'Unknown',
                category: catI >= 0 ? vals[catI] : 'Other'
            });
        }
    }
    
    loadData(data);
}

function parseRow(line) {
    const res = []; let cur = '', inQ = false;
    for (const c of line) {
        if (c === '"') inQ = !inQ;
        else if (c === ',' && !inQ) { res.push(cur.trim()); cur = ''; }
        else cur += c;
    }
    res.push(cur.trim());
    return res;
}

// Load data to map
function loadData(data) {
    // Clear old layers
    Object.values(layers).forEach(l => map.removeLayer(l));
    layers = {};
    
    // Group by category
    const groups = {};
    data.forEach(d => {
        if (!groups[d.category]) groups[d.category] = [];
        groups[d.category].push(d);
    });
    
    // Sort by count
    const sorted = Object.entries(groups).sort((a,b) => b[1].length - a[1].length);
    
    // Create layers
    sorted.forEach(([cat, items]) => {
        const color = getColor(cat);
        let pts = items;
        if (pts.length > 25000) {
            const step = Math.ceil(pts.length / 25000);
            pts = pts.filter((_, i) => i % step === 0);
        }
        
        const markers = pts.map(p => {
            const m = L.circleMarker([p.lat, p.lon], {
                radius: 4, fillColor: color, color: color,
                weight: 1, opacity: 0.8, fillOpacity: 0.6
            });
            m.bindPopup(`<b>${p.name}</b><br><span style="color:${color}">‚óè</span> ${cat}`);
            return m;
        });
        
        layers[cat] = L.layerGroup(markers).addTo(map);
    });
    
    // Update UI
    updateCatList(sorted);
    document.getElementById('totalNum').textContent = data.length.toLocaleString();
    document.getElementById('stats').classList.add('show');
    document.getElementById('btns').classList.add('show');
    document.getElementById('catList').classList.add('show');
    uploadBox.classList.add('success');
    uploadBox.querySelector('.text').textContent = '‚úì File loaded!';
    
    // Fit bounds
    if (data.length > 0) {
        const bounds = L.latLngBounds(data.slice(0, 10000).map(p => [p.lat, p.lon]));
        map.fitBounds(bounds, { padding: [50, 50] });
    }
    
    document.getElementById('loader').classList.remove('show');
}

// Update category list
function updateCatList(sorted) {
    const list = document.getElementById('catList');
    list.innerHTML = '';
    
    sorted.forEach(([cat, items]) => {
        const li = document.createElement('li');
        li.className = 'cat-item on';
        li.dataset.cat = cat;
        li.innerHTML = `
            <span class="dot" style="background:${getColor(cat)}"></span>
            <div class="info">
                <div class="name">${cat}</div>
                <div class="count">${items.length.toLocaleString()}</div>
            </div>
        `;
        li.onclick = () => toggleCat(li, cat);
        list.appendChild(li);
    });
}

function toggleCat(el, cat) {
    el.classList.toggle('on');
    if (el.classList.contains('on')) {
        map.addLayer(layers[cat]);
    } else {
        map.removeLayer(layers[cat]);
    }
}

function showAllCats() {
    document.querySelectorAll('.cat-item').forEach(el => {
        el.classList.add('on');
        const cat = el.dataset.cat;
        if (layers[cat] && !map.hasLayer(layers[cat])) map.addLayer(layers[cat]);
    });
}

function hideAllCats() {
    document.querySelectorAll('.cat-item').forEach(el => {
        el.classList.remove('on');
        const cat = el.dataset.cat;
        if (layers[cat]) map.removeLayer(layers[cat]);
    });
}
</script>

</body>
</html>
