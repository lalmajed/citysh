<!DOCTYPE html>
<html>
<head>
    <title>Riyadh Map - Load Your Files</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
        
        .panel {
            position: absolute; top: 10px; left: 60px;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); z-index: 1000;
            max-width: 400px; max-height: 90vh; overflow-y: auto; font-size: 13px;
        }
        .panel h2 { color: #1a73e8; margin-bottom: 10px; font-size: 16px; }
        
        .file-section { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .file-section label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 12px; }
        .file-section input[type="file"] { font-size: 11px; width: 100%; }
        .file-status { font-size: 11px; color: #666; margin-top: 5px; }
        .file-status.loaded { color: #34a853; }
        
        .stats { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .stat { background: #f5f5f5; padding: 10px; border-radius: 6px; text-align: center; flex: 1; min-width: 80px; }
        .stat b { display: block; font-size: 16px; }
        .stat small { color: #666; font-size: 10px; }
        
        .filters { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 10px; }
        .filters label { display: inline-flex; align-items: center; gap: 5px; cursor: pointer; font-size: 12px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 450; }
        
        .loading-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 10px; text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 2000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <canvas id="canvas"></canvas>
    
    <div class="panel">
        <h2>üèôÔ∏è Riyadh Map</h2>
        
        <div class="file-section">
            <label>üìä Land Use Data CSV:</label>
            <input type="file" id="dataFile" accept=".csv">
            <div id="dataStatus" class="file-status">No file loaded</div>
        </div>
        
        <div class="file-section" style="background: #e8f0fe;">
            <label>üé® Color By:</label>
            <select id="colorMode" style="width:100%; padding:5px; border-radius:4px; border:1px solid #ccc;">
                <option value="land_use">Land Use Code</option>
                <option value="district">District</option>
            </select>
        </div>
        
        <div id="stats" class="stats"></div>
        
        <div id="filters" class="filters"></div>
        
        <div style="margin-top:10px;font-size:11px;color:#888;">
            Showing: <span id="visible">0</span> points | Zoom: <span id="zoom">0</span>
        </div>
    </div>
    
    <div id="loadingMsg" class="loading-msg">
        <p>üìÇ Load your CSV file using the panel on the left</p>
        <p style="font-size:12px;color:#666;margin-top:10px;">Required: latitude, longitude, land_use_code<br>Optional: district (for district coloring)</p>
    </div>

    <script>
        let map, landUseData = {}, districtData = {}, currentMode = 'land_use';
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Define colors for known land use codes
        const landUseColors = {
            '1000': { color: '#34a853', name: 'Villas', emoji: 'üè†' },
            '1012': { color: '#4285f4', name: 'Apartments', emoji: 'üè¢' },
            '7510': { color: '#fbbc04', name: 'Vacant Land', emoji: 'üèûÔ∏è' },
            '2000': { color: '#ea4335', name: 'Commercial', emoji: 'üè™' },
            '4010': { color: '#9334e6', name: 'Government', emoji: 'üèõÔ∏è' }
        };
        
        // Generate color for unknown codes or districts
        function getColorForCode(code) {
            if (landUseColors[code]) {
                return landUseColors[code].color;
            }
            // Generate a consistent color based on code
            const numCode = parseInt(code) || 0;
            const hue = (numCode * 137) % 360;
            return `hsl(${hue}, 70%, 55%)`;
        }
        
        // Color mode change listener
        document.getElementById('colorMode').addEventListener('change', function(e) {
            currentMode = e.target.value;
            updateStatsAndFilters();
            render();
        });
        
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 24.7136, lng: 46.6753 },
                zoom: 11,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true
            });
            
            map.addListener('idle', render);
            window.addEventListener('resize', render);
        }
        
        // File loader for CSV with land_use_code
        document.getElementById('dataFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file extension
            if (!file.name.toLowerCase().endsWith('.csv')) {
                document.getElementById('dataStatus').textContent = '‚ùå Error: File must be a CSV';
                document.getElementById('dataStatus').className = 'file-status';
                return;
            }
            
            document.getElementById('dataStatus').textContent = 'Loading...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    
                    // Validate CSV content
                    if (!csvText || csvText.trim().length === 0) {
                        throw new Error('CSV file is empty');
                    }
                    
                    // Parse CSV
                    const lines = csvText.trim().split('\n');
                    if (lines.length === 0) {
                        throw new Error('No data in CSV file');
                    }
                    
                    // Parse header
                    const headers = lines[0].split(',').map(h => h.trim().replace(/^["']|["']$/g, '').toLowerCase());
                    
                    // Validate required columns
                    const latIndex = headers.findIndex(h => h === 'lat' || h === 'latitude');
                    const lngIndex = headers.findIndex(h => h === 'lng' || h === 'lon' || h === 'longitude');
                    const codeIndex = headers.findIndex(h => h === 'land_use_code' || h === 'landusecode' || h === 'code');
                    const districtIndex = headers.findIndex(h => h === 'district');
                    
                    if (latIndex === -1 || lngIndex === -1) {
                        throw new Error('CSV must contain latitude and longitude columns');
                    }
                    
                    if (codeIndex === -1) {
                        throw new Error('CSV must contain land_use_code column');
                    }
                    
                    // Parse data rows and group by land_use_code and district
                    landUseData = {};
                    districtData = {};
                    let totalCount = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(',').map(v => v.trim().replace(/^["']|["']$/g, ''));
                        const lat = parseFloat(values[latIndex]);
                        const lng = parseFloat(values[lngIndex]);
                        const code = values[codeIndex];
                        const district = districtIndex !== -1 ? values[districtIndex] : null;
                        
                        // Validate coordinates
                        if (isNaN(lat) || isNaN(lng)) {
                            console.warn(`Skipping row ${i+1}: invalid coordinates`);
                            continue;
                        }
                        
                        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                            console.warn(`Skipping row ${i+1}: coordinates out of range`);
                            continue;
                        }
                        
                        if (!code) {
                            console.warn(`Skipping row ${i+1}: missing land_use_code`);
                            continue;
                        }
                        
                        // Group by land_use_code
                        if (!landUseData[code]) {
                            landUseData[code] = [];
                        }
                        landUseData[code].push([lat, lng]);
                        
                        // Group by district (if available)
                        if (district) {
                            if (!districtData[district]) {
                                districtData[district] = [];
                            }
                            districtData[district].push([lat, lng]);
                        }
                        
                        totalCount++;
                    }
                    
                    if (totalCount === 0) {
                        throw new Error('No valid data points found in CSV');
                    }
                    
                    // Update UI
                    const landUseCount = Object.keys(landUseData).length;
                    const districtCount = Object.keys(districtData).length;
                    document.getElementById('dataStatus').textContent = `‚úÖ Loaded ${totalCount.toLocaleString()} points (${landUseCount} land uses, ${districtCount} districts)`;
                    document.getElementById('dataStatus').className = 'file-status loaded';
                    
                    // Generate stats and filters
                    updateStatsAndFilters();
                    checkReady();
                    render();
                } catch (err) {
                    document.getElementById('dataStatus').textContent = '‚ùå Error: ' + err.message;
                    document.getElementById('dataStatus').className = 'file-status';
                }
            };
            reader.readAsText(file);
        });
        
        function updateStatsAndFilters() {
            const statsDiv = document.getElementById('stats');
            const filtersDiv = document.getElementById('filters');
            
            statsDiv.innerHTML = '';
            filtersDiv.innerHTML = '';
            
            const dataSource = currentMode === 'land_use' ? landUseData : districtData;
            
            if (currentMode === 'land_use') {
                // Sort codes to show known ones first
                const codes = Object.keys(dataSource).sort((a, b) => {
                    const aKnown = landUseColors[a] ? 0 : 1;
                    const bKnown = landUseColors[b] ? 0 : 1;
                    if (aKnown !== bKnown) return aKnown - bKnown;
                    return dataSource[b].length - dataSource[a].length;
                });
                
                codes.forEach(code => {
                    const count = dataSource[code].length;
                    const color = getColorForCode(code);
                    const info = landUseColors[code];
                    const label = info ? `${info.emoji} ${info.name}` : `Code ${code}`;
                    
                    // Add stat
                    const statDiv = document.createElement('div');
                    statDiv.className = 'stat';
                    statDiv.style.borderLeft = `3px solid ${color}`;
                    statDiv.innerHTML = `
                        <b>${count.toLocaleString()}</b>
                        <small>${label}</small>
                    `;
                    statsDiv.appendChild(statDiv);
                    
                    // Add filter
                    const filterLabel = document.createElement('label');
                    filterLabel.innerHTML = `
                        <input type="checkbox" class="data-filter" data-code="${code}" checked>
                        <span class="dot" style="background:${color}"></span> ${label}
                    `;
                    filtersDiv.appendChild(filterLabel);
                });
            } else {
                // District mode - sort by count
                const districts = Object.keys(dataSource).sort((a, b) => {
                    return dataSource[b].length - dataSource[a].length;
                });
                
                districts.forEach(district => {
                    const count = dataSource[district].length;
                    const color = getColorForCode(district);
                    const label = `District ${district}`;
                    
                    // Add stat
                    const statDiv = document.createElement('div');
                    statDiv.className = 'stat';
                    statDiv.style.borderLeft = `3px solid ${color}`;
                    statDiv.innerHTML = `
                        <b>${count.toLocaleString()}</b>
                        <small>${label}</small>
                    `;
                    statsDiv.appendChild(statDiv);
                    
                    // Add filter
                    const filterLabel = document.createElement('label');
                    filterLabel.innerHTML = `
                        <input type="checkbox" class="data-filter" data-code="${district}" checked>
                        <span class="dot" style="background:${color}"></span> ${label}
                    `;
                    filtersDiv.appendChild(filterLabel);
                });
            }
            
            // Add event listeners to filters
            document.querySelectorAll('.data-filter').forEach(checkbox => {
                checkbox.addEventListener('change', render);
            });
        }
        
        function checkReady() {
            if (Object.keys(landUseData).length > 0 || Object.keys(districtData).length > 0) {
                document.getElementById('loadingMsg').style.display = 'none';
            }
        }
        
        function render() {
            if (!map) return;
            
            const bounds = map.getBounds();
            const proj = map.getProjection();
            if (!bounds || !proj) return;
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const zoom = map.getZoom();
            const ne = bounds.getNorthEast(), sw = bounds.getSouthWest();
            
            document.getElementById('zoom').textContent = zoom;
            
            // Sample rate - show fewer points when zoomed out
            let sample = 1;
            if (zoom <= 9) sample = 100;
            else if (zoom <= 10) sample = 50;
            else if (zoom <= 11) sample = 20;
            else if (zoom <= 12) sample = 10;
            else if (zoom <= 13) sample = 5;
            else if (zoom <= 14) sample = 2;
            
            const ps = Math.max(1, Math.min(zoom - 9, 5));
            let visible = 0;
            
            function toPixel(lat, lng) {
                const w = proj.fromLatLngToPoint(new google.maps.LatLng(lat, lng));
                const tr = proj.fromLatLngToPoint(ne);
                const bl = proj.fromLatLngToPoint(sw);
                const scale = Math.pow(2, zoom);
                return { x: (w.x - bl.x) * scale, y: (w.y - tr.y) * scale };
            }
            
            function inBounds(lat, lng) {
                return lat >= sw.lat() && lat <= ne.lat() && lng >= sw.lng() && lng <= ne.lng();
            }
            
            // Draw each category (land use or district)
            const dataSource = currentMode === 'land_use' ? landUseData : districtData;
            
            document.querySelectorAll('.data-filter').forEach(checkbox => {
                if (!checkbox.checked) return;
                
                const code = checkbox.dataset.code;
                const points = dataSource[code];
                if (!points || points.length === 0) return;
                
                const color = getColorForCode(code);
                ctx.fillStyle = colorWithAlpha(color, 0.7);
                
                for (let i = 0; i < points.length; i += sample) {
                    const [lat, lng] = points[i];
                    if (inBounds(lat, lng)) {
                        const p = toPixel(lat, lng);
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, ps, 0, Math.PI * 2);
                        ctx.fill();
                        visible++;
                    }
                }
            });
            
            document.getElementById('visible').textContent = visible.toLocaleString();
        }
        
        function colorWithAlpha(color, alpha) {
            if (color.startsWith('#')) {
                // Hex color
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            } else if (color.startsWith('hsl')) {
                // HSL color - convert to HSLA
                return color.replace('hsl', 'hsla').replace(')', `, ${alpha})`);
            }
            return color;
        }
    </script>
    <script src="https://somanchiu.github.io/Keyless-Google-Maps-API/mapsJavaScriptAPI.js" async defer></script>
</body>
</html>
